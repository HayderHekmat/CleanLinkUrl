<!DOCTYPE html>
<!-- Cache bust: 2024-01-15-15:30 -->
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Primary Meta Tags -->
  <title>LinkAura â€“ Free URL Cleaner | Remove Tracking Parameters | Privacy Tool</title>
  <meta name="title" content="LinkAura â€“ Free URL Cleaner | Remove Tracking Parameters | Privacy Tool" />
  <meta name="description" content="LinkAura removes tracking parameters (utm_*, fbclid, gclid) from URLs instantly. Free URL cleaner with unlimited local features: HTTPS/SSL checks, URL analysis, link expiration, social media detection, URL shortener detection, Geographic & CDN analysis, language detection, accessibility testing, cookie & tracking analysis, WHOIS check. Premium security: Safety API, SSL Certificate API, AI Website Security Scan. No ads, no tracking, privacy-first." />
  <meta name="keywords" content="URL cleaner, remove tracking parameters, utm_ remover, fbclid cleaner, gclid remover, privacy tool, URL sanitizer, link cleaner, free URL cleaner, unlimited local features, HTTPS SSL checker, URL analysis, link expiration detector, social media detection, URL shortener detector, geographic analysis, CDN detection, language detection, accessibility testing, WCAG compliance, cookie analysis, tracking analysis, cookie tracker, privacy analysis, cookie scanner, tracking scanner, cookie detector, website privacy checker, cookie privacy, tracking privacy, server location, hosting analysis, malware checker, SSL certificate validator, WHOIS check, domain verification, DNS records, name servers, SOA records, domain lookup, safety API, AI security scan, website security, threat detection, no ads, ad-free, privacy-first" />
  <meta name="author" content="LinkAura Team" />
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
  <meta name="googlebot" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
  <meta name="language" content="English" />
  <meta name="revisit-after" content="7 days" />
  <meta name="rating" content="General" />
  <meta name="distribution" content="Global" />
  <meta name="geo.region" content="US" />
  <meta name="geo.placename" content="Global" />
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/png" sizes="512x512" href="assets/images/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="canonical" href="https://linkaura.blankburn.online/" />
  <meta name="theme-color" content="#193ce6" />
  <meta name="msapplication-TileColor" content="#193ce6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="LinkAura" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://linkaura.blankburn.online/" />
  <meta property="og:title" content="LinkAura â€“ Free URL Cleaner | Privacy-Friendly Tool" />
  <meta property="og:description" content="LinkAura removes tracking parameters (utm_*, fbclid, gclid) from URLs instantly. Free URL cleaner with unlimited local features: HTTPS/SSL checks, URL analysis, link expiration, social media detection, URL shortener detection, Geographic & CDN analysis, language detection, accessibility testing, cookie & tracking analysis, WHOIS check. Premium security: Safety API, SSL Certificate API, AI Website Security Scan. No ads, no tracking, privacy-first." />
  <meta property="og:image" content="https://linkaura.blankburn.online/images/cleanlink-icon.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="LinkAura - Free URL Cleaner and Privacy Tool" />
  <meta property="og:site_name" content="LinkAura" />
  <meta property="og:locale" content="en_US" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://linkaura.blankburn.online/" />
  <meta name="twitter:title" content="LinkAura â€“ Free URL Cleaner | Privacy-Friendly Tool" />
  <meta name="twitter:description" content="LinkAura removes tracking parameters (utm_*, fbclid, gclid) from URLs instantly. Free URL cleaner with unlimited local features: HTTPS/SSL checks, URL analysis, link expiration, social media detection, URL shortener detection, Geographic & CDN analysis, language detection, accessibility testing, cookie & tracking analysis, WHOIS check. Premium security: Safety API, SSL Certificate API, AI Website Security Scan. No ads, no tracking, privacy-first." />
  <meta name="twitter:image" content="https://linkaura.blankburn.online/images/cleanlink-icon.png" />
  <meta name="twitter:image:alt" content="LinkAura - Free URL Cleaner and Privacy Tool" />
  
  <!-- Performance: Preconnect to external domains -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdn.tailwindcss.com" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
  <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

  <!-- Structured Data: SoftwareApplication -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "LinkAura",
    "alternateName": "LinkAura URL Cleaner",
    "url": "https://linkaura.blankburn.online",
    "description": "A privacy-friendly URL cleaner that removes tracking parameters with unlimited free features: HTTPS/SSL checks, URL analysis, link expiration, social media detection, URL shortener detection, Geographic & CDN analysis, language detection, accessibility testing, cookie & tracking analysis, WHOIS check. Premium security features: Safety API, SSL Certificate API, AI Website Security Scan. No ads, no tracking, privacy-first.",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web Browser",
    "browserRequirements": "Requires JavaScript. Requires HTML5.",
    "softwareVersion": "2.0",
    "datePublished": "2024-01-01",
    "dateModified": "2024-12-29",
    "inLanguage": "en-US",
    "license": "https://linkaura.blankburn.online",
    "author": {
      "@type": "Organization",
      "name": "LinkAura Team",
      "url": "https://linkaura.blankburn.online"
    },
    "publisher": {
      "@type": "Organization",
      "name": "LinkAura Team",
      "url": "https://linkaura.blankburn.online",
      "logo": {
        "@type": "ImageObject",
        "url": "https://linkaura.blankburn.online/images/cleanlink-icon.png"
      }
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "EUR",
      "availability": "https://schema.org/InStock",
      "priceValidUntil": "2025-12-31"
    },
    "featureList": [
      "Remove tracking parameters (utm_*, fbclid, gclid) - FREE",
      "HTTPS and SSL certificate validation - FREE",
      "URL structure analysis - FREE",
      "Link expiration detection - FREE",
      "Social media platform detection - FREE",
      "URL validation and repair - FREE",
      "URL shortener detection and expansion - FREE",
      "Geographic & CDN analysis with interactive maps - FREE",
      "Language detection and analysis - FREE",
      "Accessibility compliance testing - FREE",
      "Cookie & tracking analysis - FREE",
      "WHOIS check and domain verification - FREE",
      "QR code generation - FREE",
      "URL history management - FREE",
      "Statistics dashboard - FREE",
      "Bulk URL processing - FREE",
      "Safety API for threat detection - PREMIUM",
      "SSL Certificate API for security analysis - PREMIUM",
      "AI Website Security Scan - PREMIUM",
      "Privacy-first design with no ads or tracking"
    ],
    "screenshot": "https://linkaura.blankburn.online/images/cleanlink-icon.png",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "ratingCount": "150",
      "bestRating": "5",
      "worstRating": "1"
    }
  }
  </script>

  <!-- Structured Data: Website -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "LinkAura",
    "url": "https://linkaura.blankburn.online",
    "description": "Free URL cleaner and privacy tool that removes tracking parameters from URLs instantly",
    "inLanguage": "en-US",
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "https://linkaura.blankburn.online/?q={search_term_string}"
      },
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <!-- Structured Data: Organization -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "LinkAura",
    "url": "https://linkaura.blankburn.online",
    "logo": "https://linkaura.blankburn.online/images/cleanlink-icon.png",
    "sameAs": [],
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "Customer Support",
      "availableLanguage": ["English"]
    }
  }
  </script>

  <!-- Structured Data: FAQPage -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "What is LinkAura?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "LinkAura is a free, privacy-first URL cleaner that removes tracking parameters (like utm_, fbclid, gclid) from URLs instantly. It runs entirely in your browser for maximum privacy and security."
        }
      },
      {
        "@type": "Question",
        "name": "Is LinkAura free to use?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes! All local features are completely free and unlimited. This includes URL cleaning, HTTPS/SSL checks, URL analysis, link expiration detection, social media detection, URL shortener detection, geographic analysis, language detection, accessibility testing, and cookie & tracking analysis. Premium API features (Safety API, SSL Certificate API, AI Website Security Scan) are available with a free daily limit."
        }
      },
      {
        "@type": "Question",
        "name": "Does LinkAura track or store my data?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "No! LinkAura is privacy-first. All processing happens locally in your browser. Your URLs are never sent to any server except when you explicitly use premium API features. There are no ads, no tracking, and your data stays private."
        }
      },
      {
        "@type": "Question",
        "name": "What tracking parameters does LinkAura remove?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "LinkAura removes common tracking parameters like utm_source, utm_medium, utm_campaign, utm_term, utm_content, fbclid (Facebook), gclid (Google), and many others. You can also choose which parameters to preserve."
        }
      },
      {
        "@type": "Question",
        "name": "What is WHOIS Check?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "WHOIS Check is a free feature that verifies domain information via DNS records. It retrieves name servers, SOA (Start of Authority) records, and admin contact information for any domain or subdomain. This helps you verify domain ownership, check DNS configuration, and understand domain infrastructure. The feature works even when full WHOIS registration data is unavailable by using DNS lookups."
        }
      },
      {
        "@type": "Question",
        "name": "What is Cookie & Tracking Analysis?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Cookie & Tracking Analysis is a free feature that analyzes websites to detect cookies, tracking scripts, and tracking pixels. It provides a privacy score, identifies tracking technologies (like Google Analytics, Facebook Pixel, etc.), and offers recommendations to improve privacy. You can use this feature to understand a website's privacy implications before visiting."
        }
      }
    ]
  }
  </script>

  <script>
    if (localStorage.getItem("theme") === "light") {
      document.documentElement.classList.remove("dark");
    }
  </script>  

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: { primary: "#193ce6", "background-dark": "#111421" },
          fontFamily: { display: ["Inter", "sans-serif"] },
        }
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

  <style>
    .focus-soft:focus { outline:none; box-shadow:0 0 0 4px rgba(59,130,246,.25); }
    #qrcode canvas { border-radius:0.75rem; width:100%; height:auto; }
    #globalCounter { transition: transform 0.3s ease; }
  </style>
</head>

<body class="bg-white dark:bg-background-dark text-slate-900 dark:text-slate-100 font-display transition-colors duration-300">

<header class="w-full border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark transition-colors duration-300">
  <nav class="container mx-auto px-6 flex items-center justify-between py-4 md:py-5">
    <div class="flex items-center gap-3">
      <img src="assets/images/cleanlink-icon.png" alt="LinkAura Logo"
           class="h-10 md:h-12 w-auto object-contain drop-shadow-[0_0_8px_rgba(25,60,230,0.6)] rounded-lg"
           draggable="false"/>

      <div class="flex flex-col leading-tight">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight transition-colors">LinkAura</span>
          <span id="donorBadge"
                class="hidden text-green-400 flex items-center gap-1 text-[13px] font-medium">
            <span class="material-symbols-outlined text-yellow-400 text-base">workspace_premium</span>
            Supporter
          </span>
        </div>
        <span class="text-xs text-slate-500 dark:text-slate-500 mt-0.5 transition-colors">
          Sponsored by
          <a href="https://www.calm.com" target="_blank" class="text-sky-500 dark:text-sky-400 font-medium hover:underline hover:text-sky-400 dark:hover:text-sky-300 transition">
            Calm
          </a>
        </span>
      </div>
    </div>

    <div class="hidden md:flex items-center gap-6 text-slate-600 dark:text-slate-300 text-sm">
      <a href="#how" class="hover:text-slate-900 dark:hover:text-white transition-colors">Features</a>
      <a href="#support" class="hover:text-slate-900 dark:hover:text-white transition-colors">Support & Limits</a>
      <a href="#privacy" class="hover:text-slate-900 dark:hover:text-white transition-colors">Privacy</a>

      <span id="privacyBadge" class="hidden text-xs text-slate-600 dark:text-slate-400 transition-colors">
        ðŸ”’ Privacy Mode Active
      </span>

      <button id="themeToggle" class="ml-2 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white flex items-center gap-1 transition-colors">
        <span class="material-symbols-outlined text-base">light_mode</span>
      </button>
    </div>
  </nav>
</header>
          
  <main class="flex-grow">
    <section class="py-20 text-center px-6 relative overflow-hidden transition-colors duration-300">
      <div class="absolute -top-32 -left-32 w-64 h-64 bg-primary/20 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-32 -right-32 w-64 h-64 bg-primary/30 rounded-full blur-3xl"></div>

      <h1 id="scrambleText" class="text-4xl sm:text-5xl lg:text-6xl font-black text-slate-900 dark:text-white leading-tight tracking-tight transition-colors">
        A privacy-first tool that declutters your links.
      </h1>

      <p class="mt-6 max-w-2xl mx-auto text-slate-600 dark:text-slate-400 text-lg transition-colors">
        Clean, readable URLs with no trackers â€” everything runs locally in your browser for maximum privacy and speed. 
        <span class="text-sm text-slate-500 dark:text-slate-500 block mt-2">
          âœ¨ All local features are unlimited and free â€¢ No ads, no tracking â€¢ Privacy-safe global counter
        </span>
      </p>

      <!-- Feature Cards -->
      <div class="mt-12 max-w-4xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800 transition-colors">
            <h2 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
              <span class="material-symbols-outlined text-blue-500 text-sm">security</span>
              Security Checks
            </h2>
            <p class="text-xs text-slate-600 dark:text-slate-400">
              HTTPS check, SSL validation, URL analysis, link expiration, social media detection, URL validation & repair, cookie & tracking analysis, plus premium Safety API, SSL Certificate API, and AI Website Security Scan
            </p>
          </div>

          <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800 transition-colors">
            <h2 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
              <span class="material-symbols-outlined text-purple-500 text-sm">format_list_bulleted</span>
              Bulk Processing
            </h4>
            <p class="text-xs text-slate-600 dark:text-slate-400">
              Clean multiple URLs at once, perfect for link lists and batch operations
            </p>
          </div>

          <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800 transition-colors">
            <h2 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-sm">tune</span>
              Smart Parameters
            </h4>
            <p class="text-xs text-slate-600 dark:text-slate-400">
              Choose which tracking parameters to preserve, create custom filters
            </p>
          </div>
        </div>
      </div>






      <!-- Main Form Section -->
      <div id="mainFormSection" class="mt-12 max-w-3xl mx-auto bg-white dark:bg-slate-900/40 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-lg transition-colors duration-300">
        <!-- Mode Toggle -->
        <div class="flex justify-center mb-6">
          <div class="inline-flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
            <button id="singleModeBtn" class="flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm">
              <span class="material-symbols-outlined text-base">link</span>
              Single URL
            </button>
            <button id="bulkModeBtn" class="flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-colors text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
              <span class="material-symbols-outlined text-base">format_list_bulleted</span>
              Bulk URLs
            </button>
          </div>
        </div>

        <!-- Single URL Mode -->
        <div id="singleMode" class="relative">
          <span class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 transition-colors">link</span>
          <input id="urlInput" type="url" placeholder="Paste your URL here..."
            class="w-full bg-slate-50 dark:bg-slate-900/70 border border-slate-300 dark:border-slate-700 rounded-xl py-4 pl-14 pr-32 text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-lg" />
          <div class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col items-end gap-2.5 -mt-10">
            <label class="flex items-center gap-2 text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer transition-all hover:text-slate-900 dark:hover:text-white whitespace-nowrap px-2 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-800/50">
              <input id="privacyMode" type="checkbox" class="rounded border-slate-400 dark:border-slate-500 w-4 h-4 text-primary focus:ring-2 focus:ring-primary/30 cursor-pointer">
              <span class="select-none">Privacy Mode</span>
            </label>
            <button id="cleanBtn"
              class="bg-gradient-to-r from-primary to-indigo-500 text-white font-semibold px-5 py-2 rounded-lg hover:opacity-90 flex items-center gap-1 shadow-sm">
              <span id="cleanBtnText">Clean</span>
              <span class="material-symbols-outlined text-sm">arrow_forward</span>
            </button>
          </div>
        </div>

        <!-- Bulk URL Mode -->
        <div id="bulkMode" class="hidden">
          <div class="relative">
            <span class="material-symbols-outlined absolute left-5 top-5 text-slate-400 dark:text-slate-500 transition-colors">format_list_bulleted</span>
            <textarea id="bulkInput" placeholder="Paste multiple URLs here (one per line)..."
              class="w-full bg-slate-50 dark:bg-slate-900/70 border border-slate-300 dark:border-slate-700 rounded-xl py-4 pl-14 pr-36 text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-lg min-h-[120px] resize-y"
            ></textarea>
            <button id="bulkCleanBtn"
              class="absolute right-4 top-4 bg-gradient-to-r from-primary to-indigo-500 text-white font-semibold px-5 py-2 rounded-lg hover:opacity-90">
              Clean All
            </button>
          </div>
          <div class="flex items-center justify-center gap-2 mt-3 text-xs text-slate-600 dark:text-slate-400">
            <span id="bulkCount">0 URLs to clean</span>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between flex-wrap gap-2">
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="removeAll" type="checkbox" class="rounded border-slate-600">
            <span>Remove all parameters</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="httpsCheck" type="checkbox" class="rounded border-slate-600">
            <span>Check HTTPS</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="sslCheck" type="checkbox" class="rounded border-slate-600">
            <span>SSL Basic Check</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="urlAnalysisCheck" type="checkbox" class="rounded border-slate-600">
            <span>URL Analysis</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="linkExpirationCheck" type="checkbox" class="rounded border-slate-600">
            <span>Link Expiration Check</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="socialDetectionCheck" type="checkbox" class="rounded border-slate-600">
            <span>Social Media Detection</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="geographicAnalysisCheck" type="checkbox" class="rounded border-slate-600">
            <span>Geographic & CDN Analysis</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="urlValidationCheck" type="checkbox" class="rounded border-slate-600">
            <span>URL Validation & Repair</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="shortenerDetectionCheck" type="checkbox" class="rounded border-slate-600">
            <span>Shortened URL Detection & Expansion</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="languageDetectionCheck" type="checkbox" class="rounded border-slate-600">
            <span>Language Detection</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="accessibilityAnalysisCheck" type="checkbox" class="rounded border-slate-600">
            <span>Accessibility Analysis</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="cookieTrackingAnalysisCheck" type="checkbox" class="rounded border-slate-600">
            <span>Cookie & Tracking Analysis</span>
          </label>
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="whoisCheckCheck" type="checkbox" class="rounded border-slate-600">
            <span>WHOIS Check</span>
          </label>
          
          <!-- History Button -->
          <button id="historyToggleBtn" class="hidden w-full bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg px-4 py-3 text-sm text-blue-700 dark:text-blue-300 transition-colors flex items-center justify-center gap-2 mt-2">
            <span class="material-symbols-outlined text-base">history</span>
            <span>View URL History</span>
          </button>
          
          <!-- Premium API Features -->
          <div class="w-full border-t border-slate-300 dark:border-slate-700 my-2"></div>
          
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="safetyApiCheck" type="checkbox" class="rounded border-slate-600">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-amber-500 text-base">workspace_premium</span>
              Safety API 
            </span>
          </label>
        
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="sslApiCheck" type="checkbox" class="rounded border-slate-600">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-amber-500 text-base">workspace_premium</span>
              SSL Certificate API 
            </span>
          </label>
          
          <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer transition-colors">
            <input id="webSecScanCheck" type="checkbox" class="rounded border-slate-600">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-amber-500 text-base">workspace_premium</span>
              Website Security Scan 
            </span>
          </label>

          <!-- Custom Parameters Dropdown -->
          <div class="relative z-50">
            <button id="preserveDropdownBtn"
              class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-700 dark:text-slate-400 w-56 text-left focus:ring-2 focus:ring-primary/30 flex items-center justify-between transition-colors">
              <span id="preserveDropdownText">Preserve parameters</span>
              <span class="material-symbols-outlined text-base">expand_more</span>
            </button>

            <div id="preserveDropdownMenu"
              class="fixed w-56 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg shadow-lg z-[9999] hidden">
              <div class="p-3 space-y-2 max-h-48 overflow-y-auto">
                <!-- Common tracking parameters -->
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="utm_source" class="rounded border-slate-600 preserve-param">
                  <span>utm_source</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="utm_medium" class="rounded border-slate-600 preserve-param">
                  <span>utm_medium</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="utm_campaign" class="rounded border-slate-600 preserve-param">
                  <span>utm_campaign</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="utm_term" class="rounded border-slate-600 preserve-param">
                  <span>utm_term</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="utm_content" class="rounded border-slate-600 preserve-param">
                  <span>utm_content</span>
                </label>

                <hr class="border-slate-200 dark:border-slate-700 my-2">

                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="fbclid" class="rounded border-slate-600 preserve-param">
                  <span>fbclid</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="gclid" class="rounded border-slate-600 preserve-param">
                  <span>gclid</span>
                </label>

                <hr class="border-slate-200 dark:border-slate-700 my-2">

                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="ref" class="rounded border-slate-600 preserve-param">
                  <span>ref</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="aff_id" class="rounded border-slate-600 preserve-param">
                  <span>aff_id</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="affiliate" class="rounded border-slate-600 preserve-param">
                  <span>affiliate</span>
                </label>
                <label class="flex items-center gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer">
                  <input type="checkbox" value="partner" class="rounded border-slate-600 preserve-param">
                  <span>partner</span>
                </label>

                <!-- Custom parameter input -->
                <hr class="border-slate-200 dark:border-slate-700 my-2">
                <input id="customParamInput" placeholder="+ Add custom..."
                  class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-2 py-1 text-sm text-slate-700 dark:text-slate-400 w-full focus:ring-1 focus:ring-primary/30 placeholder:text-slate-400 dark:placeholder:text-slate-500 transition-colors" />
                <button id="addCustomParamBtn"
                  class="text-xs text-sky-600 dark:text-sky-400 hover:text-sky-800 dark:hover:text-sky-300 mt-1">
                  Add parameter
                </button>
              </div>
            </div>
          </div>
        </div>
        <p id="usageCounter" class="mt-3 text-xs text-slate-600 dark:text-slate-500 text-center transition-colors">0/3 API calls today (Free Plan)</p>
        <p class="mt-1 text-xs text-green-600 dark:text-green-400 text-center transition-colors">âœ¨ Local features unlimited</p>
        <div id="supporterBadge" class="hidden mt-2 text-center">
          <span id="supporterTier" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium"></span>
        </div>
      </div>

      <div id="resultWrap" class="hidden mt-10 max-w-3xl mx-auto bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 transition-colors duration-300">
        <!-- Single URL Results -->
        <div id="singleResults">
          <p class="text-slate-600 dark:text-slate-400 text-sm mb-2 transition-colors">Clean URL</p>
          <div id="resultUrl" class="bg-slate-100 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 font-mono text-slate-900 dark:text-slate-100 break-all transition-colors"></div>
        </div>

        <!-- Bulk URL Results -->
        <div id="bulkResults" class="hidden">
          <div class="flex items-center justify-between mb-3">
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Clean URLs <span id="bulkResultsCount" class="font-semibold"></span></p>
            <button id="bulkCopyAllBtn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-1 text-xs text-slate-900 dark:text-white transition-colors">Copy All</button>
          </div>
          <div id="bulkResultList" class="bg-slate-100 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 font-mono text-slate-900 dark:text-slate-100 max-h-96 overflow-y-auto space-y-2"></div>
        </div>

        <div id="httpsStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="httpsIcon" class="material-symbols-outlined text-base"></span>
          <span id="httpsText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="sslStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="sslIcon" class="material-symbols-outlined text-base"></span>
          <span id="sslText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="sslApiStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="sslApiIcon" class="material-symbols-outlined text-base"></span>
          <span id="sslApiText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="domainAgeStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="domainAgeIcon" class="material-symbols-outlined text-base"></span>
          <span id="domainAgeText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="malwareStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="malwareIcon" class="material-symbols-outlined text-base"></span>
          <span id="malwareText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="safetyApiStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="safetyApiIcon" class="material-symbols-outlined text-base"></span>
          <span id="safetyApiText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="urlAnalysisStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="urlAnalysisIcon" class="material-symbols-outlined text-base"></span>
          <span id="urlAnalysisText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="linkExpirationStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="linkExpirationIcon" class="material-symbols-outlined text-base"></span>
          <span id="linkExpirationText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="shortenerApiStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="shortenerApiIcon" class="material-symbols-outlined text-base"></span>
          <span id="shortenerApiText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="geographicApiStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="geographicApiIcon" class="material-symbols-outlined text-base"></span>
          <span id="geographicApiText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="languageDetectionStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
          <span id="languageDetectionIcon" class="material-symbols-outlined text-base"></span>
          <span id="languageDetectionText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <div id="accessibilityAnalysisStatus" class="hidden mt-3">
          <div class="flex items-center gap-2 text-sm mb-2">
            <span id="accessibilityAnalysisIcon" class="material-symbols-outlined text-base"></span>
            <span id="accessibilityAnalysisText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
          </div>
          <div id="accessibilityAnalysisDetails" class="hidden bg-slate-50 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm">
            <div id="accessibilityScoreInfo" class="mb-2"></div>
            <div id="accessibilityIssuesInfo"></div>
          </div>
        </div>

        <div id="cookieTrackingAnalysisStatus" class="hidden mt-3">
          <div class="flex items-center gap-2 text-sm mb-2">
            <span id="cookieTrackingAnalysisIcon" class="material-symbols-outlined text-base"></span>
            <span id="cookieTrackingAnalysisText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
          </div>
          <div id="cookieTrackingAnalysisDetails" class="hidden bg-slate-50 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm">
            <div id="cookieTrackingSummary" class="mb-3"></div>
            <div id="cookieTrackingCookies" class="mb-3"></div>
            <div id="cookieTrackingScripts" class="mb-3"></div>
            <div id="cookieTrackingPixels" class="mb-3"></div>
            <div id="cookieTrackingRecommendations"></div>
          </div>
        </div>

        <div id="whoisCheckStatus" class="hidden mt-3">
          <div class="flex items-center gap-2 text-sm mb-2">
            <span id="whoisCheckIcon" class="material-symbols-outlined text-base"></span>
            <span id="whoisCheckText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
          </div>
          <div id="whoisCheckDetails" class="hidden bg-slate-50 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm">
            <div id="whoisSummary" class="mb-3"></div>
            <div id="whoisDomainInfo" class="mb-3"></div>
            <div id="whoisContacts" class="mb-3"></div>
            <div id="whoisServers"></div>
          </div>
        </div>

        <div id="geographicAnalysisStatus" class="hidden mt-3">
          <div class="flex items-center gap-2 text-sm mb-2">
            <span id="geographicAnalysisIcon" class="material-symbols-outlined text-base"></span>
            <span id="geographicAnalysisText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
          </div>
          <div id="geographicAnalysisDetails" class="hidden bg-slate-50 dark:bg-slate-800/60 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm">
            <div id="serverLocationInfo" class="mb-2"></div>
            <div id="cdnInfo" class="mb-2"></div>
            <div id="mapContainer" class="hidden mt-3">
              <div id="map" class="w-full h-48 bg-slate-200 dark:bg-slate-700 rounded-lg flex items-center justify-center text-slate-500 dark:text-slate-400">
                <span>Map loading...</span>
              </div>
            </div>
          </div>
        </div>

        <div id="shortenerWarningStatus" class="hidden mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
          <div class="flex items-start gap-2">
            <span id="shortenerWarningIcon" class="material-symbols-outlined text-base text-yellow-600 dark:text-yellow-400 mt-0.5"></span>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span id="shortenerWarningText" class="text-yellow-800 dark:text-yellow-200 font-medium text-sm"></span>
              </div>
              <div class="flex items-center gap-2">
                <button id="expandShortenedUrlBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-1 rounded-md transition-colors">
                  <span class="material-symbols-outlined text-sm mr-1">open_in_new</span>
                  Expand URL
                </button>
                <span id="shortenerOriginalUrl" class="text-yellow-700 dark:text-yellow-300 text-xs font-mono break-all"></span>
              </div>
            </div>
          </div>
        </div>

            <div id="socialDetectionStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
              <span id="socialDetectionIcon" class="material-symbols-outlined text-base"></span>
              <span id="socialDetectionText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
            </div>
            <div id="urlValidationStatus" class="hidden mt-3 flex items-center gap-2 text-sm">
              <span id="urlValidationIcon" class="material-symbols-outlined text-base"></span>
              <span id="urlValidationText" class="text-slate-700 dark:text-slate-300 transition-colors"></span>
        </div>

        <!-- Loading/Progress Indicator -->
        <div id="analysisProgress" class="hidden mt-4 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-xl p-4 transition-all">
          <div class="flex items-center gap-3 mb-2">
            <div class="animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"></div>
            <span class="text-slate-700 dark:text-slate-300 font-medium">
              Deep Analysis in Progress
            </span>
          </div>
          <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
            <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-1000 ease-out" style="width: 30%"></div>
          </div>
          <p class="text-xs text-slate-600 dark:text-slate-400 mt-2 flex items-center gap-2">
            <span class="material-symbols-outlined text-base">security_scanner</span>
            <span id="progressText">Scanning for threats and security vulnerabilities...</span>
          </p>
        </div>
        <div class="flex gap-3 mt-4">
          <button id="copyBtn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white transition-colors">Copy</button>
          <button id="openBtn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white transition-colors">Open</button>
          <button id="shareBtn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white transition-colors">Share</button>
        </div>

        <div id="historyWrap" class="hidden mt-6 bg-slate-100 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-800 rounded-xl p-5 text-left transition-colors duration-300" data-history-hidden="true">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-slate-700 dark:text-slate-300 font-semibold flex items-center gap-1 transition-colors">
              <span class="material-symbols-outlined text-base">history</span>
              URL History
            </h3>
            <div class="flex gap-2">
              <button id="clearHistoryBtn"
                class="bg-slate-200 hover:bg-slate-300 dark:bg-white/10 dark:hover:bg-white/20 text-slate-900 dark:text-white text-xs px-3 py-1 rounded-md transition-colors">
                Clear
              </button>
              <button id="exportHistoryBtn"
                class="bg-slate-200 hover:bg-slate-300 dark:bg-white/10 dark:hover:bg-white/20 text-slate-900 dark:text-white text-xs px-3 py-1 rounded-md transition-colors">
                Export
              </button>
              <button id="showStatsBtn"
                class="bg-blue-200 hover:bg-blue-300 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-900 dark:text-blue-200 text-xs px-3 py-1 rounded-md transition-colors">
                ðŸ“Š Statistics
              </button>
            </div>
          </div>

          <!-- Selection Actions (hidden by default) -->
          <div id="selectionActions" class="hidden mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm text-blue-700 dark:text-blue-300">
                  <span id="selectedCount">0</span> URL(s) selected
                </span>
              </div>
              <div class="flex gap-2">
                <button id="generateQRBtn" class="bg-green-200 hover:bg-green-300 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-800 dark:text-green-200 text-xs px-3 py-1 rounded-md transition-colors flex items-center gap-1">
                  <span class="material-symbols-outlined text-sm">qr_code</span>
                  Generate QR
                </button>
                <button id="recleanBtn" class="bg-orange-200 hover:bg-orange-300 dark:bg-orange-900/30 dark:hover:bg-orange-900/50 text-orange-800 dark:text-orange-200 text-xs px-3 py-1 rounded-md transition-colors flex items-center gap-1">
                  <span class="material-symbols-outlined text-sm">refresh</span>
                  Re-clean
                </button>
                <button id="clearSelectionBtn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-xs px-3 py-1 rounded-md transition-colors">
                  Clear Selection
                </button>
              </div>
            </div>
          </div>

          <!-- Search and Filter Controls -->
          <div class="mb-4 space-y-3">
            <!-- Search Bar -->
            <div class="relative">
              <input type="text" id="historySearch" placeholder="Search URLs, domains, or keywords..." 
                class="w-full px-4 py-2 pl-10 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
              <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
            </div>

            <!-- Filter Controls -->
            <div class="flex flex-wrap gap-2">
              <!-- Date Filter -->
              <select id="dateFilter" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
              </select>

              <!-- Domain Filter -->
              <select id="domainFilter" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                <option value="all">All Domains</option>
              </select>

              <!-- Type Filter -->
              <select id="typeFilter" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                <option value="all">All Types</option>
                <option value="social">Social Media</option>
                <option value="shortener">URL Shorteners</option>
                <option value="ecommerce">E-commerce</option>
                <option value="news">News & Media</option>
                <option value="other">Other</option>
              </select>

              <!-- Sort Options -->
              <select id="sortFilter" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="domain">Domain A-Z</option>
                <option value="domain-desc">Domain Z-A</option>
                <option value="security">Security Score</option>
              </select>

              <!-- Clear Filters -->
              <button id="clearFiltersBtn" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-sm rounded-lg transition-colors">
                Clear Filters
              </button>
            </div>

            <!-- Custom Date Range (hidden by default) -->
            <div id="customDateRange" class="hidden flex gap-2">
              <input type="date" id="startDate" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
              <span class="text-slate-500 dark:text-slate-400 self-center">to</span>
              <input type="date" id="endDate" class="px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
            </div>
          </div>

          <!-- Results Count -->
          <div id="resultsCount" class="text-sm text-slate-500 dark:text-slate-400 mb-3"></div>

          <!-- History List -->
          <ul id="historyList" class="text-slate-600 dark:text-slate-400 text-sm space-y-2 transition-colors"></ul>

          <!-- Pagination -->
          <div id="pagination" class="mt-4 flex justify-center items-center gap-2"></div>
        </div>

        <div id="qrWrap" class="hidden mt-6 flex flex-col items-center">
          <div class="text-sm text-slate-600 dark:text-slate-400 mb-2 transition-colors">QR Code</div>
          <div id="qrcode" class="bg-white p-3 rounded-xl"></div>
          <button id="downloadQRBtn" class="mt-3 bg-slate-200 hover:bg-slate-300 dark:bg-white/10 dark:hover:bg-white/20 text-slate-900 dark:text-white px-4 py-2 rounded-lg text-sm transition-colors">Download PNG</button>
        </div>
      </div>
      <p id="error" class="hidden mt-4 text-sm text-red-500 dark:text-red-400 transition-colors"></p>
    </section>

    <!-- How to Use Section -->
    <section class="py-20 bg-white dark:bg-slate-900/40 border-t border-slate-200 dark:border-slate-800 transition-colors duration-300">
      <div class="container mx-auto px-6">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold text-center text-slate-900 dark:text-white mb-8 transition-colors">How to Use LinkAura</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- Basic Usage -->
            <div class="bg-slate-50 dark:bg-slate-900/40 rounded-xl p-6 border border-slate-200 dark:border-slate-800 transition-colors">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-500">check_circle</span>
                Basic URL Cleaning
              </h3>
              <div class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                <p>1. <strong>Paste any URL</strong> in the input field</p>
                <p>2. <strong>Click Clean</strong> to remove tracking parameters</p>
                <p>3. <strong>Copy or share</strong> your clean link instantly</p>
                <p>4. <strong>Optional:</strong> Enable local checks (HTTPS, SSL, URL analysis, etc.) - <strong>unlimited and free</strong></p>
                <p>5. <strong>Optional:</strong> Enable URL shortener detection to reveal true destinations - <strong>free with API</strong></p>
                <p>6. <strong>Optional:</strong> Use premium API features (donors only) for advanced security checks</p>
                <div class="mt-3 p-2 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800">
                  <p class="text-xs text-green-800 dark:text-green-200">
                    <strong>ðŸ’¡ Free Forever:</strong> All local features (URL cleaning, HTTPS check, SSL check, URL analysis, link expiration, social media detection, QR codes, history) are unlimited and completely free!
                  </p>
                </div>
              </div>
            </div>

            <!-- Premium Features -->
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/20 dark:to-orange-950/20 rounded-xl p-6 border border-amber-200 dark:border-amber-800 transition-colors">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-amber-600 dark:text-amber-400">workspace_premium</span>
                Premium API Features
              </h3>
              <div class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                <p><strong>ðŸ”’ How to unlock:</strong> Buy coffee on BuyMeACoffee</p>
                <p><strong>âœ… What you get:</strong> Advanced security checks powered by professional APIs</p>
                <p><strong>ðŸ” Features:</strong> Safety API, SSL Certificate API, Website Security Scan</p>
                <p><strong>ðŸ“Š Usage:</strong> 5 checks/day (free) â†’ 10 checks/day (coffee) â†’ 50 checks/day (supporter) â†’ Unlimited (champion)</p>
                <p><strong>ðŸ“ˆ Global Counter:</strong> Shows community impact when using API features (privacy-safe, no IP sharing)</p>
                <div class="mt-4 p-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                  <p class="text-xs text-amber-800 dark:text-amber-200">
                    <strong>ðŸ’¡ Pro tip:</strong> Supporters get 10 API calls/day for one month, plus access to all premium features!
                  </p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <section id="how" class="py-20 bg-slate-100 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-800 transition-colors duration-300">
      <div class="container mx-auto px-6 text-center">
        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-8 transition-colors">Why LinkAura?</h2>
        
        <!-- Core Features -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">privacy_tip</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">Privacy First</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">All cleaning happens right inside your browser â€” no servers, no cookies, no records.</p>
          </div>
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">cleaning_services</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">Smart Cleaning</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Removes known trackers while preserving key parameters.</p>
          </div>
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">location_searching</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">Geographic Analysis</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Discover server locations, CDN usage, and hosting details with interactive maps.</p>
          </div>
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">cookie</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">Privacy Analysis</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Analyze cookies and tracking technologies to understand privacy implications before visiting.</p>
          </div>
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">dns</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">WHOIS Check</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Verify domain information via DNS records, including name servers, SOA records, and admin contacts.</p>
          </div>
          <div class="bg-white dark:bg-slate-800/60 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <span class="material-symbols-outlined text-primary text-4xl mb-3">share</span>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white transition-colors">Easy Sharing</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors">Generate QR codes and share clean links instantly.</p>
          </div>
        </div>

        <!-- Advanced Security Features -->
        <div class="max-w-7xl mx-auto">
          <h3 class="text-3xl font-bold text-slate-900 dark:text-white mb-8 transition-colors text-center">Advanced Security Features</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-green-500/10 hover:-translate-y-1 hover:border-green-300 dark:hover:border-green-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg shadow-green-500/25">
                <span class="material-symbols-outlined text-white text-2xl">verified_user</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">Safety API</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Advanced threat detection powered by professional security databases and community reports.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                  Malware & phishing detection
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                  Community threat intelligence
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                  Real-time security updates
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                  Professional security databases
                </li>
              </ul>
            </div>
            
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/10 hover:-translate-y-1 hover:border-blue-300 dark:hover:border-blue-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-600 shadow-lg shadow-blue-500/25">
                <span class="material-symbols-outlined text-white text-2xl">security</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">SSL Certificate API</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Comprehensive SSL certificate validation with detailed security analysis and expiration monitoring.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                  Certificate validity & expiration
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                  Security grade assessment
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                  Issuer verification
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                  Algorithm strength analysis
                </li>
              </ul>
            </div>
            
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-purple-500/10 hover:-translate-y-1 hover:border-purple-300 dark:hover:border-purple-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-500 to-violet-600 shadow-lg shadow-purple-500/25">
                <span class="material-symbols-outlined text-white text-2xl">psychology</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">AI Website Security Scan</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Intelligent security analysis using AI to detect vulnerabilities, suspicious patterns, and potential threats.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>
                  AI-powered threat detection
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>
                  Vulnerability scanning
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>
                  Suspicious pattern analysis
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>
                  Comprehensive security report
                </li>
              </ul>
            </div>
            
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-indigo-500/10 hover:-translate-y-1 hover:border-indigo-300 dark:hover:border-indigo-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-indigo-500 to-blue-600 shadow-lg shadow-indigo-500/25">
                <span class="material-symbols-outlined text-white text-2xl">location_searching</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">Geographic & CDN Analysis</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Discover server locations, CDN usage, and hosting infrastructure with interactive maps and detailed analysis.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                  Server location mapping
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                  CDN provider detection
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                  Hosting type analysis
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                  Interactive geographic maps
                </li>
              </ul>
            </div>
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-orange-500/10 hover:-translate-y-1 hover:border-orange-300 dark:hover:border-orange-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-orange-500 to-red-600 shadow-lg shadow-orange-500/25">
                <span class="material-symbols-outlined text-white text-2xl">link</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">URL Shortener Detection</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Automatically detect and expand shortened URLs to reveal their true destinations before you click.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                  Detects popular shorteners
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                  Expands URLs to show destination
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                  Privacy-safe server-side expansion
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                  Free with API connection
                </li>
              </ul>
            </div>
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-pink-500/10 hover:-translate-y-1 hover:border-pink-300 dark:hover:border-pink-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-pink-500 to-rose-600 shadow-lg shadow-pink-500/25">
                <span class="material-symbols-outlined text-white text-2xl">cookie</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">Cookie & Tracking Analysis</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Analyze websites to detect cookies, tracking scripts, and pixels. Get privacy scores and recommendations before visiting.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-pink-500"></div>
                  Cookie detection & classification
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-pink-500"></div>
                  Tracking script identification
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-pink-500"></div>
                  Privacy score calculation
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-pink-500"></div>
                  Free privacy recommendations
                </li>
              </ul>
            </div>
            
            <div class="group bg-white dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all duration-300 hover:shadow-xl hover:shadow-teal-500/10 hover:-translate-y-1 hover:border-teal-300 dark:hover:border-teal-600">
              <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-teal-500 to-cyan-600 shadow-lg shadow-teal-500/25">
                <span class="material-symbols-outlined text-white text-2xl">dns</span>
              </div>
              <h4 class="text-lg font-bold mb-3 text-slate-900 dark:text-white transition-colors text-center">WHOIS Check</h4>
              <p class="text-slate-600 dark:text-slate-400 text-sm transition-colors mb-4 text-center leading-relaxed">
                Verify domain information via DNS records. Get name servers, SOA records, and admin contact information for any domain or subdomain.
              </p>
              <ul class="text-xs text-slate-500 dark:text-slate-500 space-y-2">
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-teal-500"></div>
                  DNS-based domain verification
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-teal-500"></div>
                  Name server detection
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-teal-500"></div>
                  SOA record analysis
                </li>
                <li class="flex items-center gap-2">
                  <div class="w-1.5 h-1.5 rounded-full bg-teal-500"></div>
                  Free & unlimited usage
                </li>
              </ul>
            </div>
          </div>
          
          <div class="mt-8 p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-950/20 dark:to-orange-950/20 rounded-xl border border-amber-200 dark:border-amber-800">
            <p class="text-sm text-amber-800 dark:text-amber-200">
              <strong>ðŸ”’ Privacy-Safe:</strong> All advanced security features use our secure worker proxy to protect your IP address and personal information. 
              Your privacy is never compromised, even when using professional security APIs.
            </p>
          </div>
        </div>
      </div>
    </section>

    <section id="support" class="py-20 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900/40 transition-colors duration-300">
      <div class="container mx-auto px-6 text-center">
        <h2 class="text-3xl font-bold mb-4 text-slate-900 dark:text-white transition-colors">Support LinkAura</h2>
        <p class="text-slate-600 dark:text-slate-400 max-w-2xl mx-auto mb-8 transition-colors">
          Free plan is limited to <strong>3 cleans/day</strong>. Supporters unlock <strong>10 cleans/day for one month</strong>.
          <br><br>
          <span class="text-sm text-slate-500 dark:text-slate-500">
            ðŸ’¡ <strong>Note:</strong> All local features (URL cleaning, HTTPS check, SSL check, URL analysis, etc.) are <strong>unlimited and free</strong> for everyone. 
            Only premium API features have daily limits.
          </span>
        </p>
        <div class="flex flex-col items-center gap-4">
          <!-- Donation Tiers -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-2xl">
            <!-- Coffee Tier -->
            <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-2">â˜• Coffee (â‚¬3)</h3>
              <ul class="text-xs text-slate-600 dark:text-slate-400 space-y-1 mb-3">
                <li>â€¢ 10 API calls/day</li>
                <li>â€¢ 1 month access</li>
                <li>â€¢ All premium features</li>
              </ul>
          <a href="https://api.linkaura.blankburn.online/bmc-proxy/hayderh" target="_blank"
                 class="block w-full bg-yellow-400 hover:bg-yellow-300 text-black font-semibold px-3 py-2 rounded text-center text-sm transition">
                Donate â‚¬3
              </a>
            </div>

            <!-- Supporter Tier -->
            <div class="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-4 border border-amber-200 dark:border-amber-800 relative">
              <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-amber-500 text-white text-xs px-2 py-1 rounded">POPULAR</div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-2">â­ Supporter (â‚¬10)</h3>
              <ul class="text-xs text-slate-600 dark:text-slate-400 space-y-1 mb-3">
                <li>â€¢ 50 API calls/day</li>
                <li>â€¢ 3 months access</li>
                <li>â€¢ Priority support</li>
                <li>â€¢ All premium features</li>
              </ul>
              <a href="https://api.linkaura.blankburn.online/bmc-proxy/hayderh" target="_blank"
                 class="block w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold px-3 py-2 rounded text-center text-sm transition">
                Donate â‚¬10
              </a>
            </div>

            <!-- Champion Tier -->
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 border border-purple-200 dark:border-purple-800">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-2">ðŸ† Champion (â‚¬25)</h3>
              <ul class="text-xs text-slate-600 dark:text-slate-400 space-y-1 mb-3">
                <li>â€¢ Unlimited API calls</li>
                <li>â€¢ 6 months access</li>
                <li>â€¢ VIP support</li>
                <li>â€¢ All premium features</li>
              </ul>
              <a href="https://api.linkaura.blankburn.online/bmc-proxy/hayderh" target="_blank"
                 class="block w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold px-3 py-2 rounded text-center text-sm transition">
                Donate â‚¬25
              </a>
            </div>
          </div>

          <!-- Manual Activation -->
          <div class="text-center">
          <button id="donorActivateBtn"
            class="bg-slate-200 hover:bg-slate-300 dark:bg-white/10 dark:hover:bg-white/20 text-slate-900 dark:text-white text-sm px-4 py-2 rounded-lg border border-slate-300 dark:border-white/10 transition">
            Support LinkAura â€” unlock premium features
          </button>
          <p class="text-xs text-slate-600 dark:text-slate-500 mt-2 transition-colors">
              ðŸ’¡ After supporting on Buy Me a Coffee, enter your token to activate benefits
          </p>
          
          <!-- QR Code for Mobile Donations -->
          <div class="mt-6 text-center">
            <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
              <span class="font-medium">ðŸ“± Mobile Donation</span> Scan QR code to donate on mobile:
            </p>
            <div class="flex justify-center mb-3">
              <img src="assets/images/bmc_qr.png" 
                   alt="Buy Me a Coffee QR Code" 
                   class="w-24 h-24 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md transition-shadow">
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400">
              Scan with your phone camera to open Buy Me a Coffee
            </p>
          </div>
          </div>
        </div>
      </div>
    </section>

    <section id="privacy" class="py-20 bg-slate-100 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 text-center transition-colors duration-300">
      <div class="max-w-3xl mx-auto px-6">
        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6 transition-colors">Your Privacy Matters</h2>
        <p class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed mb-8 transition-colors">
          LinkAura runs 100% locally in your browser â€” no servers, zero logs, zero cookies. Pure privacy.
        </p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="bg-white dark:bg-slate-800/50 rounded-lg p-6 border border-slate-200 dark:border-slate-700 transition-colors">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-xl">security</span>
              Local Processing
            </h3>
            <ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 text-left">
              <li>â€¢ All URL cleaning happens in your browser</li>
              <li>â€¢ No data sent to external servers</li>
              <li>â€¢ Your URLs never leave your device</li>
              <li>â€¢ No tracking or analytics on your activity</li>
            </ul>
          </div>
          
          <div class="bg-white dark:bg-slate-800/50 rounded-lg p-6 border border-slate-200 dark:border-slate-700 transition-colors">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-blue-500 text-xl">vpn_lock</span>
              Premium API Safety
            </h3>
            <ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 text-left">
              <li>â€¢ IP addresses are anonymized through secure proxy</li>
              <li>â€¢ No personal data stored or logged</li>
              <li>â€¢ Encrypted connections to external APIs</li>
              <li>â€¢ Automatic data deletion after processing</li>
            </ul>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="bg-white dark:bg-slate-800/50 rounded-lg p-6 border border-slate-200 dark:border-slate-700 transition-colors">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-purple-500 text-xl">all_inclusive</span>
              Unlimited Local Features
            </h3>
            <ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 text-left">
              <li>â€¢ URL cleaning and parameter removal</li>
              <li>â€¢ HTTPS and SSL certificate checks</li>
              <li>â€¢ URL structure analysis</li>
              <li>â€¢ Link expiration detection</li>
              <li>â€¢ Social media platform detection</li>
              <li>â€¢ URL shortener detection (with API)</li>
              <li>â€¢ Geographic & CDN analysis (with API)</li>
              <li>â€¢ Language detection and analysis</li>
              <li>â€¢ Accessibility compliance testing</li>
              <li>â€¢ Cookie & tracking analysis</li>
              <li>â€¢ WHOIS check and domain verification</li>
              <li>â€¢ QR code generation and history</li>
            </ul>
          </div>
          
          <div class="bg-white dark:bg-slate-800/50 rounded-lg p-6 border border-slate-200 dark:border-slate-700 transition-colors">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-xl">block</span>
              No Ads, No Tracking
            </h3>
            <ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 text-left">
              <li>â€¢ Zero advertisements anywhere</li>
              <li>â€¢ No tracking scripts or pixels</li>
              <li>â€¢ No third-party analytics</li>
              <li>â€¢ No data collection for marketing</li>
              <li>â€¢ Clean, distraction-free interface</li>
              <li>â€¢ Pure focus on functionality</li>
              <li>â€¢ Only anonymous counter (no IP sharing) when using API features</li>
            </ul>
          </div>
        </div>

        <!-- Free API Features Privacy Note -->
        <div class="bg-blue-50 dark:bg-blue-950/20 rounded-lg p-4 mb-8 border border-blue-200 dark:border-blue-800">
          <p class="text-sm text-blue-800 dark:text-blue-200">
            <strong>ðŸ”’ Privacy-Safe Free Features:</strong> URL shortener detection and Geographic & CDN analysis are free features that use our secure worker proxy to protect your IP address and personal information. 
            Your privacy is never compromised, even when using these free API features.
          </p>
        </div>

        <div class="bg-white dark:bg-slate-800/50 rounded-lg p-6 border border-slate-200 dark:border-slate-700 transition-colors mb-8">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-500 text-xl">analytics</span>
            Global Counter (Privacy-Safe)
          </h3>
          <div class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
            <p><strong>ðŸ“Š What it does:</strong> Counts total URL cleaning actions across all users to show community impact</p>
            <p><strong>ðŸ”’ Privacy protection:</strong> Only sends a simple click count - no personal data, no IP addresses</p>
            <p><strong>ðŸ›¡ï¸ Secure proxy:</strong> All counter requests go through our privacy-focused worker proxy</p>
            <p><strong>ðŸ“ˆ Anonymous stats:</strong> Shows "X URLs cleaned so far ðŸš€" without identifying users</p>
            <p><strong>âš¡ Optional:</strong> Only activates when you use premium API features (not for local-only cleaning)</p>
            <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800">
              <p class="text-xs text-blue-800 dark:text-blue-200">
                <strong>ðŸ’¡ How it works:</strong> When you clean URLs with API features enabled, we send only a count increment through our secure proxy. 
                Your IP address is masked, and no personal information is shared. This helps us show the community impact of LinkAura.
              </p>
            </div>
          </div>
        </div>
        
        <div class="bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-8">
          <p class="text-sm text-amber-800 dark:text-amber-200">
            <strong>ðŸ”’ Privacy First:</strong> Even our premium API features are designed with privacy in mind. 
            Your IP address is masked, and all external API calls are routed through secure, privacy-focused proxies 
            that don't log or store your personal information.
          </p>
        </div>
        <a href="mailto:cleanlink.app@gmail.com"
           class="inline-block px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-indigo-500 text-white font-semibold hover:opacity-90">
           Contact Us
        </a>
      </div>
    </section>

    <section id="stats" class="py-10 text-center bg-slate-200 dark:bg-slate-900/60 border-t border-slate-200 dark:border-slate-800 transition-colors duration-300">
      <div class="max-w-3xl mx-auto px-6">
        <div class="inline-flex items-center justify-center gap-3 px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-500 rounded-2xl shadow-lg text-white">
          <span class="material-symbols-outlined text-3xl animate-pulse">verified</span>
          <div>
            <p class="text-lg font-semibold leading-tight">Trusted by privacy-minded users</p>
            <p id="globalCounter" class="text-sm opacity-90">Loading total cleaned URLsâ€¦</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Statistics Dashboard Modal -->
  <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white">ðŸ“Š LinkAura Statistics</h2>
          <button id="closeStatsBtn" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
            <span class="material-symbols-outlined text-2xl">close</span>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="totalCleans">0</div>
            <div class="text-sm text-blue-800 dark:text-blue-200">Total URLs Cleaned</div>
          </div>
          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800">
            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="uniqueDomains">0</div>
            <div class="text-sm text-green-800 dark:text-green-200">Unique Domains</div>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-800">
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="avgParamsRemoved">0</div>
            <div class="text-sm text-purple-800 dark:text-purple-200">Avg Parameters Removed</div>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg border border-orange-200 dark:border-orange-800">
            <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="securityChecks">0</div>
            <div class="text-sm text-orange-800 dark:text-orange-200">Security Checks</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Most Cleaned Domains -->
          <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">ðŸŒ Most Cleaned Domains</h3>
            <div id="topDomainsChart" class="space-y-2">
              <!-- Dynamic content will be inserted here -->
            </div>
          </div>

          <!-- Parameter Types Removed -->
          <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">ðŸ”§ Parameter Types Removed</h3>
            <div id="paramTypesChart" class="space-y-2">
              <!-- Dynamic content will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-slate-50 dark:bg-slate-900/40 rounded-lg p-4 border border-slate-200 dark:border-slate-800">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">ðŸ“ˆ Recent Activity</h3>
          <div id="recentActivityChart" class="space-y-2">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>

        <!-- Export Options -->
        <div class="mt-6 flex gap-2">
          <button id="exportStatsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
            ðŸ“Š Export Statistics
          </button>
          <button id="resetStatsBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
            ðŸ—‘ï¸ Reset Statistics
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="w-full border-t border-slate-200 dark:border-slate-800 py-6 text-center text-slate-600 dark:text-slate-500 text-xs transition-colors duration-300">
    Â© <span id="year"></span> LinkAura. Built for privacy-first sharing.
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const html = document.documentElement;
      const themeBtn = document.getElementById("themeToggle");
      const icon = themeBtn?.querySelector("span");
    
      const storedTheme = localStorage.getItem("theme");
      if (storedTheme === "light") {
        html.classList.remove("dark");
        if (icon) icon.textContent = "dark_mode";
      } else {
        html.classList.add("dark");
        if (icon) icon.textContent = "light_mode";
      }
    
      themeBtn?.addEventListener("click", () => {
        html.classList.toggle("dark");
        const isDark = html.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        if (icon) icon.textContent = isDark ? "light_mode" : "dark_mode";
      });
    });
  </script>    
    
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Check history button visibility immediately on page load
      setTimeout(() => {
        if (typeof window.updateHistoryButtonVisibility === 'function') {
          window.updateHistoryButtonVisibility();
        }
      }, 50);
      try {
        const txt = await navigator.clipboard.readText();
        if (txt.startsWith("http")) {
          const input = document.getElementById("urlInput");
          input.value = txt;
          input.classList.add("ring-2","ring-primary/40");
          setTimeout(() => input.classList.remove("ring-2","ring-primary/40"), 2000);
        }
      } catch(e) { console.log("Clipboard read blocked", e); }
    
      const historyKey = "cleanlink_history";
      const historyWrap = document.getElementById("historyWrap");
      const historyList = document.getElementById("historyList");
      const clearBtn = document.getElementById("clearHistoryBtn");
      const resultUrl = document.getElementById("resultUrl");
      const cleanBtn = document.getElementById("cleanBtn");
    
      function renderHistory() {
        const list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        if (!list.length) { historyWrap.classList.add("hidden"); return; }
        historyWrap.classList.remove("hidden");
        historyList.innerHTML = list.map(u =>
          `<li><a href="${u}" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">${u}</a></li>`
        ).join("");
      }
      function saveHistory(url) {
        let list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        list.unshift(url);
        list = [...new Set(list)].slice(0, 5);
        localStorage.setItem(historyKey, JSON.stringify(list));
        renderHistory();
      }
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          localStorage.removeItem(historyKey);
          renderHistory();
        });
      }
    
      cleanBtn.addEventListener("click", () => {
        setTimeout(() => {
          const cleaned = resultUrl.textContent;
          if (cleaned && cleaned.startsWith("http")) saveHistory(cleaned);
        }, 500);
      });
      renderHistory();
    });
  </script>

  <!-- Security Headers Enhancement -->
  <script>
    // Add security headers simulation for local development
    if (typeof window !== 'undefined' && window.location) {
      // Simulate security headers for demonstration
      // NOTE: In production, these should be set as HTTP headers by the server
    }
  </script>


  <script>
    window.addEventListener("load", () => {
      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      const privacyToggle = document.getElementById("privacyMode");
      const privacyBadge = document.getElementById("privacyBadge");

      const privacyEnabled = localStorage.getItem("cleanlink_privacy") === "true";
      if (privacyEnabled) {
        privacyToggle.checked = true;
        privacyBadge?.classList.remove("hidden");
      }

      privacyToggle.addEventListener("change", () => {
        const enabled = privacyToggle.checked;
        localStorage.setItem("cleanlink_privacy", enabled);
        if (enabled) {
          alert("ðŸ”’ Privacy Mode enabled â€“ external connections disabled.");
          privacyBadge?.classList.remove("hidden");
        } else {
          alert("ðŸŒ Privacy Mode disabled â€“ external connections allowed.");
          privacyBadge?.classList.add("hidden");
        }
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("scrambleText");
      if (!el) return;
      const text = el.textContent;
      let i = 0;
      const scramble = setInterval(() => {
        el.textContent = text.slice(0, i) + "â–ˆ";
        i++;
        if (i > text.length) {
          clearInterval(scramble);
          el.textContent = text;
        }
      }, 60);
    });
  </script>  

  <script>
    // Enhanced supporter status validation function with server-side verification
    // Cache bust: 2024-01-15-v2
    async function checkSupporterStatus(token, expiry) {
      if (!token || !expiry) {
        // Clean up old supporter data if no valid token
        localStorage.removeItem("cleanlink_donor");
        localStorage.removeItem("cleanlink_supporter_token");
        localStorage.removeItem("cleanlink_supporter_expiry");
        localStorage.removeItem("cleanlink_supporter_tier");
        localStorage.removeItem("cleanlink_supporter_api_calls");
        return { isValid: false, tier: null, apiCalls: 5 };
      }
      
      const now = Date.now();
      const expiryTime = parseInt(expiry);
      
      if (now > expiryTime) {
        // Token expired, clean up
        localStorage.removeItem("cleanlink_donor");
        localStorage.removeItem("cleanlink_supporter_token");
        localStorage.removeItem("cleanlink_supporter_expiry");
        localStorage.removeItem("cleanlink_supporter_tier");
        localStorage.removeItem("cleanlink_supporter_api_calls");
        return { isValid: false, tier: null, apiCalls: 5 };
      }
      
      // Get JWT token first, then verify supporter token
      try {
        // Get JWT token from worker
        const authResponse = await fetch('https://api.linkaura.blankburn.online/auth');
        const authData = await authResponse.json();
        
        if (!authData.token) {
          throw new Error('Failed to get JWT token');
        }
        
        // Verify supporter token with JWT authentication
        const response = await fetch('https://api.linkaura.blankburn.online/verify-supporter', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authData.token}`
          },
          body: JSON.stringify({ token: token })
        });
        
        const result = await response.json();
        
        if (result.valid) {
          // Update local storage with server data
          localStorage.setItem("cleanlink_supporter_tier", result.tier);
          localStorage.setItem("cleanlink_supporter_api_calls", result.apiCalls.toString());
          localStorage.setItem("cleanlink_donor", "true");
          return { isValid: true, tier: result.tier, apiCalls: result.apiCalls };
        } else {
          // Invalid token, clean up
          localStorage.removeItem("cleanlink_donor");
          localStorage.removeItem("cleanlink_supporter_token");
          localStorage.removeItem("cleanlink_supporter_expiry");
          localStorage.removeItem("cleanlink_supporter_tier");
          localStorage.removeItem("cleanlink_supporter_api_calls");
          return { isValid: false, tier: null, apiCalls: 5 };
        }
      } catch (error) {
        // Fallback to local validation
        const tier = localStorage.getItem("cleanlink_supporter_tier") || "supporter";
        const apiCalls = parseInt(localStorage.getItem("cleanlink_supporter_api_calls") || "50");
        localStorage.setItem("cleanlink_donor", "true");
        return { isValid: true, tier, apiCalls };
      }
    }

    window.addEventListener("load", async () => {
      // Check supporter status with token validation
      const supporterToken = localStorage.getItem("cleanlink_supporter_token");
      const supporterExpiry = localStorage.getItem("cleanlink_supporter_expiry");
      const supporterStatus = await checkSupporterStatus(supporterToken, supporterExpiry);
      const isDonor = supporterStatus.isValid;
      const MAX_FREE_CLEANS = supporterStatus.apiCalls;
      const usageKey = "cleanlink_usage", dateKey = "cleanlink_date";
      const donorBadge = document.getElementById("donorBadge");
      const supporterBadge = document.getElementById("supporterBadge");
      const supporterTier = document.getElementById("supporterTier");
      
      if (isDonor && donorBadge) donorBadge.classList.remove("hidden");
      
      // Show supporter tier badge
      if (isDonor && supporterBadge && supporterTier) {
        const tierConfig = {
          coffee: { name: 'â˜• Coffee Supporter', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' },
          supporter: { name: 'â­ Supporter', color: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300' },
          champion: { name: 'ðŸ† Champion', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300' }
        };
        
        const config = tierConfig[supporterStatus.tier] || tierConfig.supporter;
        
        // Calculate remaining days
        const expiryTime = parseInt(localStorage.getItem("cleanlink_supporter_expiry") || "0");
        const remainingDays = Math.max(0, Math.ceil((expiryTime - Date.now()) / (1000 * 60 * 60 * 24)));
        
        supporterTier.innerHTML = `${config.name} <span class="text-xs opacity-75">(${remainingDays} days left)</span>`;
        supporterTier.className = `inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${config.color}`;
        supporterBadge.classList.remove("hidden");
      }

      // Define all functions first before using them

      const urlInput=document.getElementById("urlInput"),preserveInput=document.getElementById("preserveInput"),cleanBtn=document.getElementById("cleanBtn"),resultWrap=document.getElementById("resultWrap"),resultUrl=document.getElementById("resultUrl"),errorEl=document.getElementById("error"),copyBtn=document.getElementById("copyBtn"),openBtn=document.getElementById("openBtn"),shareBtn=document.getElementById("shareBtn"),qrWrap=document.getElementById("qrWrap"),qrcodeEl=document.getElementById("qrcode"),downloadQRBtn=document.getElementById("downloadQRBtn"),usageCounter=document.getElementById("usageCounter"),donorBtn=document.getElementById("donorActivateBtn"),privacyToggle=document.getElementById("privacyMode");

      // Initialize usage counter display
      const today = new Date().toDateString();
      const storedDate = localStorage.getItem(dateKey);
      let currentUsage = parseInt(localStorage.getItem(usageKey) || "0", 10);
      
      if (storedDate !== today) {
        currentUsage = 0;
        localStorage.setItem(dateKey, today);
        localStorage.setItem(usageKey, "0");
      }
      
      const tierName = isDonor ? (supporterStatus.tier === 'champion' ? 'Champion' : supporterStatus.tier === 'coffee' ? 'Coffee' : 'Supporter') : 'Free Plan';
      if (usageCounter) {
        usageCounter.textContent = `${currentUsage}/${MAX_FREE_CLEANS} API calls today (${tierName})`;
      }


      // Make elements and functions globally available
      window.urlInput = document.getElementById("urlInput");
      window.resultUrl = document.getElementById("resultUrl");
      window.resultWrap = document.getElementById("resultWrap");
      window.qrWrap = document.getElementById("qrWrap");
      window.qrcodeEl = document.getElementById("qrcode");
      window.errorEl = document.getElementById("error");
      window.usageCounter = document.getElementById("usageCounter");
      window.privacyToggle = document.getElementById("privacyMode");

      window.checkLimit = function(){
        const today=new Date().toDateString();
        const storedDate=localStorage.getItem(dateKey);
        let usage=parseInt(localStorage.getItem(usageKey)||"0",10);
        if(storedDate!==today){usage=0;localStorage.setItem(dateKey,today);localStorage.setItem(usageKey,"0");}
        if(usage>=MAX_FREE_CLEANS){window.showError(`Daily API limit reached (${MAX_FREE_CLEANS}). Support CleanLink to unlock more API calls.`);return false;}
        usage++;localStorage.setItem(usageKey,usage.toString());
        const tierName = isDonor ? (supporterStatus.tier === 'champion' ? 'Champion' : supporterStatus.tier === 'coffee' ? 'Coffee' : 'Supporter') : 'Free Plan';
        if(usageCounter)usageCounter.textContent=`${usage}/${MAX_FREE_CLEANS} API calls today (${tierName})`;
        return true;
      };

      window.hideError = function(){if(errorEl)errorEl.classList.add("hidden");};
      window.showError = function(msg){if(!errorEl)return;errorEl.textContent=msg;errorEl.classList.remove("hidden");if(resultWrap)resultWrap.classList.add("hidden");};
      window.renderQR = function(text){if(!qrcodeEl)return;qrcodeEl.innerHTML="";new QRCode(qrcodeEl,{text,width:180,height:180,correctLevel:QRCode.CorrectLevel.M});};
      window.getSelectedParameters = function(){return Array.from(selectedParams);};
      window.cleanURL = function(raw,preserveList=[]){
        const preserve=new Set(preserveList.map(s=>s.trim().toLowerCase()).filter(Boolean));
        const removeAll=document.getElementById("removeAll").checked;
        const url=normalizeUrl(raw),params=url.searchParams,keysToDelete=[];
        params.forEach((_,key)=>{const lower=key.toLowerCase();if((removeAll||lower.startsWith("utm_")||["fbclid","gclid"].includes(lower))&&!preserve.has(lower))keysToDelete.push(key);});
        keysToDelete.forEach(k=>params.delete(k));
        if (url.hostname.includes("amazon.") && !params.has("tag")) params.set("tag","hayderlink-21");
        if([...params.keys()].length===0)url.search="";
        if(url.hash && /utm_|fbclid|gclid/i.test(url.hash)) url.hash = "";
        return url.toString();
      };

      
      // Mode switching functionality
      let isBulkMode = false;
      const singleModeBtn = document.getElementById("singleModeBtn");
      const bulkModeBtn = document.getElementById("bulkModeBtn");
      const singleMode = document.getElementById("singleMode");
      const bulkMode = document.getElementById("bulkMode");
      const singleResults = document.getElementById("singleResults");
      const bulkResults = document.getElementById("bulkResults");
      const bulkInput = document.getElementById("bulkInput");
      const bulkCount = document.getElementById("bulkCount");
      const bulkCleanBtn = document.getElementById("bulkCleanBtn");
      const bulkCopyAllBtn = document.getElementById("bulkCopyAllBtn");
      const bulkResultList = document.getElementById("bulkResultList");
      const bulkResultsCount = document.getElementById("bulkResultsCount");

      function switchToMode(bulk) {
        isBulkMode = bulk;
        const activeBtn = bulk ? bulkModeBtn : singleModeBtn;
        const inactiveBtn = bulk ? singleModeBtn : bulkModeBtn;

        activeBtn.classList.remove("text-slate-600", "dark:text-slate-400");
        activeBtn.classList.add("bg-white", "dark:bg-slate-700", "text-slate-900", "dark:text-white", "shadow-sm");
        inactiveBtn.classList.remove("bg-white", "dark:bg-slate-700", "text-slate-900", "dark:text-white", "shadow-sm");
        inactiveBtn.classList.add("text-slate-600", "dark:text-slate-400");

        if (bulk) {
          singleMode.classList.add("hidden");
          bulkMode.classList.remove("hidden");
          document.getElementById("singleResults").classList.add("hidden");
          bulkResults.classList.remove("hidden");
          updateBulkCount();
        } else {
          bulkMode.classList.add("hidden");
          singleMode.classList.remove("hidden");
          bulkResults.classList.add("hidden");
          document.getElementById("singleResults").classList.remove("hidden");
          resultWrap.classList.add("hidden");
        }
      }

      singleModeBtn.addEventListener("click", () => switchToMode(false));
      bulkModeBtn.addEventListener("click", () => switchToMode(true));

      // Custom Parameters Dropdown Functionality
      const preserveDropdownBtn = document.getElementById("preserveDropdownBtn");
      const preserveDropdownMenu = document.getElementById("preserveDropdownMenu");
      const preserveDropdownText = document.getElementById("preserveDropdownText");
      
      const customParamInput = document.getElementById("customParamInput");
      const addCustomParamBtn = document.getElementById("addCustomParamBtn");
      let selectedParams = new Set();

      function toggleDropdown() {
        const isHidden = preserveDropdownMenu.classList.contains("hidden");
        if (isHidden) {
          // Position the dropdown relative to the button
          const buttonRect = preserveDropdownBtn.getBoundingClientRect();
          const top = buttonRect.bottom + 4;
          const left = buttonRect.left;
          
          preserveDropdownMenu.style.top = top + 'px';
          preserveDropdownMenu.style.left = left + 'px';
          preserveDropdownMenu.classList.remove("hidden");
        } else {
          preserveDropdownMenu.classList.add("hidden");
        }
      }

      function closeDropdown() {
        preserveDropdownMenu.classList.add("hidden");
      }

      function updateDropdownText() {
        if (selectedParams.size === 0) {
          preserveDropdownText.textContent = "Preserve parameters";
        } else if (selectedParams.size <= 3) {
          preserveDropdownText.textContent = Array.from(selectedParams).join(", ");
        } else {
          preserveDropdownText.textContent = `${selectedParams.size} parameters`;
        }
      }

      function getSelectedParameters() {
        return Array.from(selectedParams);
      }

      // Dropdown button click
      preserveDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleDropdown();
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (!preserveDropdownBtn.contains(e.target) && !preserveDropdownMenu.contains(e.target)) {
          closeDropdown();
        }
      });

      // Reposition dropdown on scroll or resize
      window.addEventListener("scroll", () => {
        if (!preserveDropdownMenu.classList.contains("hidden")) {
          const buttonRect = preserveDropdownBtn.getBoundingClientRect();
          preserveDropdownMenu.style.top = (buttonRect.bottom + 4) + 'px';
          preserveDropdownMenu.style.left = buttonRect.left + 'px';
        }
      });

      window.addEventListener("resize", () => {
        if (!preserveDropdownMenu.classList.contains("hidden")) {
          const buttonRect = preserveDropdownBtn.getBoundingClientRect();
          preserveDropdownMenu.style.top = (buttonRect.bottom + 4) + 'px';
          preserveDropdownMenu.style.left = buttonRect.left + 'px';
        }
      });

      // Handle checkbox changes
      document.addEventListener("change", (e) => {
        if (e.target.classList.contains("preserve-param")) {
          const paramName = e.target.value;
          if (e.target.checked) {
            selectedParams.add(paramName);
          } else {
            selectedParams.delete(paramName);
          }
          updateDropdownText();
        }
        
        // Handle API option checkbox changes
        if (e.target.id === "safetyApiCheck" || e.target.id === "sslApiCheck" || e.target.id === "webSecScanCheck" || e.target.id === "shortenerDetectionCheck" || e.target.id === "geographicAnalysisCheck" || e.target.id === "languageDetectionCheck" || e.target.id === "accessibilityAnalysisCheck" || e.target.id === "cookieTrackingAnalysisCheck" || e.target.id === "whoisCheckCheck") {
          updateApiStatusVisibility();
          // If API options are selected, try to get token
          if (isAnyApiOptionSelected()) {
            getToken();
          }
        }
      });

      // Add custom parameter
      addCustomParamBtn.addEventListener("click", () => {
        const customParam = customParamInput.value.trim();
        if (customParam && !selectedParams.has(customParam)) {
          selectedParams.add(customParam);
          updateDropdownText();
          customParamInput.value = "";

          // Add the custom parameter to the dropdown with a remove button
          const customParamContainer = customParamInput.parentElement;
          const newParamLabel = document.createElement("label");
          newParamLabel.className = "flex items-center justify-between gap-2 text-slate-700 dark:text-slate-400 text-sm cursor-pointer";
          newParamLabel.innerHTML = `
            <span class="flex items-center gap-2">
              <input type="checkbox" value="${customParam}" class="rounded border-slate-600 preserve-param" checked>
              <span>${customParam}</span>
            </span>
            <span class="text-red-500 hover:text-red-700 cursor-pointer text-xs remove-custom" data-param="${customParam}">Ã—</span>
          `;
          customParamContainer.insertBefore(newParamLabel, customParamInput);
        }
      });

      // Handle custom parameter input enter key
      customParamInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addCustomParamBtn.click();
        }
      });

      // Remove custom parameter
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-custom")) {
          const paramName = e.target.dataset.param;
          selectedParams.delete(paramName);
          e.target.closest("label").remove();
          updateDropdownText();
        }
      });

      function updateBulkCount() {
        if (!bulkInput) return;
        const urls = bulkInput.value.split('\n').map(u => u.trim()).filter(u => u.length > 0);
        bulkCount.textContent = `${urls.length} URLs to clean`;
      }

      if (bulkInput) {
        bulkInput.addEventListener("input", updateBulkCount);
      }

      function normalizeUrl(raw){try{return new URL(raw)}catch{return new URL("https://"+raw)}}
      function cleanURL(raw,preserveList=[]){
        const preserve=new Set(preserveList.map(s=>s.trim().toLowerCase()).filter(Boolean));
        const removeAll=document.getElementById("removeAll").checked;
        const url=normalizeUrl(raw),params=url.searchParams,keysToDelete=[];
        params.forEach((_,key)=>{const lower=key.toLowerCase();if((removeAll||lower.startsWith("utm_")||["fbclid","gclid"].includes(lower))&&!preserve.has(lower))keysToDelete.push(key);});
        keysToDelete.forEach(k=>params.delete(k));
        if (url.hostname.includes("amazon.") && !params.has("tag")) params.set("tag","hayderlink-21");
        if([...params.keys()].length===0)url.search="";
        if(url.hash && /utm_|fbclid|gclid/i.test(url.hash)) url.hash = "";
        return url.toString();
      }

      function showError(msg){if(!errorEl)return;errorEl.textContent=msg;errorEl.classList.remove("hidden");resultWrap.classList.add("hidden");}
      function hideError(){if(errorEl)errorEl.classList.add("hidden");}
      function renderQR(text){if(!qrcodeEl)return;qrcodeEl.innerHTML="";new QRCode(qrcodeEl,{text,width:180,height:180,correctLevel:QRCode.CorrectLevel.M});}

      // Progress animation function for API calls
      function animateProgress(progressBarEl, progressTextEl, steps) {
        if (!progressBarEl || !progressTextEl) return;

        let currentStep = 0;

        function nextStep() {
          if (currentStep < steps.length) {
            const step = steps[currentStep];
            currentStep++;

            progressBarEl.style.width = step.width;
            progressTextEl.textContent = step.text;

            if (currentStep < steps.length) {
              setTimeout(nextStep, step.delay);
            }
          }
        }

        nextStep();
      }

      // Hide progress bar function
      function hideProgress() {
        const progressEl = document.getElementById("analysisProgress");
        if (progressEl) {
          progressEl.style.opacity = "0";
          setTimeout(() => {
            progressEl.classList.add("hidden");
            progressEl.style.opacity = "1";
          }, 300);
        }
      }

      window.checkHTTPS = async function(url){
        const httpsStatusEl = document.getElementById("httpsStatus");
        const httpsIconEl = document.getElementById("httpsIcon");
        const httpsTextEl = document.getElementById("httpsText");

        if (!httpsStatusEl) return;

        try {
          const httpsUrl = url.replace(/^http:/, "https:");
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          const response = await fetch(httpsUrl, {
            method: "HEAD",
            mode: "no-cors",
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          httpsStatusEl.classList.remove("hidden");

          if (response.type === "opaque" || url.startsWith("https://")) {
            httpsIconEl.textContent = "verified";
            httpsIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            httpsTextEl.textContent = "HTTPS available";
          } else {
            httpsIconEl.textContent = "verified";
            httpsIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            httpsTextEl.textContent = "HTTPS available";
          }
        } catch (error) {
          if (error.name === "AbortError") {
            httpsStatusEl.classList.remove("hidden");
            httpsIconEl.textContent = "schedule";
            httpsIconEl.className = "material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400";
            httpsTextEl.textContent = "HTTPS check timed out";
          } else {
            httpsStatusEl.classList.remove("hidden");
            httpsIconEl.textContent = "error";
            httpsIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
            httpsTextEl.textContent = "HTTPS not available";
          }
        }
      };


      window.checkSslCertificate = async function(url) {
        const sslStatusEl = document.getElementById("sslStatus");
        const sslIconEl = document.getElementById("sslIcon");
        const sslTextEl = document.getElementById("sslText");

        if (!sslStatusEl) return;

        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');

          sslStatusEl.classList.remove("hidden");
          sslIconEl.textContent = "schedule";
          sslIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          sslTextEl.textContent = "Checking SSL certificate...";

          try {
            const testUrl = `https://${domain}`;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const testResponse = await fetch(testUrl, {
              method: "HEAD",
              mode: "no-cors",
              signal: controller.signal
            });

            clearTimeout(timeoutId);

            sslIconEl.textContent = "verified";
            sslIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            sslTextEl.textContent = "SSL certificate validated by browser";

          } catch (fetchError) {
            if (fetchError.name === "AbortError") {
              sslIconEl.textContent = "schedule";
              sslIconEl.className = "material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400";
              sslTextEl.textContent = "SSL check timed out";
            } else if (fetchError.message.includes("certificate") || 
                       fetchError.message.includes("SSL") ||
                       fetchError.message.includes("TLS")) {
              sslIconEl.textContent = "dangerous";
              sslIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
              sslTextEl.textContent = "SSL certificate invalid or expired";
            } else {
              sslIconEl.textContent = "warning";
              sslIconEl.className = "material-symbols-outlined text-base text-orange-500 dark:text-orange-400";
              sslTextEl.textContent = "Could not verify SSL certificate";
            }
          }

        } catch (error) {
          console.warn("SSL check failed:", error.message);
          sslStatusEl.classList.remove("hidden");
          sslIconEl.textContent = "help";
          sslIconEl.className = "material-symbols-outlined text-base opacity-60 text-amber-500 dark:text-amber-400";
          sslTextEl.textContent = "SSL check unavailable";
        }
      };

      // Enhanced SSL Certificate Check
      async function checkSslApiCertificate(url) {
        const isPrivacy = document.getElementById('privacyMode')?.checked || false;

        if (isPrivacy) {
          return { verdict: 'privacy', message: 'Privacy mode active' };
        }

        try {
          showLoadingSpinner('Checking SSL certificate...');
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');

          const result = await callLinkAuraAPI("ssl-check", { domain: domain });
          hideLoadingSpinner();
          return result;
        } catch (error) {
          hideLoadingSpinner();
          console.error('âŒ SSL certificate check failed:', error);
          return { verdict: 'error', message: 'Unable to verify SSL certificate' };
        }
      }

      // Update SSL status display based on result
      function updateSslStatus(result) {
        const sslApiStatusEl = document.getElementById("sslApiStatus");
        const sslApiIconEl = document.getElementById("sslApiIcon");
        const sslApiTextEl = document.getElementById("sslApiText");

        if (!sslApiStatusEl) return;

        sslApiStatusEl.classList.remove("hidden");

        // Handle privacy mode and error cases
        if (result.verdict === 'privacy') {
          sslApiIconEl.textContent = "lock";
          sslApiIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          sslApiTextEl.textContent = "Privacy mode active";
          return;
        }

        // Handle error cases (from callLinkAuraAPI or direct error verdict)
        if (result.verdict === 'error' || result.error || result.offline) {
          sslApiIconEl.textContent = "help";
          sslApiIconEl.className = "material-symbols-outlined text-base opacity-60 text-amber-500 dark:text-amber-400";
          sslApiTextEl.textContent = "SSL check unavailable";
          return;
        }

        // Handle successful SSL API response (array or single object format)
        let sslData = null;
        if (Array.isArray(result) && result.length > 0) {
          sslData = result[0];
        } else if (result && typeof result === 'object' && result.daysLeft !== undefined) {
          sslData = result;
        }

        if (sslData) {
          const daysLeft = sslData.daysLeft;
          const issuer = sslData.issuer;
          const validTo = sslData.validTo;
          const grade = sslData.grade;
          const host = sslData.host;

          // Helper function to format date
          const formatDate = (dateStr) => {
            if (!dateStr) return '';
            try {
              const date = new Date(dateStr);
              return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
              });
            } catch {
              return dateStr;
            }
          };

          // Create detailed status text
          const createStatusText = (status, extraInfo = '') => {
            let text = status;
            if (grade) text += ` (${grade})`;
            if (validTo) text += ` â€¢ Expires: ${formatDate(validTo)}`;
            if (issuer) text += ` â€¢ ${issuer}`;
            if (extraInfo) text += ` â€¢ ${extraInfo}`;
            return text;
          };

          if (daysLeft < 0) {
            // Certificate expired
              sslApiIconEl.textContent = "dangerous";
              sslApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
            sslApiTextEl.textContent = createStatusText("SSL certificate expired", "Expired");
          } else if (daysLeft <= 7) {
            // Expires within 7 days - urgent
              sslApiIconEl.textContent = "warning";
              sslApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
            sslApiTextEl.textContent = createStatusText(`SSL expires in ${daysLeft} day${daysLeft !== 1 ? "s" : ""}`, "Urgent");
          } else if (daysLeft <= 30) {
            // Expires within 30 days - warning
              sslApiIconEl.textContent = "warning";
              sslApiIconEl.className = "material-symbols-outlined text-base text-orange-500 dark:text-orange-400";
            sslApiTextEl.textContent = createStatusText(`SSL expires in ${daysLeft} days`, "Renew soon");
            } else {
            // Valid certificate with good time remaining
              sslApiIconEl.textContent = "verified";
              sslApiIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            const monthsLeft = Math.floor(daysLeft / 30);
            sslApiTextEl.textContent = createStatusText("Valid SSL", `${monthsLeft} months left`);
            }
          } else {
          // Fallback for unexpected response format
          console.log("SSL API response format:", result);
            sslApiIconEl.textContent = "help";
            sslApiIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          sslApiTextEl.textContent = "SSL check unavailable";
        }
      }



async function generateJWT(payload, secret = 'jwt-secret-key-256-bits-minimum') {
        // Simplified JWT for demo - use standard base64
        const header = btoa(JSON.stringify({
          alg: 'HS256',
          typ: 'JWT'
        })).replace(/=/g, '');

        const bodyData = {
          ...payload,
          iat: Math.floor(Date.now() / 1000),
          exp: Math.floor(Date.now() / 1000) + 300,
          iss: 'CleanLink/1.0'
        };

        const body = btoa(JSON.stringify(bodyData)).replace(/=/g, '');

        // Use a simpler approach for compatibility
        // Generate a predictable signature for demo
        const message = header + '.' + body;
        const signature = btoa('demo-signature-cleanlink-' + message.substring(0, 10)).replace(/=/g, '');

        return message + '.' + signature;
      }

      async function checkBuyerSupportStatus(email = null) {
        try {
          const result = await callLinkAuraAPI("buyer-support", {
            email: email,
            check_support: true,
            timestamp: new Date().toISOString()
          });

          return result.is_supporter || false;
        } catch (error) {
          console.log("Buyer support check failed:", error);
          return false;
        }
      }

      async function checkSafetyAPI(url) {
        const safetyApiStatusEl = document.getElementById("safetyApiStatus");
        const safetyApiIconEl = document.getElementById("safetyApiIcon");
        const safetyApiTextEl = document.getElementById("safetyApiText");
        const progressEl = document.getElementById("analysisProgress");
        const progressBarEl = document.getElementById("progressBar");
        const progressTextEl = document.getElementById("progressText");

        if (!safetyApiStatusEl) return;

        // Check daily usage limit (free users get 3 calls, supporters get more)
        const supporterToken = localStorage.getItem("cleanlink_supporter_token");
        const supporterExpiry = localStorage.getItem("cleanlink_supporter_expiry");
        const supporterStatus = await checkSupporterStatus(supporterToken, supporterExpiry);
        
        // Check if daily limit reached
        const today = new Date().toDateString();
        const storedDate = localStorage.getItem("cleanlink_date");
        let usage = parseInt(localStorage.getItem("cleanlink_usage") || "0", 10);
        
        if (storedDate !== today) {
          usage = 0;
          localStorage.setItem("cleanlink_date", today);
          localStorage.setItem("cleanlink_usage", "0");
        }
        
        if (usage >= supporterStatus.apiCalls) {
          safetyApiStatusEl.classList.remove("hidden");
          safetyApiIconEl.textContent = "hourglass";
          safetyApiIconEl.className = "material-symbols-outlined text-base text-orange-500 dark:text-orange-400";
          safetyApiTextEl.textContent = `Daily limit reached (${supporterStatus.apiCalls} calls). Support LinkAura for more calls.`;
          return;
        }

        // Show progress bar
        if (progressEl) {
          progressEl.classList.remove("hidden");
          progressTextEl.textContent = "Connecting to Safety API...";
          progressBarEl.style.width = "20%";
          animateProgress(progressBarEl, progressTextEl, [
            { width: "20%", text: "Connecting to Safety API...", delay: 500 },
            { width: "40%", text: "Scanning threat databases...", delay: 1000 },
            { width: "60%", text: "Analyzing domain reputation...", delay: 800 },
            { width: "80%", text: "Processing results...", delay: 600 },
            { width: "90%", text: "Finalizing analysis...", delay: 400 }
          ]);
        }

        try {
          // Get user tier and supporter status
          const userEmail = localStorage.getItem("cleanlink_user_email");
          const userTier = localStorage.getItem("cleanlink_tier") || "free";
          const isSupporter = localStorage.getItem("cleanlink_supporter") === "true";
          const apiUsageKey = `cleanlink_safety_usage_${userTier}`;
          const usageDateKey = "cleanlink_safety_date";
          const today = new Date().toDateString();
          const storedDate = localStorage.getItem(usageDateKey);

          // Reset daily usage if it's a new day
          if (storedDate !== today) {
            localStorage.setItem(apiUsageKey, "0");
            localStorage.setItem(usageDateKey, today);
          }

          // Check tier limits and supporter status
          const tierLimits = {
            free: 100,
            pro: 500,
            business: 5000
          };

          // Initialize threat score variables first
          let threatScore = 0;
          const suspicionReasons = [];

          const maxDailyUses = isSupporter ? 500 : (tierLimits[userTier] || 10);
          const currentUsage = parseInt(localStorage.getItem(apiUsageKey) || "0", 10);

          if (currentUsage >= maxDailyUses) {
            safetyApiStatusEl.classList.remove("hidden");
            safetyApiIconEl.textContent = "premium";
            safetyApiIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
            safetyApiTextEl.textContent = `Safety API limit reached (${maxDailyUses}/day) - Upgrade for more`;
            return;
          }

          // Generate domain hash (privacy-preserving)
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');
          const domainHash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(domain));
          const hashArray = Array.from(new Uint8Array(domainHash));
          const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

          // Generate JWT token for authentication with user context
          const jwtPayload = {
            user_email: userEmail,
            user_tier: userTier,
            is_supporter: isSupporter,
            usage_count: currentUsage + 1,
            max_daily: maxDailyUses,
            domain_hash_prefix: hashHex.substring(0, 8),
            session_id: crypto.randomUUID(),
            client_version: "1.0"
          };

          const jwtToken = await generateJWT(jwtPayload);

          // Enhanced analysis before sending to security API (reuse existing urlObj)
          const path = urlObj.pathname;
          const query = urlObj.search;
          const fragment = urlObj.hash;

          // Advanced phishing pattern detection
          const suspiciousPatterns = [
            // Brand impersonation
            /(?:paypal|apple|microsoft|google|amazon)-?(?:secure|login|signin|account|update|verify)/i,
            /(?:login|signin|secure|account|verify|support)\.(?:paypal|apple|microsoft|google|amazon)/i,

            // Typosquatting
            /(?:paypa1|paypals|go0gle|micr0soft|amaz0n|netflix|faceb00k)/i,

            // Suspicious subdomains
            /(?:login|signin|banking|secure|verify|account|update|support)\./,

            // Levenshtein-like char replacements
            /(?:paypal(?:s|l|\$|\!)|goog(?:l|\$)|microsoft(?:s|\$)|amazon1?|netflix[!1\$]|apple[!1\$])/i,

            // URL shortening or redirect services abused
            /(?:bit\.ly|tinyurl|t\.co|goo\.gl|ow\.ly).*(?:paypal|login|account)/i
          ];

          // Known bad domain fragments
          const badDomainFragments = [
            'paypal-secure-login', 'apple-login', 'microsoft-verify', 'google-security',
            'amazon-confirm', 'netflix-support', 'facebook-security', 'instagram-verify',
            'twitter-confirm', 'linkedin-security', 'ebay-secure', 'walmart-login'
          ];

          // Check for numeric-heavy domains (scam tactic)
          const hasNumericPattern = /\d{4,}/.test(domain.replace(/[-.]/g, ''));
          const hasSuspiciousChars = /([^a-z0-9.-])/i.test(domain);
          const hasMicroDomain = (domain.split('.').length > 3) || (domain.length > 63);

          // Check domain length and fragmentation
          const subdomain = domain.replace(/\.[^.]+$/, '').replace(/^[^\.]+\./, '');
          const hasSuspiciousSubdomain = subdomain.includes('login') || subdomain.includes('secure') ||
                                        subdomain.includes('account') || subdomain.includes('verify');

          // Analyze query parameters for suspicious patterns
          const queryParams = new URLSearchParams(query);
          const hasPhishingQuery = Array.from(queryParams.keys()).some(param =>
            /(?:token|pwd|pass|auth|verify|confirm|reset)/i.test(param)
          );

          // Path analysis - suspicious paths
          const hasSuspiciousPath = /(?:login|signin|verify|account|update)(?:\/|$)/.test(path) ||
                                   path.length > 100 || // Very long paths
                                   path.includes('%') || // Encoded characters
                                   path.match(/\.\w{2,4}$/); // Fake file extensions

          // Check for brand impersonation in hostname
          const brandMatch = /(?:paypal|apple|microsoft|google|amazon|netflix)/i.exec(domain);
          const hasBrandImpersonation = brandMatch && !domain.includes(brandMatch[0].toLowerCase());

          // Update threat score based on multiple factors (variables declared above)
          if (hasSuspiciousChars) { threatScore += 20; suspicionReasons.push("non-standard characters"); }
          if (hasNumericPattern) { threatScore += 15; suspicionReasons.push("numeric pattern"); }
          if (hasMicroDomain) { threatScore += 10; suspicionReasons.push("complex domain"); }
          if (hasSuspiciousSubdomain) { threatScore += 30; suspicionReasons.push("suspicious subdomain"); }
          if (hasPhishingQuery) { threatScore += 20; suspicionReasons.push("phishing query params"); }
          if (hasSuspiciousPath) { threatScore += 15; suspicionReasons.push("suspicious path"); }
          if (hasBrandImpersonation) { threatScore += 50; suspicionReasons.push("brand impersonation"); }

          // Check domain fragments
          if (badDomainFragments.some(fragment => domain.includes(fragment))) {
            threatScore += 80;
            suspicionReasons.push("known bad domain pattern");
          }

          // Check regex patterns
          if (suspiciousPatterns.some(pattern => pattern.test(domain) || pattern.test(url))) {
            threatScore += 60;
            suspicionReasons.push("regex pattern match");
          }

          // Call Safety API through LinkAura proxy
          const result = await callLinkAuraAPI("url-safety", {
            url: url, // Send the original URL to security service
            domain_hash: hashHex,
            domain_length: domain.length,
            has_suspicious_chars: hasSuspiciousChars,

            // Enhanced data for pattern matching
            domain: domain,
            subdomain: subdomain,
            path: path,
            query_params_count: queryParams.toString().length,
            has_numerics: hasNumericPattern,
            has_suspicious_subdomain: hasSuspiciousSubdomain,
            has_phishing_query: hasPhishingQuery,
            has_suspicious_path: hasSuspiciousPath,
            has_brand_impersonation: hasBrandImpersonation,

            // Calculated threat score and reasons
            threat_score: threatScore,
            suspicion_reasons: suspicionReasons,
            high_risk: threatScore > 50,
            medium_risk: threatScore > 20 && threatScore <= 50,

            timestamp: new Date().toISOString(),
            client_version: "1.0"
          });

          // Increment usage counter
          const newUsage = currentUsage + 1;
          localStorage.setItem(apiUsageKey, newUsage.toString());

          safetyApiStatusEl.classList.remove("hidden");

          // Process the safety verdict
          const verdict = result.verdict || result.status;
          const confidence = result.confidence || result.score;

          switch (verdict?.toLowerCase()) {
            case "safe":
            case "clean":
            case "verified":
              safetyApiIconEl.textContent = "verified_user";
              safetyApiIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
              safetyApiTextEl.textContent = "Verified safe by community database";
              break;

            case "suspicious":
            case "warning":
              safetyApiIconEl.textContent = "warning";
              safetyApiIconEl.className = "material-symbols-outlined text-base text-orange-500 dark:text-orange-400";
              safetyApiTextEl.textContent = "Suspicious - exercise caution";
              break;

            case "malicious":
            case "dangerous":
            case "reported":
              safetyApiIconEl.textContent = "dangerous";
              safetyApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
              safetyApiTextEl.textContent = "Malicious site detected";
              break;

            case "unknown":
            case "unchecked":
            default:
              safetyApiIconEl.textContent = "help";
              safetyApiIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
              safetyApiTextEl.textContent = "Safety status unknown";
              break;
          }

          // Increment usage counter on success
          const updatedUsage = usage + 1;
          localStorage.setItem("cleanlink_usage", updatedUsage.toString());

          // Hide progress bar on success
          hideProgress();

        } catch (error) {
          console.error('Safety API error:', error);
          safetyApiStatusEl.classList.remove("hidden");
          safetyApiIconEl.textContent = "error";
          safetyApiIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          safetyApiTextEl.textContent = "Could not verify safety";

          // Hide progress bar on error
          hideProgress();
        }
      }

      async function checkWebSecScan(url) {
        // Check if user is a donor/supporter
        const supporterToken = localStorage.getItem("cleanlink_supporter_token");
        const supporterExpiry = localStorage.getItem("cleanlink_supporter_expiry");
        const supporterStatus = await checkSupporterStatus(supporterToken, supporterExpiry);
        
        // Use the main usage counter for all premium features
        const isDonor = supporterStatus.isValid;
        const MAX_FREE_CLEANS = supporterStatus.apiCalls;
        const usageKey = "cleanlink_usage", dateKey = "cleanlink_date";
        const today = new Date().toDateString();
        const storedDate = localStorage.getItem(dateKey);
        let currentUsage = parseInt(localStorage.getItem(usageKey) || "0", 10);
        
        if (storedDate !== today) {
          currentUsage = 0;
          localStorage.setItem(dateKey, today);
          localStorage.setItem(usageKey, "0");
        }
        
        if (currentUsage >= MAX_FREE_CLEANS) {
          const webSecStatusEl = document.createElement("div");
          webSecStatusEl.id = "webSecScanStatus";
          webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";
          webSecStatusEl.innerHTML = `
            <span class="material-symbols-outlined text-base text-amber-500 dark:text-amber-400">premium</span>
            <span>Premium feature limit reached (${MAX_FREE_CLEANS}/day) - Upgrade for more</span>
          `;
          document.getElementById("resultWrap").appendChild(webSecStatusEl);
          return;
        }

        try {
          // Show progress bar
          const progressEl = document.getElementById("analysisProgress");
          const progressBarEl = document.getElementById("progressBar");
          const progressTextEl = document.getElementById("progressText");

          if (progressEl) {
            progressEl.classList.remove("hidden");
            progressTextEl.textContent = "Initializing security scanner...";
            progressBarEl.style.width = "10%";
            animateProgress(progressBarEl, progressTextEl, [
              { width: "10%", text: "Initializing security scanner...", delay: 300 },
              { width: "25%", text: "Configuring audit parameters...", delay: 1000 },
              { width: "40%", text: "Checking SSL/TLS certificates...", delay: 1200 },
              { width: "55%", text: "Analyzing HTTP headers...", delay: 1500 },
              { width: "70%", text: "Scanning for vulnerabilities...", delay: 1800 },
              { width: "85%", text: "Processing security report...", delay: 1200 },
              { width: "95%", text: "Finalizing comprehensive audit...", delay: 800 }
            ]);
          }

          // Get user tier and supporter status
          const userEmail = localStorage.getItem("cleanlink_user_email");
          const userTier = localStorage.getItem("cleanlink_tier") || "free";
          const isSupporter = localStorage.getItem("cleanlink_supporter") === "true";
          const apiUsageKey = `cleanlink_websec_usage_${userTier}`;
          const usageDateKey = "cleanlink_websec_date";
          const today = new Date().toDateString();
          const storedDate = localStorage.getItem(usageDateKey);

          // Reset daily usage if it's a new day
          if (storedDate !== today) {
            localStorage.setItem(apiUsageKey, "0");
            localStorage.setItem(usageDateKey, today);
          }

          // Check tier limits and supporter status (WebSecScan could have different limits)
          const tierLimits = {
            free: 50,  // Fewer scans per day for free users
            pro: 200,
            business: 1000
          };

          const maxDailyUses = isSupporter ? 200 : (tierLimits[userTier] || 10);
          const currentUsage = parseInt(localStorage.getItem(apiUsageKey) || "0", 10);

          if (currentUsage >= maxDailyUses) {
            // Create a status element for WebSecScan
            const webSecStatusEl = document.createElement("div");
            webSecStatusEl.id = "webSecScanStatus";
            webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";
            webSecStatusEl.innerHTML = `
              <span class="material-symbols-outlined text-base text-amber-500 dark:text-amber-400">premium</span>
              <span>WebSecScan limit reached (${maxDailyUses}/day) - Upgrade for more</span>
            `;
            resultWrap.appendChild(webSecStatusEl);
            hideProgress();
            return;
          }

          // Generate domain hash (privacy-preserving)
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');
          const domainHash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(domain));
          const hashArray = Array.from(new Uint8Array(domainHash));
          const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

          // Generate JWT token for authentication
          const jwtPayload = {
            user_email: userEmail,
            user_tier: userTier,
            is_supporter: isSupporter,
            usage_count: currentUsage + 1,
            max_daily: maxDailyUses,
            domain_hash_prefix: hashHex.substring(0, 8),
            session_id: crypto.randomUUID(),
            client_version: "1.0",
            scan_type: "websecscan"  // Flag indicating this is WebSecScan
          };

          const jwtToken = await generateJWT(jwtPayload);

          // Call the WebSecScan endpoint through LinkAura proxy
          const response = await callLinkAuraAPI("websecscan", {
            url: url,
            domain: domain,
            domain_hash: hashHex,
            scan_type: "comprehensive_security_audit",
            include_html_report: true,
            check_headers: true,
            check_ssl_details: true,
            check_security_headers: true,
            check_open_ports: false, // Too slow for web
            check_cookies: true,
            check_mixed_content: true,
            check_vulnerabilities: true,
            timestamp: new Date().toISOString(),
            client_version: "1.0"
          });

          if (response.ok) {
            // Check if response is HTML (for direct display)
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('text/html')) {
              // HTML Response - Display directly in browser
              const htmlContent = await response.text();
              const newWindow = window.open('', '_blank');
              if (newWindow) {
                newWindow.document.write(`
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>WebSecScan Report - ${domain.replace(/[<>\"']/g, '')}</title>
                    <style>
                      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                      .report-header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 20px; margin: -20px -20px 20px -20px; }
                      .report-header h1 { margin: 0; font-size: 24px; }
                      .report-meta { opacity: 0.9; font-size: 14px; margin-top: 5px; }
                      .back-link { display: inline-block; margin-bottom: 20px; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 5px; }
                      .back-link:hover { background: #2563eb; }
                    </style>
                  </head>
                  <body>
                    <div class="report-header">
                      <h1>ðŸ›¡ï¸ WebSecScan Security Report</h1>
                      <div class="report-meta">Domain: ${domain.replace(/[<>\"']/g, '')} | Generated: ${new Date().toLocaleString()}</div>
                    </div>
                    <a href="javascript:window.close()" class="back-link">â† Close Report</a>
                    ${htmlContent}
                  </body>
                  </html>
                `);
                newWindow.document.close();
              } else {
                // Fallback: create HTML element and display inline
                const reportContainer = document.createElement('div');
                reportContainer.innerHTML = `
                  <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; overflow-y: auto; padding: 20px;">
                    <button onclick="this.parentElement.remove()" style="position: fixed; top: 10px; right: 10px; background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">âœ• Close</button>
                    <h1 style="color: #1e3a8a;">WebSecScan Report - ${domain}</h1>
                    <div style="border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-top: 20px;">
                      ${htmlContent}
                    </div>
                  </div>
                `;
                document.body.appendChild(reportContainer);
              }
              
              // Increment main usage counter for all premium features
              const newUsage = currentUsage + 1;
              localStorage.setItem(usageKey, newUsage.toString());
              
              // Update main usage counter display
              const usageCounter = document.getElementById('usageCounter');
              if (usageCounter) {
                const tierName = isDonor ? (supporterStatus.tier === 'champion' ? 'Champion' : supporterStatus.tier === 'coffee' ? 'Coffee' : 'Supporter') : 'Free Plan';
                usageCounter.textContent = `${newUsage}/${MAX_FREE_CLEANS} API calls today (${tierName})`;
              }
            } else {
              // JSON Response - Handle as regular API response
              const result = await response.json();

              // Create status element for WebSecScan
              const webSecStatusEl = document.getElementById("webSecScanStatus") || document.createElement("div");
              webSecStatusEl.id = "webSecScanStatus";
              webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";

              if (result.score >= 80) {
                webSecStatusEl.innerHTML = `
                  <span class="material-symbols-outlined text-base text-green-500 dark:text-green-400">security</span>
                  <span>Security Score: ${result.score}/100 - Secure website</span>
                `;
              } else if (result.score >= 60) {
                webSecStatusEl.innerHTML = `
                  <span class="material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400">warning</span>
                  <span>Security Score: ${result.score}/100 - Moderate security</span>
                `;
              } else {
                webSecStatusEl.innerHTML = `
                  <span class="material-symbols-outlined text-base text-red-500 dark:text-red-400">dangerous</span>
                  <span>Security Score: ${result.score}/100 - Security concerns detected</span>
                `;
              }

              resultWrap.appendChild(webSecStatusEl);
            }

            // Increment main usage counter for all premium features
            const newUsage = currentUsage + 1;
            localStorage.setItem(usageKey, newUsage.toString());
            
            // Update main usage counter display
            const usageCounter = document.getElementById('usageCounter');
            if (usageCounter) {
              const tierName = isDonor ? (supporterStatus.tier === 'champion' ? 'Champion' : supporterStatus.tier === 'coffee' ? 'Coffee' : 'Supporter') : 'Free Plan';
              usageCounter.textContent = `${newUsage}/${MAX_FREE_CLEANS} API calls today (${tierName})`;
            }

            // Hide progress bar on success
            hideProgress();

          } else if (response.status === 401) {
            // JWT authentication failed
            const webSecStatusEl = document.createElement("div");
            webSecStatusEl.id = "webSecScanStatus";
            webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";
            webSecStatusEl.innerHTML = `
              <span class="material-symbols-outlined text-base text-red-500 dark:text-red-400">lock</span>
              <span>WebSecScan authentication failed</span>
            `;
            resultWrap.appendChild(webSecStatusEl);
          } else if (response.status === 429) {
            // Rate limited
            const webSecStatusEl = document.createElement("div");
            webSecStatusEl.id = "webSecScanStatus";
            webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";
            webSecStatusEl.innerHTML = `
              <span class="material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400">hourglass</span>
              <span>Rate limit exceeded - try again later</span>
            `;
            resultWrap.appendChild(webSecStatusEl);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }

        } catch (error) {
          console.error('WebSecScan error:', error);
          const webSecStatusEl = document.getElementById("webSecScanStatus") || document.createElement("div");
          webSecStatusEl.id = "webSecScanStatus";
          webSecStatusEl.className = "mt-3 flex items-center gap-2 text-sm";
          if (error.name === "AbortError") {
            webSecStatusEl.innerHTML = `
              <span class="material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400">schedule</span>
              <span>WebSecScan timed out</span>
            `;
          } else {
            webSecStatusEl.innerHTML = `
              <span class="material-symbols-outlined text-base text-red-500 dark:text-red-400">error</span>
              <span>Could not perform WebSecScan</span>
            `;
          }
          resultWrap.appendChild(webSecStatusEl);

          // Hide progress bar on error
          hideProgress();
        }
      }

      // URL Structure Analysis
      window.checkUrlAnalysis = async function(url) {
        const urlAnalysisStatusEl = document.getElementById("urlAnalysisStatus");
        const urlAnalysisIconEl = document.getElementById("urlAnalysisIcon");
        const urlAnalysisTextEl = document.getElementById("urlAnalysisText");

        if (!urlAnalysisStatusEl) return;

        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');
          
          // Analyze URL structure
          const analysis = {
            subdomainCount: urlObj.hostname.split('.').length - 2,
            parameterCount: urlObj.searchParams.size,
            pathDepth: urlObj.pathname.split('/').length - 1,
            hasShortener: isShortener(urlObj.hostname),
            suspiciousPatterns: detectSuspiciousPatterns(url),
            domainLength: domain.length,
            hasNumericPattern: /\d{4,}/.test(domain.replace(/[-.]/g, '')),
            hasSuspiciousChars: /([^a-z0-9.-])/i.test(domain)
          };

          urlAnalysisStatusEl.classList.remove("hidden");

          // Determine risk level
          let riskLevel = "low";
          let riskText = "URL structure looks normal";
          let riskIcon = "verified";
          let riskColor = "text-green-500 dark:text-green-400";

          if (analysis.hasShortener) {
            riskLevel = "medium";
            riskText = "URL shortener detected - destination unknown";
            riskIcon = "warning";
            riskColor = "text-yellow-500 dark:text-yellow-400";
          } else if (analysis.subdomainCount > 3 || analysis.parameterCount > 10) {
            riskLevel = "medium";
            riskText = "Complex URL structure - may contain tracking";
            riskIcon = "warning";
            riskColor = "text-yellow-500 dark:text-yellow-400";
          } else if (analysis.hasNumericPattern || analysis.hasSuspiciousChars) {
            riskLevel = "high";
            riskText = "Suspicious URL patterns detected";
            riskIcon = "dangerous";
            riskColor = "text-red-500 dark:text-red-400";
          }

          urlAnalysisIconEl.textContent = riskIcon;
          urlAnalysisIconEl.className = `material-symbols-outlined text-base ${riskColor}`;
          urlAnalysisTextEl.textContent = riskText;

        } catch (error) {
          urlAnalysisStatusEl.classList.remove("hidden");
          urlAnalysisIconEl.textContent = "error";
          urlAnalysisIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
          urlAnalysisTextEl.textContent = "URL analysis failed";
        }
      };

      // Language Detection
      window.checkLanguageDetection = async function(url) {
        const languageDetectionStatusEl = document.getElementById("languageDetectionStatus");
        const languageDetectionIconEl = document.getElementById("languageDetectionIcon");
        const languageDetectionTextEl = document.getElementById("languageDetectionText");

        if (!languageDetectionStatusEl) return;

        const isPrivacy = document.getElementById("privacyToggle")?.checked;
        if (isPrivacy) {
          languageDetectionStatusEl.classList.remove("hidden");
          languageDetectionIconEl.textContent = "privacy_tip";
          languageDetectionIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          languageDetectionTextEl.textContent = "Privacy mode active";
          return;
        }

        try {
          languageDetectionStatusEl.classList.remove("hidden");
          languageDetectionIconEl.textContent = "schedule";
          languageDetectionIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          languageDetectionTextEl.textContent = "Detecting language...";

          // Use LinkAura API to fetch and analyze page (bypasses CORS)
          const result = await callLinkAuraAPI("language-detection", { url: url });

          if (result.error || result.offline) {
            throw new Error(result.error || "API unavailable");
          }

          const detectedLang = result.language || result.detectedLang || 'Unknown';
          const confidence = result.confidence || 'Medium';

          languageDetectionIconEl.textContent = "translate";
          languageDetectionIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          languageDetectionTextEl.innerHTML = `Language: <strong>${detectedLang}</strong> (${confidence} confidence)`;

        } catch (error) {
          console.error("Language detection error:", error);
          languageDetectionStatusEl.classList.remove("hidden");
          languageDetectionIconEl.textContent = "help";
          languageDetectionIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          languageDetectionTextEl.textContent = "Language detection unavailable";
        }
      };

      // Accessibility Analysis
      window.checkAccessibilityAnalysis = async function(url) {
        const accessibilityAnalysisStatusEl = document.getElementById("accessibilityAnalysisStatus");
        const accessibilityAnalysisIconEl = document.getElementById("accessibilityAnalysisIcon");
        const accessibilityAnalysisTextEl = document.getElementById("accessibilityAnalysisText");
        const accessibilityAnalysisDetailsEl = document.getElementById("accessibilityAnalysisDetails");
        const accessibilityScoreInfoEl = document.getElementById("accessibilityScoreInfo");
        const accessibilityIssuesInfoEl = document.getElementById("accessibilityIssuesInfo");

        if (!accessibilityAnalysisStatusEl) return;

        const isPrivacy = document.getElementById("privacyToggle")?.checked;
        if (isPrivacy) {
          accessibilityAnalysisStatusEl.classList.remove("hidden");
          accessibilityAnalysisIconEl.textContent = "privacy_tip";
          accessibilityAnalysisIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          accessibilityAnalysisTextEl.textContent = "Privacy mode active";
          return;
        }

        try {
          accessibilityAnalysisStatusEl.classList.remove("hidden");
          accessibilityAnalysisIconEl.textContent = "schedule";
          accessibilityAnalysisIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          accessibilityAnalysisTextEl.textContent = "Analyzing accessibility...";

          // Use LinkAura API to fetch and analyze page (bypasses CORS)
          const result = await callLinkAuraAPI("accessibility-analysis", { url: url });

          if (result.error || result.offline) {
            throw new Error(result.error || "API unavailable");
          }

          // Use API results
          let score = result.score || 100;
          let issues = result.issues || [];
          let passed = result.passed || [];
          let readabilityLevel = result.readability || 'Good';
          
          // Ensure score doesn't go below 0
          score = Math.max(0, score);
          
          // Determine overall rating
          let rating = 'Excellent';
          let ratingColor = 'text-green-500 dark:text-green-400';
          let ratingIcon = 'verified';
          
          if (score < 50) {
            rating = 'Poor';
            ratingColor = 'text-red-500 dark:text-red-400';
            ratingIcon = 'error';
          } else if (score < 70) {
            rating = 'Fair';
            ratingColor = 'text-orange-500 dark:text-orange-400';
            ratingIcon = 'warning';
          } else if (score < 85) {
            rating = 'Good';
            ratingColor = 'text-blue-500 dark:text-blue-400';
            ratingIcon = 'info';
          }
          
          // Update UI
          accessibilityAnalysisIconEl.textContent = ratingIcon;
          accessibilityAnalysisIconEl.className = `material-symbols-outlined text-base ${ratingColor}`;
          accessibilityAnalysisTextEl.innerHTML = `Accessibility: <strong>${rating}</strong> (Score: ${score}/100) <span class="text-xs cursor-pointer" onclick="document.getElementById('accessibilityAnalysisDetails').classList.toggle('hidden')">â–¼ Details</span>`;
          
          // Build details
          let detailsHTML = `
            <div class="mb-3">
              <div class="text-slate-700 dark:text-slate-300 font-semibold mb-1">Score: ${score}/100 (${rating})</div>
              <div class="text-slate-600 dark:text-slate-400 text-xs mb-2">Readability: ${readabilityLevel}</div>
            </div>
          `;
          
          if (issues.length > 0) {
            detailsHTML += `
              <div class="mb-3">
                <div class="text-red-600 dark:text-red-400 font-semibold mb-1 text-xs">Issues Found (${issues.length}):</div>
                <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 text-xs space-y-1">
                  ${issues.map(issue => `<li>${issue}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          if (passed.length > 0) {
            detailsHTML += `
              <div>
                <div class="text-green-600 dark:text-green-400 font-semibold mb-1 text-xs">Passed Checks (${passed.length}):</div>
                <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 text-xs space-y-1">
                  ${passed.map(check => `<li>${check}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          accessibilityAnalysisDetailsEl.innerHTML = detailsHTML;
          accessibilityAnalysisDetailsEl.classList.remove("hidden");

        } catch (error) {
          console.error("Accessibility analysis error:", error);
          accessibilityAnalysisStatusEl.classList.remove("hidden");
          accessibilityAnalysisIconEl.textContent = "help";
          accessibilityAnalysisIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          accessibilityAnalysisTextEl.textContent = "Accessibility analysis unavailable";
        }
      };

      // Cookie & Tracking Analysis
      window.checkCookieTrackingAnalysis = async function(url) {
        const cookieTrackingAnalysisStatusEl = document.getElementById("cookieTrackingAnalysisStatus");
        const cookieTrackingAnalysisIconEl = document.getElementById("cookieTrackingAnalysisIcon");
        const cookieTrackingAnalysisTextEl = document.getElementById("cookieTrackingAnalysisText");
        const cookieTrackingAnalysisDetailsEl = document.getElementById("cookieTrackingAnalysisDetails");
        const cookieTrackingSummaryEl = document.getElementById("cookieTrackingSummary");
        const cookieTrackingCookiesEl = document.getElementById("cookieTrackingCookies");
        const cookieTrackingScriptsEl = document.getElementById("cookieTrackingScripts");
        const cookieTrackingPixelsEl = document.getElementById("cookieTrackingPixels");
        const cookieTrackingRecommendationsEl = document.getElementById("cookieTrackingRecommendations");

        if (!cookieTrackingAnalysisStatusEl) return;

        const isPrivacy = document.getElementById("privacyToggle")?.checked;
        if (isPrivacy) {
          cookieTrackingAnalysisStatusEl.classList.remove("hidden");
          cookieTrackingAnalysisIconEl.textContent = "privacy_tip";
          cookieTrackingAnalysisIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          cookieTrackingAnalysisTextEl.textContent = "Privacy mode active";
          return;
        }

        try {
          cookieTrackingAnalysisStatusEl.classList.remove("hidden");
          cookieTrackingAnalysisIconEl.textContent = "schedule";
          cookieTrackingAnalysisIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          cookieTrackingAnalysisTextEl.textContent = "Analyzing cookies and tracking...";

          // Use LinkAura API to fetch and analyze page (bypasses CORS)
          const result = await callLinkAuraAPI("cookie-tracking-analysis", { url: url });

          if (result.error || result.offline) {
            throw new Error(result.error || "API unavailable");
          }

          const privacyScore = result.privacyScore || 100;
          const privacyRating = result.privacyRating || 'Excellent';
          const summary = result.summary || {};
          const cookies = result.cookies || [];
          const trackingScripts = result.trackingScripts || [];
          const trackingPixels = result.trackingPixels || [];
          const recommendations = result.recommendations || [];

          // Determine rating color and icon
          let ratingColor = 'text-green-500 dark:text-green-400';
          let ratingIcon = 'verified';
          
          if (privacyRating === 'Poor') {
            ratingColor = 'text-red-500 dark:text-red-400';
            ratingIcon = 'error';
          } else if (privacyRating === 'Fair') {
            ratingColor = 'text-orange-500 dark:text-orange-400';
            ratingIcon = 'warning';
          } else if (privacyRating === 'Good') {
            ratingColor = 'text-blue-500 dark:text-blue-400';
            ratingIcon = 'info';
          }

          // Update UI
          cookieTrackingAnalysisIconEl.textContent = ratingIcon;
          cookieTrackingAnalysisIconEl.className = `material-symbols-outlined text-base ${ratingColor}`;
          cookieTrackingAnalysisTextEl.innerHTML = `Privacy: <strong>${privacyRating}</strong> (Score: ${privacyScore}/100) <span class="text-xs cursor-pointer" onclick="document.getElementById('cookieTrackingAnalysisDetails').classList.toggle('hidden')">â–¼ Details</span>`;

          // Build summary
          let summaryHTML = `
            <div class="mb-3">
              <div class="text-slate-700 dark:text-slate-300 font-semibold mb-2">Privacy Score: ${privacyScore}/100 (${privacyRating})</div>
              <div class="text-slate-600 dark:text-slate-400 text-xs grid grid-cols-2 gap-2">
                <div><strong>Total Cookies:</strong> ${summary.totalCookies || 0}</div>
                <div><strong>Tracking Cookies:</strong> ${summary.trackingCookies || 0}</div>
                <div><strong>Tracking Scripts:</strong> ${summary.totalTrackingScripts || 0}</div>
                <div><strong>Tracking Pixels:</strong> ${summary.totalTrackingPixels || 0}</div>
              </div>
              ${summary.trackingByType ? `
                <div class="mt-2 text-xs">
                  <div class="text-slate-600 dark:text-slate-400 mb-1"><strong>By Type:</strong></div>
                  <div class="text-slate-500 dark:text-slate-500">
                    ${summary.trackingByType.Analytics ? `Analytics: ${summary.trackingByType.Analytics} â€¢ ` : ''}
                    ${summary.trackingByType.Advertising ? `Advertising: ${summary.trackingByType.Advertising} â€¢ ` : ''}
                    ${summary.trackingByType['Social Media'] ? `Social Media: ${summary.trackingByType['Social Media']} â€¢ ` : ''}
                    ${summary.trackingByType['Session Recording'] ? `Session Recording: ${summary.trackingByType['Session Recording']}` : ''}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
          cookieTrackingSummaryEl.innerHTML = summaryHTML;

          // Build cookies list
          if (cookies.length > 0) {
            let cookiesHTML = `
              <div class="mb-3">
                <div class="text-red-600 dark:text-red-400 font-semibold mb-1 text-xs">Cookies Found (${cookies.length}):</div>
                <div class="max-h-40 overflow-y-auto space-y-1">
            `;
            
            cookies.forEach(cookie => {
              const riskColor = cookie.privacyRisk === 'High' ? 'text-red-600 dark:text-red-400' : 
                               cookie.privacyRisk === 'Medium' ? 'text-orange-600 dark:text-orange-400' : 
                               'text-green-600 dark:text-green-400';
              const typeBadge = cookie.type === 'Tracking' ? '<span class="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-1 rounded text-xs">Tracking</span>' :
                               cookie.type === 'Authentication' ? '<span class="bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-1 rounded text-xs">Auth</span>' :
                               '<span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-1 rounded text-xs">Functional</span>';
              
              cookiesHTML += `
                <div class="text-xs border-l-2 ${riskColor} pl-2 py-1">
                  <div class="flex items-center gap-2">
                    <strong>${cookie.name}</strong> ${typeBadge}
                  </div>
                  <div class="text-slate-500 dark:text-slate-400 text-xs mt-1">
                    ${cookie.secure ? 'ðŸ”’ Secure' : 'âš ï¸ Not Secure'} â€¢ 
                    ${cookie.httpOnly ? 'ðŸ” HttpOnly' : ''} â€¢ 
                    SameSite: ${cookie.sameSite} â€¢ 
                    ${cookie.persistent ? 'Persistent' : 'Session'}
                  </div>
                </div>
              `;
            });
            
            cookiesHTML += `</div></div>`;
            cookieTrackingCookiesEl.innerHTML = cookiesHTML;
          } else {
            cookieTrackingCookiesEl.innerHTML = `
              <div class="mb-3">
                <div class="text-green-600 dark:text-green-400 font-semibold mb-1 text-xs">Cookies: None detected</div>
              </div>
            `;
          }

          // Build tracking scripts list
          if (trackingScripts.length > 0) {
            let scriptsHTML = `
              <div class="mb-3">
                <div class="text-red-600 dark:text-red-400 font-semibold mb-1 text-xs">Tracking Scripts Found (${trackingScripts.length}):</div>
                <div class="max-h-40 overflow-y-auto space-y-1">
            `;
            
            trackingScripts.forEach(script => {
              const privacyColor = script.privacy === 'High' ? 'text-red-600 dark:text-red-400' : 
                                  script.privacy === 'Medium' ? 'text-orange-600 dark:text-orange-400' : 
                                  'text-green-600 dark:text-green-400';
              
              scriptsHTML += `
                <div class="text-xs border-l-2 ${privacyColor} pl-2 py-1">
                  <div class="flex items-center gap-2">
                    <strong>${script.name}</strong> 
                    <span class="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-1 rounded text-xs">${script.type}</span>
                    <span class="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-1 rounded text-xs">${script.privacy} Risk</span>
                  </div>
                  ${script.source ? `<div class="text-slate-500 dark:text-slate-400 text-xs mt-1">Source: ${script.source}</div>` : ''}
                  ${script.url ? `<div class="text-slate-500 dark:text-slate-400 text-xs mt-1 break-all">${script.url}</div>` : ''}
                </div>
              `;
            });
            
            scriptsHTML += `</div></div>`;
            cookieTrackingScriptsEl.innerHTML = scriptsHTML;
          } else {
            cookieTrackingScriptsEl.innerHTML = `
              <div class="mb-3">
                <div class="text-green-600 dark:text-green-400 font-semibold mb-1 text-xs">Tracking Scripts: None detected</div>
              </div>
            `;
          }

          // Build tracking pixels list
          if (trackingPixels.length > 0) {
            let pixelsHTML = `
              <div class="mb-3">
                <div class="text-red-600 dark:text-red-400 font-semibold mb-1 text-xs">Tracking Pixels Found (${trackingPixels.length}):</div>
                <div class="max-h-40 overflow-y-auto space-y-1">
            `;
            
            trackingPixels.forEach(pixel => {
              const privacyColor = pixel.privacy === 'High' ? 'text-red-600 dark:text-red-400' : 
                                  pixel.privacy === 'Medium' ? 'text-orange-600 dark:text-orange-400' : 
                                  'text-green-600 dark:text-green-400';
              
              pixelsHTML += `
                <div class="text-xs border-l-2 ${privacyColor} pl-2 py-1">
                  <div class="flex items-center gap-2">
                    <strong>${pixel.name}</strong> 
                    <span class="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-1 rounded text-xs">${pixel.type}</span>
                  </div>
                  <div class="text-slate-500 dark:text-slate-400 text-xs mt-1 break-all">${pixel.url}</div>
                </div>
              `;
            });
            
            pixelsHTML += `</div></div>`;
            cookieTrackingPixelsEl.innerHTML = pixelsHTML;
          } else {
            cookieTrackingPixelsEl.innerHTML = `
              <div class="mb-3">
                <div class="text-green-600 dark:text-green-400 font-semibold mb-1 text-xs">Tracking Pixels: None detected</div>
              </div>
            `;
          }

          // Build recommendations
          if (recommendations.length > 0) {
            let recommendationsHTML = `
              <div>
                <div class="text-blue-600 dark:text-blue-400 font-semibold mb-1 text-xs">Privacy Recommendations:</div>
                <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 text-xs space-y-1">
                  ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
              </div>
            `;
            cookieTrackingRecommendationsEl.innerHTML = recommendationsHTML;
          } else {
            cookieTrackingRecommendationsEl.innerHTML = `
              <div>
                <div class="text-green-600 dark:text-green-400 font-semibold mb-1 text-xs">No recommendations - Privacy practices look good!</div>
              </div>
            `;
          }

          cookieTrackingAnalysisDetailsEl.classList.remove("hidden");

        } catch (error) {
          console.error("Cookie & tracking analysis error:", error);
          cookieTrackingAnalysisStatusEl.classList.remove("hidden");
          cookieTrackingAnalysisIconEl.textContent = "help";
          cookieTrackingAnalysisIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          cookieTrackingAnalysisTextEl.textContent = "Cookie & tracking analysis unavailable";
        }
      };

      // WHOIS Check
      window.checkWhoisCheck = async function(url) {
        const whoisCheckStatusEl = document.getElementById("whoisCheckStatus");
        const whoisCheckIconEl = document.getElementById("whoisCheckIcon");
        const whoisCheckTextEl = document.getElementById("whoisCheckText");
        const whoisCheckDetailsEl = document.getElementById("whoisCheckDetails");
        const whoisSummaryEl = document.getElementById("whoisSummary");
        const whoisDomainInfoEl = document.getElementById("whoisDomainInfo");
        const whoisContactsEl = document.getElementById("whoisContacts");
        const whoisServersEl = document.getElementById("whoisServers");

        if (!whoisCheckStatusEl) return;

        const isPrivacy = document.getElementById("privacyToggle")?.checked;
        if (isPrivacy) {
          whoisCheckStatusEl.classList.remove("hidden");
          whoisCheckIconEl.textContent = "privacy_tip";
          whoisCheckIconEl.className = "material-symbols-outlined text-base text-amber-500 dark:text-amber-400";
          whoisCheckTextEl.textContent = "Privacy mode active";
          return;
        }

        try {
          whoisCheckStatusEl.classList.remove("hidden");
          whoisCheckIconEl.textContent = "schedule";
          whoisCheckIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          whoisCheckTextEl.textContent = "Checking WHOIS data...";

          // Extract domain from URL
          let domain;
          try {
            const urlObj = new URL(url.startsWith('http') ? url : `https://${url}`);
            domain = urlObj.hostname.replace('www.', '');
          } catch (e) {
            domain = url.replace('www.', '').toLowerCase();
          }

          // Call WHOIS API through worker proxy (no auth required)
          const whoisResponse = await fetch('https://api.linkaura.blankburn.online/whois-check', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ domain })
          });

          if (!whoisResponse.ok) {
            const errorData = await whoisResponse.json().catch(() => ({}));
            throw new Error(errorData.error || 'WHOIS service unavailable');
          }

          const result = await whoisResponse.json();

          if (result.error || !result.success) {
            throw new Error(result.error || 'WHOIS check failed');
          }

          // Update UI
          whoisCheckIconEl.textContent = result.warning ? "warning" : "info";
          whoisCheckIconEl.className = `material-symbols-outlined text-base ${result.warning ? 'text-orange-500 dark:text-orange-400' : 'text-green-500 dark:text-green-400'}`;
          
          // Show message if available
          if (result.message) {
            whoisCheckTextEl.innerHTML = `WHOIS: <strong>${result.domain || domain}</strong> - ${result.message}`;
          } else {
            whoisCheckTextEl.innerHTML = `WHOIS: <strong>${result.domain || domain}</strong> <span class="text-xs cursor-pointer" onclick="document.getElementById('whoisCheckDetails').classList.toggle('hidden')">â–¼ Details</span>`;
          }

          // Build summary
          let summaryHTML = `
            <div class="mb-3">
              <div class="text-slate-700 dark:text-slate-300 font-semibold mb-2">Domain Information</div>
              ${result.message ? `<div class="text-orange-600 dark:text-orange-400 text-xs mb-2 p-2 bg-orange-50 dark:bg-orange-900/20 rounded">${result.message}</div>` : ''}
              ${result.registrar ? `<div class="text-slate-600 dark:text-slate-400 text-xs mb-1"><strong>Registrar:</strong> ${result.registrar}</div>` : ''}
              ${result.domainAge ? `
                <div class="text-slate-600 dark:text-slate-400 text-xs mb-1">
                  <strong>Domain Age:</strong> ${result.domainAge.years} years, ${result.domainAge.months} months (${result.domainAge.days} days)
                </div>
              ` : ''}
              ${result.expiryStatus ? `
                <div class="text-slate-600 dark:text-slate-400 text-xs mb-1">
                  <strong>Expiry Status:</strong> 
                  <span class="${result.expiryStatus.isExpired ? 'text-red-600 dark:text-red-400' : result.expiryStatus.daysUntilExpiry < 30 ? 'text-orange-600 dark:text-orange-400' : 'text-green-600 dark:text-green-400'}">
                    ${result.expiryStatus.daysUntilExpiryFormatted}
                  </span>
                </div>
              ` : ''}
            </div>
          `;
          whoisSummaryEl.innerHTML = summaryHTML;

          // Build domain info
          let domainInfoHTML = `
            <div class="mb-3">
              <div class="text-slate-700 dark:text-slate-300 font-semibold mb-2">Registration Dates</div>
              <div class="text-slate-600 dark:text-slate-400 text-xs space-y-1">
                ${result.registrationDate ? `<div><strong>Registered:</strong> ${new Date(result.registrationDate).toLocaleDateString()}</div>` : '<div class="text-slate-400 dark:text-slate-500">Not available</div>'}
                ${result.expirationDate ? `<div><strong>Expires:</strong> ${new Date(result.expirationDate).toLocaleDateString()}</div>` : '<div class="text-slate-400 dark:text-slate-500">Not available</div>'}
                ${result.updatedDate ? `<div><strong>Last Updated:</strong> ${new Date(result.updatedDate).toLocaleDateString()}</div>` : ''}
              </div>
            </div>
          `;
          
          if (result.status && result.status.length > 0) {
            domainInfoHTML += `
              <div class="mb-3">
                <div class="text-slate-700 dark:text-slate-300 font-semibold mb-1 text-xs">Status</div>
                <div class="text-slate-600 dark:text-slate-400 text-xs">
                  ${result.status.map(s => `<span class="bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-1 rounded mr-1">${s}</span>`).join(' ')}
                </div>
              </div>
            `;
          }
          
          whoisDomainInfoEl.innerHTML = domainInfoHTML;

          // Build contacts info - only show if we have contact data
          let contactsHTML = '';
          if (result.registrant || result.administrativeContact || result.technicalContact) {
            contactsHTML = `
              <div class="mb-3">
                <div class="text-slate-700 dark:text-slate-300 font-semibold mb-2">Contact Information</div>
                <div class="text-slate-600 dark:text-slate-400 text-xs space-y-2">
            `;
            
            if (result.registrant) {
              contactsHTML += `
                <div class="border-l-2 border-blue-500 pl-2">
                  <div class="font-semibold mb-1">Registrant</div>
                  ${result.registrant.name ? `<div><strong>Name:</strong> ${result.registrant.name}</div>` : ''}
                  ${result.registrant.organization ? `<div><strong>Organization:</strong> ${result.registrant.organization}</div>` : ''}
                  ${result.registrant.email ? `<div><strong>Email:</strong> ${result.registrant.email}</div>` : ''}
                  ${result.registrant.country ? `<div><strong>Country:</strong> ${result.registrant.country}</div>` : ''}
                  ${result.registrant.city ? `<div><strong>City:</strong> ${result.registrant.city}</div>` : ''}
                </div>
              `;
            }
            
            if (result.administrativeContact) {
              contactsHTML += `
                <div class="border-l-2 border-green-500 pl-2">
                  <div class="font-semibold mb-1">Administrative Contact</div>
                  ${result.administrativeContact.name ? `<div><strong>Name:</strong> ${result.administrativeContact.name}</div>` : ''}
                  ${result.administrativeContact.organization ? `<div><strong>Organization:</strong> ${result.administrativeContact.organization}</div>` : ''}
                  ${result.administrativeContact.email ? `<div><strong>Email:</strong> ${result.administrativeContact.email}</div>` : ''}
                  ${result.administrativeContact.country ? `<div><strong>Country:</strong> ${result.administrativeContact.country}</div>` : ''}
                </div>
              `;
            }
            
            if (result.technicalContact) {
              contactsHTML += `
                <div class="border-l-2 border-orange-500 pl-2">
                  <div class="font-semibold mb-1">Technical Contact</div>
                  ${result.technicalContact.name ? `<div><strong>Name:</strong> ${result.technicalContact.name}</div>` : ''}
                  ${result.technicalContact.organization ? `<div><strong>Organization:</strong> ${result.technicalContact.organization}</div>` : ''}
                  ${result.technicalContact.email ? `<div><strong>Email:</strong> ${result.technicalContact.email}</div>` : ''}
                  ${result.technicalContact.country ? `<div><strong>Country:</strong> ${result.technicalContact.country}</div>` : ''}
                </div>
              `;
            }
            
            contactsHTML += `</div></div>`;
          }
          whoisContactsEl.innerHTML = contactsHTML || '<div class="text-slate-500 dark:text-slate-400 text-xs">Contact information not available</div>';

          // Build name servers info
          if (result.nameServers && result.nameServers.length > 0) {
            let serversHTML = `
              <div class="mb-3">
                <div class="text-slate-700 dark:text-slate-300 font-semibold mb-1 text-xs">Name Servers (${result.nameServers.length})</div>
                <div class="text-slate-600 dark:text-slate-400 text-xs space-y-1">
                  ${result.nameServers.map(ns => `<div class="font-mono">${ns}</div>`).join('')}
                </div>
              </div>
            `;
            whoisServersEl.innerHTML = serversHTML;
          } else if (result.dnsInfo?.nameServers && result.dnsInfo.nameServers.length > 0) {
            // Fallback to dnsInfo name servers
            let serversHTML = `
              <div class="mb-3">
                <div class="text-slate-700 dark:text-slate-300 font-semibold mb-1 text-xs">Name Servers (${result.dnsInfo.nameServers.length})</div>
                <div class="text-slate-600 dark:text-slate-400 text-xs space-y-1">
                  ${result.dnsInfo.nameServers.map(ns => `<div class="font-mono">${ns}</div>`).join('')}
                </div>
              </div>
            `;
            whoisServersEl.innerHTML = serversHTML;
          } else {
            whoisServersEl.innerHTML = '<div class="text-slate-500 dark:text-slate-400 text-xs">Name servers not available</div>';
          }
          
          // Show DNS info if available (only if we have name servers from DNS)
          if (result.dnsInfo && (result.dnsInfo.nameServers?.length > 0 || result.dnsInfo.primaryNameServer)) {
            let dnsInfoHTML = '';
            if (result.dnsInfo.primaryNameServer || result.dnsInfo.adminEmail) {
              dnsInfoHTML = `
                <div class="mb-3">
                  <div class="text-slate-700 dark:text-slate-300 font-semibold mb-1 text-xs">DNS Information</div>
                  <div class="text-slate-600 dark:text-slate-400 text-xs space-y-1">
                    ${result.dnsInfo.primaryNameServer ? `<div><strong>Primary NS:</strong> <span class="font-mono">${result.dnsInfo.primaryNameServer}</span></div>` : ''}
                    ${result.dnsInfo.adminEmail ? `<div><strong>Admin Email:</strong> <span class="font-mono">${result.dnsInfo.adminEmail}</span></div>` : ''}
                  </div>
                </div>
              `;
            }
            if (dnsInfoHTML) {
              whoisServersEl.innerHTML = dnsInfoHTML + whoisServersEl.innerHTML;
            }
          }

          // Show details if we have meaningful data or a message
          if (result.message || result.registrar || result.registrationDate || result.nameServers?.length > 0) {
            whoisCheckDetailsEl.classList.remove("hidden");
          }

        } catch (error) {
          console.error("WHOIS check error:", error);
          whoisCheckStatusEl.classList.remove("hidden");
          whoisCheckIconEl.textContent = "help";
          whoisCheckIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          whoisCheckTextEl.textContent = "WHOIS check unavailable";
        }
      };

      // Geographic & CDN Analysis
      window.checkGeographicAnalysis = async function(url) {
        const geographicApiStatusEl = document.getElementById("geographicApiStatus");
        const geographicApiIconEl = document.getElementById("geographicApiIcon");
        const geographicApiTextEl = document.getElementById("geographicApiText");
        const geographicAnalysisStatusEl = document.getElementById("geographicAnalysisStatus");
        const geographicAnalysisIconEl = document.getElementById("geographicAnalysisIcon");
        const geographicAnalysisTextEl = document.getElementById("geographicAnalysisText");
        const geographicAnalysisDetailsEl = document.getElementById("geographicAnalysisDetails");
        const serverLocationInfoEl = document.getElementById("serverLocationInfo");
        const cdnInfoEl = document.getElementById("cdnInfo");
        const mapContainerEl = document.getElementById("mapContainer");

        if (!geographicAnalysisStatusEl) return;

        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');
          
          // Show API status immediately (like Shortened URL Detection)
          geographicApiStatusEl.classList.remove("hidden");
          geographicApiIconEl.textContent = "location_searching";
          geographicApiIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          geographicApiTextEl.textContent = "Geographic API - Analyzing location...";

          // Show analysis status
          geographicAnalysisStatusEl.classList.remove("hidden");
          geographicAnalysisIconEl.textContent = "schedule";
          geographicAnalysisIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          geographicAnalysisTextEl.textContent = "Analyzing geographic location and CDN...";

          // Get IP address and geolocation data
          const ipData = await getIpGeolocation(domain);
          
          if (ipData) {
            // Update API status - success
            geographicApiIconEl.textContent = "verified";
            geographicApiIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            geographicApiTextEl.textContent = "Geographic API - Location data retrieved";

            // Update analysis status
            geographicAnalysisIconEl.textContent = "location_on";
            geographicAnalysisIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            geographicAnalysisTextEl.textContent = "Geographic analysis complete";
            
            // Show details
            geographicAnalysisDetailsEl.classList.remove("hidden");
            
            // Display server location info
            serverLocationInfoEl.innerHTML = `
              <div class="font-semibold text-slate-900 dark:text-slate-100 mb-1">Server Location</div>
              <div class="text-slate-700 dark:text-slate-300">
                <div><strong>Country:</strong> ${ipData.country || 'Unknown'}</div>
                <div><strong>Region:</strong> ${ipData.regionName || ipData.region || 'Unknown'}</div>
                <div><strong>City:</strong> ${ipData.city || 'Unknown'}</div>
                <div><strong>ISP:</strong> ${ipData.isp || 'Unknown'}</div>
                <div><strong>IP Address:</strong> ${ipData.query || 'Unknown'}</div>
              </div>
            `;
            
            // Detect CDN
            const cdnInfo = detectCDN(domain, ipData);
            cdnInfoEl.innerHTML = `
              <div class="font-semibold text-slate-900 dark:text-slate-100 mb-1">CDN & Hosting</div>
              <div class="text-slate-700 dark:text-slate-300">
                <div><strong>CDN Provider:</strong> ${cdnInfo.provider || 'None detected'}</div>
                <div><strong>Hosting Type:</strong> ${cdnInfo.type || 'Unknown'}</div>
                ${cdnInfo.confidence ? `<div><strong>Confidence:</strong> ${cdnInfo.confidence}%</div>` : ''}
              </div>
            `;
            
            // Show map if coordinates are available
            if (ipData.lat && ipData.lon) {
              mapContainerEl.classList.remove("hidden");
              await showMap(ipData.lat, ipData.lon, ipData.city, ipData.country);
            }
          } else {
            throw new Error("Failed to get geolocation data");
          }

        } catch (error) {
          console.warn("Geographic analysis failed:", error.message);
          
          // Update API status - error
          geographicApiStatusEl.classList.remove("hidden");
          geographicApiIconEl.textContent = "error";
          geographicApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
          geographicApiTextEl.textContent = "Geographic API - Service unavailable";

          // Update analysis status - error
          geographicAnalysisStatusEl.classList.remove("hidden");
          geographicAnalysisIconEl.textContent = "error";
          geographicAnalysisIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
          geographicAnalysisTextEl.textContent = "Geographic analysis failed";
        }
      };

      // Get IP geolocation data via worker proxy
      async function getIpGeolocation(domain) {
        try {
          // Call geolocation API through worker proxy (no auth required)
          const geoResponse = await fetch('https://api.linkaura.blankburn.online/api/geolocation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ domain })
          });
          
          if (geoResponse.ok) {
            const geoData = await geoResponse.json();
            
            if (geoData.status === 'success') {
              return geoData;
            } else {
              throw new Error(geoData.message || 'Geolocation service failed');
            }
          } else {
            const errorData = await geoResponse.json();
            throw new Error(errorData.error || 'Geolocation service unavailable');
          }
        } catch (error) {
          console.warn("Geolocation API failed:", error);
          return null;
        }
      }

      // Detect CDN provider
      function detectCDN(domain, ipData) {
        const cdnPatterns = {
          'Cloudflare': /cloudflare/i,
          'Amazon CloudFront': /cloudfront/i,
          'AWS': /amazonaws/i,
          'Google Cloud CDN': /googleusercontent|googleapis/i,
          'Azure CDN': /azure|microsoft/i,
          'Fastly': /fastly/i,
          'KeyCDN': /keycdn/i,
          'MaxCDN': /maxcdn/i,
          'Incapsula': /incapsula/i,
          'Akamai': /akamai/i,
          'CDN77': /cdn77/i,
          'BunnyCDN': /bunnycdn/i,
          'StackPath': /stackpath/i
        };

        const hostingPatterns = {
          'Shared Hosting': /shared|hosting/i,
          'VPS': /vps|virtual/i,
          'Dedicated Server': /dedicated/i,
          'Cloud Hosting': /cloud|aws|azure|gcp/i
        };

        let detectedCDN = null;
        let detectedHosting = null;
        let confidence = 0;

        // Check domain patterns
        for (const [provider, pattern] of Object.entries(cdnPatterns)) {
          if (pattern.test(domain) || pattern.test(ipData.org || '') || pattern.test(ipData.isp || '')) {
            detectedCDN = provider;
            confidence = 85;
            break;
          }
        }

        // Check hosting type
        for (const [type, pattern] of Object.entries(hostingPatterns)) {
          if (pattern.test(ipData.org || '') || pattern.test(ipData.isp || '')) {
            detectedHosting = type;
            break;
          }
        }

        // If no CDN detected, check for common hosting providers
        if (!detectedCDN) {
          const hostingProviders = {
            'GoDaddy': /godaddy/i,
            'Bluehost': /bluehost/i,
            'HostGator': /hostgator/i,
            'SiteGround': /siteground/i,
            'DigitalOcean': /digitalocean/i,
            'Linode': /linode/i,
            'Vultr': /vultr/i,
            'Hetzner': /hetzner/i
          };

          for (const [provider, pattern] of Object.entries(hostingProviders)) {
            if (pattern.test(ipData.org || '') || pattern.test(ipData.isp || '')) {
              detectedHosting = provider;
              confidence = 70;
              break;
            }
          }
        }

        return {
          provider: detectedCDN,
          type: detectedHosting || 'Unknown',
          confidence: confidence || (detectedCDN ? 85 : 0)
        };
      }

      // Show map with server location
      async function showMap(lat, lon, city, country) {
        const mapEl = document.getElementById("map");
        
        try {
          // Create a simple map using OpenStreetMap
          const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.1},${lat-0.1},${lon+0.1},${lat+0.1}&layer=mapnik&marker=${lat},${lon}`;
          
          mapEl.innerHTML = `
            <iframe 
              src="${mapUrl}" 
              width="100%" 
              height="100%" 
              style="border: none; border-radius: 0.5rem;"
              title="Server location map">
            </iframe>
          `;
        } catch (error) {
          mapEl.innerHTML = `
            <div class="text-center">
              <div class="text-slate-500 dark:text-slate-400 mb-2">ðŸ“</div>
              <div class="text-sm">Server located in ${city}, ${country}</div>
              <div class="text-xs text-slate-400 dark:text-slate-500">Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)}</div>
            </div>
          `;
        }
      }

      // Link Expiration Check
      window.checkLinkExpiration = async function(url) {
        const linkExpirationStatusEl = document.getElementById("linkExpirationStatus");
        const linkExpirationIconEl = document.getElementById("linkExpirationIcon");
        const linkExpirationTextEl = document.getElementById("linkExpirationText");

        if (!linkExpirationStatusEl) return;

        try {
          // Check if it's a shortened URL
          const urlObj = new URL(url);
          const isShortened = isShortener(urlObj.hostname);
          
          if (!isShortened) {
            linkExpirationStatusEl.classList.remove("hidden");
            linkExpirationIconEl.textContent = "verified";
            linkExpirationIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            linkExpirationTextEl.textContent = "Direct link - no expiration risk";
            return;
          }

          // For shortened URLs, try to check if they're still valid
          try {
            const response = await fetch(url, { 
              method: 'HEAD', 
              mode: 'no-cors',
              timeout: 5000 
            });
            
            linkExpirationStatusEl.classList.remove("hidden");
            linkExpirationIconEl.textContent = "verified";
            linkExpirationIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
            linkExpirationTextEl.textContent = "Shortened link appears active";
            
          } catch (error) {
            linkExpirationStatusEl.classList.remove("hidden");
            linkExpirationIconEl.textContent = "warning";
            linkExpirationIconEl.className = "material-symbols-outlined text-base text-orange-500 dark:text-orange-400";
            linkExpirationTextEl.textContent = "Shortened link may be expired or broken";
          }

        } catch (error) {
          linkExpirationStatusEl.classList.remove("hidden");
          linkExpirationIconEl.textContent = "error";
          linkExpirationIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
          linkExpirationTextEl.textContent = "Could not check link expiration";
        }
      };

      // Social Media Detection
      window.checkSocialMedia = async function(url) {
        const socialDetectionStatusEl = document.getElementById("socialDetectionStatus");
        const socialDetectionIconEl = document.getElementById("socialDetectionIcon");
        const socialDetectionTextEl = document.getElementById("socialDetectionText");

        if (!socialDetectionStatusEl) return;

        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.toLowerCase().replace('www.', '');
          
          const socialPlatforms = {
            'facebook.com': 'Facebook',
            'fb.com': 'Facebook',
            'twitter.com': 'Twitter',
            'x.com': 'Twitter/X',
            'instagram.com': 'Instagram',
            'linkedin.com': 'LinkedIn',
            'youtube.com': 'YouTube',
            'youtu.be': 'YouTube',
            'tiktok.com': 'TikTok',
            'snapchat.com': 'Snapchat',
            'pinterest.com': 'Pinterest',
            'reddit.com': 'Reddit',
            'discord.com': 'Discord',
            'telegram.org': 'Telegram',
            'whatsapp.com': 'WhatsApp'
          };

          const detectedPlatform = socialPlatforms[domain] || null;

          socialDetectionStatusEl.classList.remove("hidden");

          if (detectedPlatform) {
            socialDetectionIconEl.textContent = "share";
            socialDetectionIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
            socialDetectionTextEl.textContent = `Social media platform: ${detectedPlatform}`;
          } else {
            socialDetectionIconEl.textContent = "language";
            socialDetectionIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
            socialDetectionTextEl.textContent = "Regular website - not a social media platform";
          }

        } catch (error) {
          socialDetectionStatusEl.classList.remove("hidden");
          socialDetectionIconEl.textContent = "error";
          socialDetectionIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
          socialDetectionTextEl.textContent = "Social media detection failed";
        }
      };

      // URL Validation & Repair
      window.checkUrlValidation = async function(url) {
        const urlValidationStatusEl = document.getElementById("urlValidationStatus");
        const urlValidationIconEl = document.getElementById("urlValidationIcon");
        const urlValidationTextEl = document.getElementById("urlValidationText");

        if (!urlValidationStatusEl) return;

        try {
          const validation = validateAndRepairUrl(url);
          
          urlValidationStatusEl.classList.remove("hidden");

          if (validation.isValid) {
            if (validation.wasRepaired) {
              urlValidationIconEl.textContent = "build";
              urlValidationIconEl.className = "material-symbols-outlined text-base text-yellow-500 dark:text-yellow-400";
              urlValidationTextEl.textContent = `URL repaired: ${validation.repairs.join(', ')}`;
            } else {
              urlValidationIconEl.textContent = "verified";
              urlValidationIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
              urlValidationTextEl.textContent = "URL format is valid";
            }
          } else {
            urlValidationIconEl.textContent = "error";
            urlValidationIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
            urlValidationTextEl.textContent = `Invalid URL: ${validation.errors.join(', ')}`;
          }

        } catch (error) {
          urlValidationStatusEl.classList.remove("hidden");
          urlValidationIconEl.textContent = "error";
          urlValidationIconEl.className = "material-symbols-outlined text-base text-slate-500 dark:text-slate-400";
          urlValidationTextEl.textContent = "Could not validate URL";
        }
      };

      // URL Validation Helper Function
      function validateAndRepairUrl(input) {
        const result = {
          isValid: false,
          wasRepaired: false,
          repairs: [],
          errors: [],
          originalUrl: input,
          repairedUrl: input
        };

        if (!input || typeof input !== 'string') {
          result.errors.push('Empty or invalid input');
          return result;
        }

        let url = input.trim();

        // Common repairs
        const repairs = [];

        // Add protocol if missing
        if (!url.match(/^https?:\/\//i)) {
          url = 'https://' + url;
          repairs.push('Added HTTPS protocol');
        }

        // Fix common typos in protocols
        url = url.replace(/^http:\/\/\//, 'http://');
        url = url.replace(/^https:\/\/\//, 'https://');
        url = url.replace(/^http:\/\/https:\/\//, 'https://');
        url = url.replace(/^https:\/\/http:\/\//, 'http://');

        // Fix double slashes in path (but preserve protocol)
        url = url.replace(/([^:]\/)\/+/g, '$1');

        // Remove trailing dots and spaces
        url = url.replace(/[.\s]+$/, '');

        // Fix common domain typos
        const domainFixes = {
          'gogle.com': 'google.com',
          'youtbe.com': 'youtube.com',
          'facebok.com': 'facebook.com',
          'twiter.com': 'twitter.com',
          'linkdin.com': 'linkedin.com',
          'githb.com': 'github.com',
          'amazn.com': 'amazon.com',
          'wikipdia.org': 'wikipedia.org'
        };

        for (const [wrong, correct] of Object.entries(domainFixes)) {
          if (url.includes(wrong)) {
            url = url.replace(wrong, correct);
            repairs.push(`Fixed domain typo: ${wrong} â†’ ${correct}`);
          }
        }

        // Validate the URL
        try {
          const urlObj = new URL(url);
          
          // Additional validations
          if (!urlObj.hostname) {
            result.errors.push('Missing hostname');
            return result;
          }

          if (urlObj.hostname.length < 3) {
            result.errors.push('Hostname too short');
            return result;
          }

          if (urlObj.hostname.includes('..')) {
            result.errors.push('Invalid hostname format');
            return result;
          }

          // Check for valid TLD
          const tldPattern = /\.[a-z]{2,}$/i;
          if (!tldPattern.test(urlObj.hostname)) {
            result.errors.push('Invalid or missing top-level domain');
            return result;
          }

          result.isValid = true;
          result.wasRepaired = repairs.length > 0;
          result.repairs = repairs;
          result.repairedUrl = url;

        } catch (error) {
          result.errors.push('Invalid URL format');
        }

        return result;
      }

      // Helper functions
      function isShortener(hostname) {
        const shorteners = [
          // Popular shorteners
          'bit.ly', 'tinyurl.com', 't.co', 'goo.gl', 'ow.ly', 'short.link',
          'is.gd', 'v.gd', 'buff.ly', 'rebrand.ly', 'shorturl.at', 'cutt.ly',
          'tiny.cc', 'short.cm', 'adf.ly', 'bit.do', 'shorte.st',
          'short.ly', 'shorturl.com', 'bitly.com', 'clck.ru',
          // Social media shorteners
          'fb.me', 'fb.com', 'youtu.be', 'youtube.com',
          // Additional common shorteners
          'short.link', 'shorturl.at', 'cutt.ly', 'short.ly', 'shorturl.com',
          'short.cm', 'short.ly', 'shorturl.at', 'cutt.ly'
        ];
        return shorteners.some(shortener => hostname.includes(shortener));
      }

      // URL Expansion function - Privacy-Safe Server-Side Proxy
      async function expandShortenedUrl(url) {
        try {
          const response = await fetch('https://api.linkaura.blankburn.online/api/expand-url', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url })
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.expandedUrl && data.expandedUrl !== url) {
              return data.expandedUrl;
            }
          }
          
          return url;
          
        } catch (error) {
          return url;
        }
      }

      function detectSuspiciousPatterns(url) {
        const suspiciousPatterns = [
          /(?:login|signin|banking|secure|verify|account|update|support)\./i,
          /(?:paypal(?:s|l|\$|\!)|goog(?:l|\$)|microsoft(?:s|\$)|amazon1?|netflix[!1\$]|apple[!1\$])/i,
          /(?:bit\.ly|tinyurl|t\.co|goo\.gl|ow\.ly).*(?:paypal|login|account)/i
        ];
        
        return suspiciousPatterns.some(pattern => pattern.test(url));
      }

      // Shortened URL Detection and Expansion
      window.checkShortenedUrl = async function(url) {
        const shortenerApiStatusEl = document.getElementById("shortenerApiStatus");
        const shortenerApiIconEl = document.getElementById("shortenerApiIcon");
        const shortenerApiTextEl = document.getElementById("shortenerApiText");
        const shortenerWarningStatusEl = document.getElementById("shortenerWarningStatus");
        const shortenerWarningIconEl = document.getElementById("shortenerWarningIcon");
        const shortenerWarningTextEl = document.getElementById("shortenerWarningText");
        const shortenerOriginalUrlEl = document.getElementById("shortenerOriginalUrl");
        const expandShortenedUrlBtn = document.getElementById("expandShortenedUrlBtn");

        if (!shortenerWarningStatusEl) return;

        try {
          const urlObj = new URL(url);
          const isShortened = isShortener(urlObj.hostname);
          
          if (!isShortened) {
            shortenerApiStatusEl.classList.add("hidden");
            shortenerWarningStatusEl.classList.add("hidden");
            return;
          }

          // Show API status when shortened URL is detected
          shortenerApiStatusEl.classList.remove("hidden");
          shortenerApiIconEl.textContent = "link";
          shortenerApiIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400";
          shortenerApiTextEl.textContent = "Shortened URL detected - click to expand";

          // Show warning for shortened URL
          shortenerWarningStatusEl.classList.remove("hidden");
          shortenerWarningIconEl.textContent = "warning";
          shortenerWarningTextEl.textContent = "Shortened URL detected - destination unknown";
          shortenerOriginalUrlEl.textContent = "";

          // Set up expand button functionality
          expandShortenedUrlBtn.onclick = async () => {
            try {
              expandShortenedUrlBtn.disabled = true;
              expandShortenedUrlBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1 animate-spin">refresh</span>Expanding...';
              
              // Update API status during processing
              shortenerApiIconEl.textContent = "hourglass";
              shortenerApiIconEl.className = "material-symbols-outlined text-base text-blue-500 dark:text-blue-400 animate-spin";
              shortenerApiTextEl.textContent = "Expanding URL...";
              
              const expandedUrl = await expandShortenedUrl(url);
              
              if (expandedUrl !== url) {
                // Success - show API success status
                shortenerApiIconEl.textContent = "check_circle";
                shortenerApiIconEl.className = "material-symbols-outlined text-base text-green-500 dark:text-green-400";
                shortenerApiTextEl.textContent = "URL expanded successfully";

                shortenerOriginalUrlEl.textContent = expandedUrl;
                shortenerWarningTextEl.textContent = "Original URL revealed:";
                shortenerWarningIconEl.textContent = "verified";
                expandShortenedUrlBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1">check</span>Expanded';
                expandShortenedUrlBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-700");
                expandShortenedUrlBtn.classList.add("bg-green-600", "hover:bg-green-700");
                
                // Update the main result URL with the expanded URL
                const resultUrl = document.getElementById("resultUrl");
                if (resultUrl) {
                  resultUrl.textContent = expandedUrl;
                }
              } else {
                // API not available - show API error status
                shortenerApiIconEl.textContent = "error";
                shortenerApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
                shortenerApiTextEl.textContent = "Could not expand URL";

                shortenerWarningTextEl.textContent = "Could not expand URL - API not available";
                shortenerWarningIconEl.textContent = "warning";
                expandShortenedUrlBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1">info</span>API Required';
                expandShortenedUrlBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-700");
                expandShortenedUrlBtn.classList.add("bg-orange-600", "hover:bg-orange-700");
                expandShortenedUrlBtn.disabled = false;
                
                // Show helpful message about API requirement
                shortenerOriginalUrlEl.innerHTML = `
                  <div class="text-orange-600 text-xs space-y-1">
                    <p>URL expansion requires the LinkAura API to be deployed and accessible.</p>
                    <div class="flex gap-2 mt-2">
                      <button onclick="window.open('${url}', '_blank')" class="bg-orange-100 hover:bg-orange-200 text-orange-800 text-xs px-2 py-1 rounded">
                        Open in New Tab
                      </button>
                      <button onclick="navigator.clipboard.writeText('${url}')" class="bg-orange-100 hover:bg-orange-200 text-orange-800 text-xs px-2 py-1 rounded">
                        Copy URL
                      </button>
                    </div>
                  </div>
                `;
              }
            } catch (error) {
              // API error - show API error status
              shortenerApiIconEl.textContent = "error";
              shortenerApiIconEl.className = "material-symbols-outlined text-base text-red-500 dark:text-red-400";
              shortenerApiTextEl.textContent = "URL expansion failed";

              shortenerWarningTextEl.textContent = "Failed to expand URL";
              shortenerWarningIconEl.textContent = "error";
              expandShortenedUrlBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1">error</span>Failed';
              expandShortenedUrlBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-700");
              expandShortenedUrlBtn.classList.add("bg-red-600", "hover:bg-red-700");
            }
          };

        } catch (error) {
          shortenerApiStatusEl.classList.add("hidden");
          shortenerWarningStatusEl.classList.add("hidden");
        }
      };

      // URL History Management
      window.saveToHistory = function(originalUrl, cleanedUrl, analysisData = {}) {
        try {
          const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
          const urlObj = new URL(cleanedUrl);
          const domain = urlObj.hostname;
          
          // Determine URL type
          let urlType = 'other';
          if (domain.includes('facebook.com') || domain.includes('twitter.com') || domain.includes('instagram.com') || 
              domain.includes('linkedin.com') || domain.includes('tiktok.com') || domain.includes('youtube.com')) {
            urlType = 'social';
          } else if (domain.includes('bit.ly') || domain.includes('tinyurl.com') || domain.includes('t.co') || 
                     domain.includes('goo.gl') || domain.includes('ow.ly') || domain.includes('short.link')) {
            urlType = 'shortener';
          } else if (domain.includes('amazon.com') || domain.includes('ebay.com') || domain.includes('shopify.com') || 
                     domain.includes('etsy.com') || domain.includes('alibaba.com')) {
            urlType = 'ecommerce';
          } else if (domain.includes('cnn.com') || domain.includes('bbc.com') || domain.includes('reuters.com') || 
                     domain.includes('nytimes.com') || domain.includes('washingtonpost.com')) {
            urlType = 'news';
          }
          
          // Calculate parameters removed
          const originalParams = new URL(originalUrl).searchParams;
          const cleanedParams = new URL(cleanedUrl).searchParams;
          const paramsRemoved = originalParams.size - cleanedParams.size;
          
          const historyItem = {
            original: originalUrl,
            cleaned: cleanedUrl,
            timestamp: Date.now(),
            domain: domain,
            urlType: urlType,
            paramsRemoved: paramsRemoved,
            securityScore: analysisData.securityScore || null,
            language: analysisData.language || null,
            accessibilityScore: analysisData.accessibilityScore || null,
            isShortener: analysisData.isShortener || false,
            expandedUrl: analysisData.expandedUrl || null,
            title: analysisData.title || null,
            description: analysisData.description || null
          };
          
          // Add to beginning and limit to 100 items
          history.unshift(historyItem);
          const limitedHistory = history.slice(0, 100);
          
          localStorage.setItem('linkaura_history', JSON.stringify(limitedHistory));
          updateHistoryDisplay();
          window.updateHistoryButtonVisibility();
        } catch (error) {
          console.error('Failed to save to history:', error);
        }
      }

      // Global variables for filtering
      let currentPage = 1;
      const itemsPerPage = 10;
      let filteredHistory = [];

      window.updateHistoryDisplay = function() {
        try {
          const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
          const historyList = document.getElementById('historyList');
          const historyWrap = document.getElementById('historyWrap');
          const resultsCount = document.getElementById('resultsCount');
          
          if (!historyList) return;
          
          // Apply filters
          filteredHistory = applyFilters(history);
          
          // Update results count
          if (resultsCount) {
            resultsCount.textContent = `Showing ${filteredHistory.length} of ${history.length} URLs`;
          }
          
          if (filteredHistory.length === 0) {
            historyList.innerHTML = '<li class="text-slate-500 dark:text-slate-400 text-sm text-center py-4">No URLs found matching your criteria</li>';
            updatePagination(0);
            return;
          }
          
          // Apply pagination
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const paginatedHistory = filteredHistory.slice(startIndex, endIndex);
          
          historyList.innerHTML = '';
          
          paginatedHistory.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 hover:shadow-sm transition-shadow';
            
            // Create type badge
            const typeBadge = getTypeBadge(item.urlType);
            
            // Create security score indicator
            const securityIndicator = item.securityScore ? 
              `<span class="text-xs px-2 py-1 rounded-full ${getSecurityScoreClass(item.securityScore)}">${item.securityScore}/100</span>` : '';
            
            // Create parameters removed indicator
            const paramsIndicator = item.paramsRemoved > 0 ? 
              `<span class="text-xs text-green-600 dark:text-green-400">-${item.paramsRemoved} params</span>` : '';
            
            const timeAgo = getTimeAgo(item.timestamp);
            const domain = item.domain.replace('www.', '');
            
            li.innerHTML = `
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <input type="checkbox" class="history-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" 
                  data-url="${item.cleaned}" data-original="${item.original}" data-timestamp="${item.timestamp}">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="text-slate-900 dark:text-white font-medium truncate">${item.cleaned}</div>
                    ${typeBadge}
                    ${securityIndicator}
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-2">
                    <span>${domain}</span>
                    <span>â€¢</span>
                    <span>${timeAgo}</span>
                    ${paramsIndicator}
                  </div>
                  ${item.title ? `<div class="text-xs text-slate-600 dark:text-slate-300 mt-1 truncate">${item.title}</div>` : ''}
                </div>
              </div>
              <div class="flex items-center gap-1 ml-2">
                <button onclick="copyToClipboard('${item.cleaned}')" class="p-1 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" title="Copy">
                  <span class="material-symbols-outlined text-sm">content_copy</span>
                </button>
                <button onclick="openUrl('${item.cleaned}')" class="p-1 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" title="Open">
                  <span class="material-symbols-outlined text-sm">open_in_new</span>
                </button>
                <button onclick="removeFromHistory(${item.timestamp})" class="p-1 text-slate-500 hover:text-red-500 dark:text-slate-400 dark:hover:text-red-400" title="Remove">
                  <span class="material-symbols-outlined text-sm">close</span>
                </button>
              </div>
            `;
            
            historyList.appendChild(li);
          });
          
          updatePagination(filteredHistory.length);
          
          // Add event listeners for checkboxes
          addCheckboxListeners();
        } catch (error) {
          console.error('Failed to update history display:', error);
        }
      }

      // Apply filters to history
      function applyFilters(history) {
        let filtered = [...history];
        
        // Search filter
        const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
        if (searchTerm) {
          filtered = filtered.filter(item => 
            item.cleaned.toLowerCase().includes(searchTerm) ||
            item.original.toLowerCase().includes(searchTerm) ||
            item.domain.toLowerCase().includes(searchTerm) ||
            (item.title && item.title.toLowerCase().includes(searchTerm)) ||
            (item.description && item.description.toLowerCase().includes(searchTerm))
          );
        }
        
        // Date filter
        const dateFilter = document.getElementById('dateFilter')?.value || 'all';
        if (dateFilter !== 'all') {
          const now = Date.now();
          const oneDay = 24 * 60 * 60 * 1000;
          const oneWeek = 7 * oneDay;
          const oneMonth = 30 * oneDay;
          
          filtered = filtered.filter(item => {
            const itemDate = item.timestamp;
            switch (dateFilter) {
              case 'today':
                return (now - itemDate) < oneDay;
              case 'week':
                return (now - itemDate) < oneWeek;
              case 'month':
                return (now - itemDate) < oneMonth;
              case 'custom':
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                if (startDate && endDate) {
                  const start = new Date(startDate).getTime();
                  const end = new Date(endDate).getTime() + oneDay - 1;
                  return itemDate >= start && itemDate <= end;
                }
                return true;
              default:
                return true;
            }
          });
        }
        
        // Domain filter
        const domainFilter = document.getElementById('domainFilter')?.value || 'all';
        if (domainFilter !== 'all') {
          filtered = filtered.filter(item => item.domain === domainFilter);
        }
        
        // Type filter
        const typeFilter = document.getElementById('typeFilter')?.value || 'all';
        if (typeFilter !== 'all') {
          filtered = filtered.filter(item => item.urlType === typeFilter);
        }
        
        // Sort
        const sortFilter = document.getElementById('sortFilter')?.value || 'newest';
        filtered.sort((a, b) => {
          switch (sortFilter) {
            case 'newest':
              return b.timestamp - a.timestamp;
            case 'oldest':
              return a.timestamp - b.timestamp;
            case 'domain':
              return a.domain.localeCompare(b.domain);
            case 'domain-desc':
              return b.domain.localeCompare(a.domain);
            case 'security':
              return (b.securityScore || 0) - (a.securityScore || 0);
            default:
              return b.timestamp - a.timestamp;
          }
        });
        
        return filtered;
      }

      // Helper functions
      function getTypeBadge(type) {
        const badges = {
          social: '<span class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">Social</span>',
          shortener: '<span class="text-xs px-2 py-1 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300">Shortener</span>',
          ecommerce: '<span class="text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">E-commerce</span>',
          news: '<span class="text-xs px-2 py-1 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">News</span>',
          other: '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">Other</span>'
        };
        return badges[type] || badges.other;
      }

      function getSecurityScoreClass(score) {
        if (score >= 80) return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
        if (score >= 60) return 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
        return 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
      }

      function updatePagination(totalItems) {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;
        
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        if (totalPages <= 1) {
          pagination.innerHTML = '';
          return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
          class="px-3 py-1 text-sm rounded-lg ${currentPage === 1 ? 'bg-gray-100 dark:bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}">Previous</button>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `<button onclick="changePage(${i})" 
              class="px-3 py-1 text-sm rounded-lg ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += '<span class="px-2 text-slate-500">...</span>';
          }
        }
        
        // Next button
        paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
          class="px-3 py-1 text-sm rounded-lg ${currentPage === totalPages ? 'bg-gray-100 dark:bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}">Next</button>`;
        
        pagination.innerHTML = paginationHTML;
      }

      function changePage(page) {
        const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          updateHistoryDisplay();
        }
      }

      function openUrl(url) {
        window.open(url, '_blank');
      }

      // Update history item with analysis data
      window.updateHistoryItem = function(timestamp, analysisData) {
        try {
          const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
          const itemIndex = history.findIndex(item => item.timestamp === timestamp);
          
          if (itemIndex !== -1) {
            history[itemIndex] = { ...history[itemIndex], ...analysisData };
            localStorage.setItem('linkaura_history', JSON.stringify(history));
            updateHistoryDisplay();
          }
        } catch (error) {
          console.error('Failed to update history item:', error);
        }
      }

      window.getTimeAgo = function(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
      }

      window.removeFromHistory = function(timestamp) {
        try {
          const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
          const filteredHistory = history.filter(item => item.timestamp !== timestamp);
          localStorage.setItem('linkaura_history', JSON.stringify(filteredHistory));
          updateHistoryDisplay();
          window.updateHistoryButtonVisibility();
        } catch (error) {
          console.error('Failed to remove from history:', error);
        }
      }

      window.exportHistory = function() {
        try {
          const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
          const csvContent = [
            'Original URL,Cleaned URL,Domain,Timestamp',
            ...history.map(item => `"${item.original}","${item.cleaned}","${item.domain}",${new Date(item.timestamp).toISOString()}`)
          ].join('\n');
          
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `linkaura-history-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Failed to export history:', error);
          alert('Failed to export history');
        }
      }

      window.copyToClipboard = function(text) {
        if (!text || typeof text !== 'string') {
          console.error('Invalid text provided to copyToClipboard');
          return;
        }
        
        if (!navigator.clipboard) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            showCopySuccess();
          } catch (err) {
            console.error('Fallback copy failed:', err);
          }
          document.body.removeChild(textArea);
          return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
          showCopySuccess();
        }).catch(err => {
          console.error('Failed to copy:', err);
          // Fallback for clipboard API failure
          const textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            showCopySuccess();
          } catch (fallbackErr) {
            console.error('Fallback copy failed:', fallbackErr);
          }
          document.body.removeChild(textArea);
        });
      }
      
      function showCopySuccess() {
        const button = event.target.closest('button');
        if (button) {
          const originalContent = button.innerHTML;
          button.innerHTML = '<span class="material-symbols-outlined text-sm text-green-500">check</span>';
          setTimeout(() => {
            button.innerHTML = originalContent;
          }, 1000);
        }
      }

      // Statistics Dashboard Functions
      function showStatisticsDashboard() {
        const statsModal = document.getElementById('statsModal');
        if (statsModal) {
          statsModal.classList.remove('hidden');
          generateStatistics();
        }
      }

      function hideStatisticsDashboard() {
        const statsModal = document.getElementById('statsModal');
        if (statsModal) {
          statsModal.classList.add('hidden');
        }
      }

      function generateStatistics() {
        const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
        const stats = calculateStatistics(history);
        
        // Update overview cards
        document.getElementById('totalCleans').textContent = stats.totalCleans;
        document.getElementById('uniqueDomains').textContent = stats.uniqueDomains;
        document.getElementById('avgParamsRemoved').textContent = stats.avgParamsRemoved.toFixed(1);
        document.getElementById('securityChecks').textContent = stats.securityChecks;

        // Generate charts
        generateTopDomainsChart(stats.topDomains);
        generateParamTypesChart(stats.paramTypes);
        generateRecentActivityChart(stats.recentActivity);
      }

      function calculateStatistics(history) {
        const stats = {
          totalCleans: history.length,
          uniqueDomains: 0,
          avgParamsRemoved: 0,
          securityChecks: 0,
          topDomains: {},
          paramTypes: {},
          recentActivity: {}
        };

        if (history.length === 0) return stats;

        const domains = new Set();
        let totalParamsRemoved = 0;

        history.forEach(entry => {
          try {
            const originalUrl = new URL(entry.original);
            const cleanedUrl = new URL(entry.cleaned);
            
            // Count domains
            const domain = originalUrl.hostname.replace('www.', '');
            domains.add(domain);
            stats.topDomains[domain] = (stats.topDomains[domain] || 0) + 1;

            // Count parameters removed
            const originalParams = originalUrl.searchParams.size;
            const cleanedParams = cleanedUrl.searchParams.size;
            const paramsRemoved = originalParams - cleanedParams;
            totalParamsRemoved += paramsRemoved;

            // Count parameter types
            originalUrl.searchParams.forEach((value, key) => {
              if (!cleanedUrl.searchParams.has(key)) {
                stats.paramTypes[key] = (stats.paramTypes[key] || 0) + 1;
              }
            });

            // Count security checks (estimate based on features used)
            if (entry.features) {
              stats.securityChecks += Object.values(entry.features).filter(Boolean).length;
            }

            // Recent activity by date
            const date = new Date(entry.timestamp).toDateString();
            stats.recentActivity[date] = (stats.recentActivity[date] || 0) + 1;

          } catch (error) {
            // Skip invalid URLs
          }
        });

        stats.uniqueDomains = domains.size;
        stats.avgParamsRemoved = totalParamsRemoved / history.length;

        return stats;
      }

      function generateTopDomainsChart(topDomains) {
        const chartContainer = document.getElementById('topDomainsChart');
        if (!chartContainer) return;

        const sortedDomains = Object.entries(topDomains)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 10);

        chartContainer.innerHTML = sortedDomains.map(([domain, count]) => {
          const percentage = (count / Object.values(topDomains).reduce((a, b) => a + b, 0)) * 100;
          return `
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-600 dark:text-slate-400 truncate flex-1 mr-2">${domain}</span>
              <div class="flex items-center gap-2">
                <div class="w-20 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                  <div class="bg-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <span class="text-sm font-medium text-slate-900 dark:text-white w-8 text-right">${count}</span>
              </div>
            </div>
          `;
        }).join('') || '<p class="text-sm text-slate-500 dark:text-slate-400">No data available</p>';
      }

      function generateParamTypesChart(paramTypes) {
        const chartContainer = document.getElementById('paramTypesChart');
        if (!chartContainer) return;

        const sortedParams = Object.entries(paramTypes)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 10);

        chartContainer.innerHTML = sortedParams.map(([param, count]) => {
          const percentage = (count / Object.values(paramTypes).reduce((a, b) => a + b, 0)) * 100;
          return `
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-600 dark:text-slate-400 truncate flex-1 mr-2">${param}</span>
              <div class="flex items-center gap-2">
                <div class="w-20 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                  <div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <span class="text-sm font-medium text-slate-900 dark:text-white w-8 text-right">${count}</span>
              </div>
            </div>
          `;
        }).join('') || '<p class="text-sm text-slate-500 dark:text-slate-400">No data available</p>';
      }

      function generateRecentActivityChart(recentActivity) {
        const chartContainer = document.getElementById('recentActivityChart');
        if (!chartContainer) return;

        const sortedActivity = Object.entries(recentActivity)
          .sort(([a], [b]) => new Date(b) - new Date(a))
          .slice(0, 7);

        chartContainer.innerHTML = sortedActivity.map(([date, count]) => {
          const maxCount = Math.max(...Object.values(recentActivity));
          const percentage = (count / maxCount) * 100;
          return `
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-600 dark:text-slate-400">${new Date(date).toLocaleDateString()}</span>
              <div class="flex items-center gap-2">
                <div class="w-24 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                  <div class="bg-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <span class="text-sm font-medium text-slate-900 dark:text-white w-8 text-right">${count}</span>
              </div>
            </div>
          `;
        }).join('') || '<p class="text-sm text-slate-500 dark:text-slate-400">No data available</p>';
      }

      function exportStatistics() {
        const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
        const stats = calculateStatistics(history);
        
        const exportData = {
          generated: new Date().toISOString(),
          overview: {
            totalCleans: stats.totalCleans,
            uniqueDomains: stats.uniqueDomains,
            avgParamsRemoved: stats.avgParamsRemoved,
            securityChecks: stats.securityChecks
          },
          topDomains: stats.topDomains,
          paramTypes: stats.paramTypes,
          recentActivity: stats.recentActivity,
          rawData: history
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `linkaura-statistics-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function resetStatistics() {
        if (confirm('Are you sure you want to reset all statistics? This will clear your URL history and cannot be undone.')) {
          localStorage.removeItem('linkaura_history');
          localStorage.removeItem('linkaura_stats');
          hideStatisticsDashboard();
          updateHistoryDisplay();
          window.updateHistoryButtonVisibility();
          alert('Statistics have been reset.');
        }
      }

      async function checkLimit(){
        // Check supporter status with token validation
        const supporterToken = localStorage.getItem("cleanlink_supporter_token");
        const supporterExpiry = localStorage.getItem("cleanlink_supporter_expiry");
        const currentSupporterStatus = await checkSupporterStatus(supporterToken, supporterExpiry);
        const currentIsDonor = currentSupporterStatus.isValid;
        const currentMaxCleans = currentSupporterStatus.apiCalls;
        
        const today=new Date().toDateString();
        const storedDate=localStorage.getItem(dateKey);
        let usage=parseInt(localStorage.getItem(usageKey)||"0",10);
        if(storedDate!==today){usage=0;localStorage.setItem(dateKey,today);localStorage.setItem(usageKey,"0");}
        if(usage>=currentMaxCleans){showError(`Daily API limit reached (${currentMaxCleans}). Support CleanLink to unlock more API calls.`);return false;}
        usage++;localStorage.setItem(usageKey,usage.toString());
        if(usageCounter)usageCounter.textContent=`${usage}/${currentMaxCleans} API calls today ${currentIsDonor?"(Supporter)":"(Free Plan)"}`;
        return true;
      }

      // Function to run unlimited security checks (not count towards daily limit)
      async function runUnlimitedSecurityChecks(cleaned, preserve) {
        const httpsStatusEl = document.getElementById("httpsStatus");
        if (httpsStatusEl) httpsStatusEl.classList.add("hidden");

        const domainAgeStatusEl = document.getElementById("domainAgeStatus");
        if (domainAgeStatusEl) domainAgeStatusEl.classList.add("hidden");

        const malwareStatusEl = document.getElementById("malwareStatus");
        if (malwareStatusEl) malwareStatusEl.classList.add("hidden");

        const safetyApiStatusEl = document.getElementById("safetyApiStatus");
        if (safetyApiStatusEl) safetyApiStatusEl.classList.add("hidden");

        const shortenerApiStatusEl = document.getElementById("shortenerApiStatus");
        if (shortenerApiStatusEl) shortenerApiStatusEl.classList.add("hidden");

        // Note: Geographic status elements are managed by checkGeographicAnalysis function

        const isPrivacy = privacyToggle.checked;
        const shouldCheckHTTPS = document.getElementById("httpsCheck").checked;
        const shouldCheckSSL = document.getElementById("sslCheck").checked;
        const shouldCheckSslApi = document.getElementById("sslApiCheck").checked;
        const shouldCheckSafetyAPI = document.getElementById("safetyApiCheck").checked;
        const shouldCheckUrlAnalysis = document.getElementById("urlAnalysisCheck").checked;
        const shouldCheckLinkExpiration = document.getElementById("linkExpirationCheck").checked;
        const shouldCheckSocialMedia = document.getElementById("socialDetectionCheck").checked;
        const shouldCheckGeographicAnalysis = document.getElementById("geographicAnalysisCheck").checked;
        const shouldCheckUrlValidation = document.getElementById("urlValidationCheck").checked;
        const shouldCheckLanguageDetection = document.getElementById("languageDetectionCheck").checked;
        const shouldCheckAccessibilityAnalysis = document.getElementById("accessibilityAnalysisCheck").checked;
        const shouldCheckCookieTrackingAnalysis = document.getElementById("cookieTrackingAnalysisCheck")?.checked ?? false;
        const shouldCheckWhoisCheck = document.getElementById("whoisCheckCheck")?.checked ?? false;

        if (shouldCheckHTTPS && !isPrivacy) {
          checkHTTPS(cleaned);
        }

        if (shouldCheckSSL && !isPrivacy) {
          try {
            checkSslCertificate(cleaned);
          } catch {
            // Skip SSL check for invalid URLs
          }
        }

        if (shouldCheckSslApi && !isPrivacy) {
          console.log("ðŸ” SSL API Check triggered for:", cleaned);
          try {
            const sslResult = await checkSslApiCertificate(cleaned);
            updateSslStatus(sslResult);
          } catch (error) {
            console.error("SSL API check error:", error);
            updateSslStatus({ verdict: 'error', message: 'SSL check failed' });
          }
        }


        if (shouldCheckSafetyAPI && !isPrivacy) {
          checkSafetyAPI(cleaned);
        }

        // Handle WebSecScan option
        const shouldCheckWebSecScan = document.getElementById("webSecScanCheck").checked;
        if (shouldCheckWebSecScan && !isPrivacy) {
          checkWebSecScan(cleaned);
        }

        // New free features
        if (shouldCheckUrlAnalysis) {
          checkUrlAnalysis(cleaned);
        }

        if (shouldCheckGeographicAnalysis && !isPrivacy) {
          checkGeographicAnalysis(cleaned);
        }

        if (shouldCheckLinkExpiration) {
          checkLinkExpiration(cleaned);
        }

        if (shouldCheckSocialMedia) {
          checkSocialMedia(cleaned);
        }

        if (shouldCheckUrlValidation) {
          checkUrlValidation(cleaned);
        }

        if (shouldCheckLanguageDetection) {
          checkLanguageDetection(cleaned);
        }

        if (shouldCheckAccessibilityAnalysis) {
          checkAccessibilityAnalysis(cleaned);
        }

        if (shouldCheckCookieTrackingAnalysis) {
          checkCookieTrackingAnalysis(cleaned);
        }

        if (shouldCheckWhoisCheck) {
          checkWhoisCheck(cleaned);
        }

        // Check for shortened URLs if enabled
        const shouldCheckShortener = document.getElementById("shortenerDetectionCheck").checked;
        if (shouldCheckShortener) {
          checkShortenedUrl(cleaned);
        }

        if (!isPrivacy && isAnyApiOptionSelected()) {
          callLinkAuraAPI("ClickCounter", {
            source_domain: (()=>{try{return new URL(cleaned).hostname.replace("www.","")}catch{return "unknown"}})(),
            page: window.location.hostname || "local",
            donor: isDonor,
            usage: localStorage.getItem(usageKey),
            timestamp: new Date().toISOString()
          }).then(result => {
            const el = document.getElementById("globalCounter");
            if (!result || !el) return;
            const count = result.count || result.ClickCounter;
            if (count !== undefined) {
              localStorage.setItem("cleanlink_globalCount", count);
              el.textContent = `${count.toLocaleString()} URLs cleaned so far ðŸš€`;
              el.style.transform = "scale(1.15)";
              setTimeout(() => (el.style.transform = "scale(1)"), 300);
            }
          }).catch(()=>{});
        }
      }

      cleanBtn.addEventListener("click", async () => {
        hideError();
        const raw = urlInput.value.trim();
        if (!raw) return showError("Please paste a URL first.");
        
        // Check if any premium API features are selected
        const hasPremiumFeatures = document.getElementById("safetyApiCheck").checked || 
                                  document.getElementById("sslApiCheck").checked || 
                                  document.getElementById("webSecScanCheck").checked;
        
        // Only check daily limit for premium API features
        if (hasPremiumFeatures && !(await checkLimit())) return;
        
        const preserve = getSelectedParameters();

        try {
          const cleaned = cleanURL(raw, preserve);
          if(resultUrl) resultUrl.textContent = cleaned;
          if(resultWrap) resultWrap.classList.remove("hidden");
          if(qrWrap) qrWrap.classList.remove("hidden");
          renderQR(cleaned);

          // Save to history with analysis data
          const analysisData = {
            securityScore: null, // Will be updated after security checks
            language: null, // Will be updated after language detection
            accessibilityScore: null, // Will be updated after accessibility analysis
            isShortener: false, // Will be updated after shortener detection
            expandedUrl: null, // Will be updated after URL expansion
            title: null, // Will be updated after page analysis
            description: null // Will be updated after page analysis
          };
          saveToHistory(raw, cleaned, analysisData);

          // Run unlimited security checks after URL is cleaned
          await runUnlimitedSecurityChecks(cleaned, preserve);
        } catch {
          showError("Invalid URL.");
        }
      });

      copyBtn.addEventListener("click",async()=>{await navigator.clipboard.writeText(resultUrl.textContent);copyBtn.textContent="Copied!";setTimeout(()=>copyBtn.textContent="Copy",1000)});
      openBtn.addEventListener("click",()=>window.open(resultUrl.textContent,"_blank"));
      shareBtn.addEventListener("click",async()=>{const t=resultUrl.textContent;if(navigator.share)await navigator.share({title:"Clean Link",url:t});else await navigator.clipboard.writeText(t)});
      downloadQRBtn.addEventListener("click",()=>{const c=qrcodeEl.querySelector("canvas");if(!c)return alert("QR not generated yet.");const l=document.createElement("a");l.download="cleanlink-qr.png";l.href=c.toDataURL("image/png");l.click();});

      // History button event listeners
      const clearHistoryBtn = document.getElementById('clearHistoryBtn');
      const exportHistoryBtn = document.getElementById('exportHistoryBtn');
      
      if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to clear all history?')) {
            localStorage.removeItem('linkaura_history');
            updateHistoryDisplay();
            window.updateHistoryButtonVisibility();
          }
        });
      }
      
      if (exportHistoryBtn) {
        exportHistoryBtn.addEventListener('click', exportHistory);
      }

      // Search and Filter Event Listeners
      const historySearch = document.getElementById('historySearch');
      const dateFilter = document.getElementById('dateFilter');
      const domainFilter = document.getElementById('domainFilter');
      const typeFilter = document.getElementById('typeFilter');
      const sortFilter = document.getElementById('sortFilter');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      const customDateRange = document.getElementById('customDateRange');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');

      // Search functionality
      if (historySearch) {
        let searchTimeout;
        historySearch.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentPage = 1;
            updateHistoryDisplay();
          }, 300);
        });
      }

      // Date filter
      if (dateFilter) {
        dateFilter.addEventListener('change', () => {
          currentPage = 1;
          if (dateFilter.value === 'custom') {
            customDateRange.classList.remove('hidden');
          } else {
            customDateRange.classList.add('hidden');
          }
          updateHistoryDisplay();
        });
      }

      // Custom date range
      if (startDate && endDate) {
        [startDate, endDate].forEach(input => {
          input.addEventListener('change', () => {
            if (dateFilter.value === 'custom') {
              currentPage = 1;
              updateHistoryDisplay();
            }
          });
        });
      }

      // Domain filter
      if (domainFilter) {
        domainFilter.addEventListener('change', () => {
          currentPage = 1;
          updateHistoryDisplay();
        });
      }

      // Type filter
      if (typeFilter) {
        typeFilter.addEventListener('change', () => {
          currentPage = 1;
          updateHistoryDisplay();
        });
      }

      // Sort filter
      if (sortFilter) {
        sortFilter.addEventListener('change', () => {
          currentPage = 1;
          updateHistoryDisplay();
        });
      }

      // Clear filters
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          if (historySearch) historySearch.value = '';
          if (dateFilter) dateFilter.value = 'all';
          if (domainFilter) domainFilter.value = 'all';
          if (typeFilter) typeFilter.value = 'all';
          if (sortFilter) sortFilter.value = 'newest';
          if (customDateRange) customDateRange.classList.add('hidden');
          if (startDate) startDate.value = '';
          if (endDate) endDate.value = '';
          currentPage = 1;
          updateHistoryDisplay();
        });
      }

      // Populate domain filter
      function populateDomainFilter() {
        if (!domainFilter) return;
        
        const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
        const domains = [...new Set(history.map(item => item.domain))].sort();
        
        // Clear existing options except "All Domains"
        domainFilter.innerHTML = '<option value="all">All Domains</option>';
        
        domains.forEach(domain => {
          const option = document.createElement('option');
          option.value = domain;
          option.textContent = domain.replace('www.', '');
          domainFilter.appendChild(option);
        });
      }

      // History toggle functionality
      window.updateHistoryButtonVisibility = function() {
        const history = JSON.parse(localStorage.getItem('linkaura_history') || '[]');
        const btn = document.getElementById('historyToggleBtn');
        const historyWrap = document.getElementById('historyWrap');
        
        if (btn) {
          if (history.length > 0) {
            btn.classList.remove('hidden');
            // Keep history section hidden by default - only show when button is clicked
            if (historyWrap) {
              historyWrap.classList.add('hidden');
              historyWrap.style.setProperty('display', 'none', 'important');
              historyWrap.setAttribute('data-history-hidden', 'true');
              btn.innerHTML = '<span class="material-symbols-outlined text-base">history</span><span>View URL History</span>';
            }
          } else {
            btn.classList.add('hidden');
            // Hide the history section if no entries
            if (historyWrap) {
              historyWrap.classList.add('hidden');
              historyWrap.style.setProperty('display', 'none', 'important');
              historyWrap.setAttribute('data-history-hidden', 'true');
              btn.innerHTML = '<span class="material-symbols-outlined text-base">history</span><span>View URL History</span>';
            }
          }
        }
      }
      
      // Set up history toggle event listener after DOM is ready
      let historyToggleSetup = false;
      window.setupHistoryToggle = function() {
        if (historyToggleSetup) return; // Prevent multiple setups
        historyToggleSetup = true;
        
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        const historyWrap = document.getElementById('historyWrap');
        
        if (historyToggleBtn && historyWrap) {
          // Ensure history section starts hidden
          historyWrap.classList.add('hidden');
          historyWrap.style.setProperty('display', 'none', 'important');
          historyWrap.setAttribute('data-history-hidden', 'true');
          
          // Ensure main form section (parent) is always visible
          const mainFormSection = document.getElementById('mainFormSection');
          if (mainFormSection) {
            mainFormSection.classList.remove('hidden');
            mainFormSection.style.setProperty('display', 'block', 'important');
          }
          
          // Remove any existing event listeners by cloning
          const newBtn = historyToggleBtn.cloneNode(true);
          historyToggleBtn.parentNode.replaceChild(newBtn, historyToggleBtn);
          
          // Get fresh reference
          const btn = document.getElementById('historyToggleBtn');
          const wrap = document.getElementById('historyWrap');
          
          // Ensure wrap is still hidden after cloning
          if (wrap) {
            wrap.classList.add('hidden');
            wrap.style.setProperty('display', 'none', 'important');
            wrap.setAttribute('data-history-hidden', 'true');
          }
          
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Check current state - use data attribute as source of truth
            const currentWrap = document.getElementById('historyWrap');
            if (!currentWrap) {
              console.error('historyWrap element not found!');
              return;
            }
            
            // Use data attribute to track visibility state reliably
            const isCurrentlyHidden = currentWrap.getAttribute('data-history-hidden') === 'true' ||
                                     currentWrap.classList.contains('hidden') ||
                                     window.getComputedStyle(currentWrap).display === 'none';
            
            if (isCurrentlyHidden) {
              // Show history section AND Clean URL result section
              // First ensure parent is visible (should always be, but check anyway)
              const parent = currentWrap.parentElement;
              if (parent) {
                const parentDisplay = window.getComputedStyle(parent).display;
                if (parentDisplay === 'none') {
                  parent.classList.remove('hidden');
                  parent.style.setProperty('display', 'block', 'important');
                }
              }
              
              // Show history section
              currentWrap.classList.remove('hidden');
              currentWrap.setAttribute('data-history-hidden', 'false');
              currentWrap.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important;';
              
              // Show Clean URL result section
              const resultWrap = document.getElementById('resultWrap');
              if (resultWrap) {
                resultWrap.classList.remove('hidden');
                resultWrap.style.setProperty('display', 'block', 'important');
              }
              
              btn.innerHTML = '<span class="material-symbols-outlined text-base">history</span><span>Hide URL History</span>';
            } else {
              // Hide history section AND Clean URL result section
              currentWrap.classList.add('hidden');
              currentWrap.setAttribute('data-history-hidden', 'true');
              currentWrap.style.cssText = 'transition: none !important; display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; margin: 0 !important; padding: 0 !important;';
              
              // Hide Clean URL result section
              const resultWrap = document.getElementById('resultWrap');
              if (resultWrap) {
                resultWrap.classList.add('hidden');
                resultWrap.style.setProperty('display', 'none', 'important');
              }
              
              btn.innerHTML = '<span class="material-symbols-outlined text-base">history</span><span>View URL History</span>';
            }
          });
        }
      }
      
      // Call the function with delay to ensure DOM is ready
      setTimeout(() => {
        window.setupHistoryToggle();
      }, 500);

      // Selection functionality
      let selectedUrls = new Set();
      
      function updateSelectionUI() {
        const selectionActions = document.getElementById('selectionActions');
        const selectedCount = document.getElementById('selectedCount');
        
        if (selectedCount) {
          selectedCount.textContent = selectedUrls.size;
        }
        
        if (selectionActions) {
          if (selectedUrls.size > 0) {
            selectionActions.classList.remove('hidden');
          } else {
            selectionActions.classList.add('hidden');
          }
        }
      }

      function handleCheckboxChange(checkbox) {
        const url = checkbox.dataset.url;
        const timestamp = parseInt(checkbox.dataset.timestamp);
        
        if (checkbox.checked) {
          selectedUrls.add({ url, timestamp });
        } else {
          selectedUrls.delete({ url, timestamp });
        }
        
        updateSelectionUI();
      }

      // Add event listeners for checkboxes
      function addCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.history-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => handleCheckboxChange(checkbox));
        });
      }

      // Generate QR for selected URLs
      const generateQRBtn = document.getElementById('generateQRBtn');
      if (generateQRBtn) {
        generateQRBtn.addEventListener('click', () => {
          if (selectedUrls.size === 0) return;
          
          if (selectedUrls.size === 1) {
            // Single URL - generate QR directly
            const selectedUrl = Array.from(selectedUrls)[0];
            generateQRForUrl(selectedUrl.url);
          } else {
            // Multiple URLs - show selection dialog
            showQRSelectionDialog();
          }
        });
      }

      // Re-clean selected URLs
      const recleanBtn = document.getElementById('recleanBtn');
      if (recleanBtn) {
        recleanBtn.addEventListener('click', () => {
          if (selectedUrls.size === 0) return;
          
          if (selectedUrls.size === 1) {
            // Single URL - add to input and clean
            const selectedUrl = Array.from(selectedUrls)[0];
            addUrlToInput(selectedUrl.url);
          } else {
            // Multiple URLs - show selection dialog
            showRecleanSelectionDialog();
          }
        });
      }

      // Clear selection
      const clearSelectionBtn = document.getElementById('clearSelectionBtn');
      if (clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', () => {
          selectedUrls.clear();
          document.querySelectorAll('.history-checkbox').forEach(cb => cb.checked = false);
          updateSelectionUI();
        });
      }

      function generateQRForUrl(url) {
        const qrWrap = document.getElementById('qrWrap');
        const qrcodeEl = document.getElementById('qrcode');
        
        if (qrWrap && qrcodeEl) {
          qrWrap.classList.remove('hidden');
          qrcodeEl.innerHTML = '';
          
          // Generate QR code
          const qr = new QRCode(qrcodeEl, {
            text: url,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
        }
      }

      function addUrlToInput(url) {
        const input = document.getElementById('urlInput');
        if (input) {
          input.value = url;
          input.focus();
          // Trigger the clean button
          const cleanBtn = document.getElementById('cleanBtn');
          if (cleanBtn) {
            cleanBtn.click();
          }
        }
      }

      function showQRSelectionDialog() {
        const urls = Array.from(selectedUrls).map(item => item.url);
        const urlList = urls.map((url, index) => 
          `<div class="flex items-center gap-2 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">
            <input type="radio" name="qrUrl" value="${url}" id="qrUrl${index}" ${index === 0 ? 'checked' : ''}>
            <label for="qrUrl${index}" class="text-sm text-slate-700 dark:text-slate-300 truncate">${url}</label>
          </div>`
        ).join('');
        
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Select URL for QR Code</h3>
            <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
              ${urlList}
            </div>
            <div class="flex gap-2 justify-end">
              <button id="cancelQR" class="px-4 py-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">Cancel</button>
              <button id="generateQR" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Generate QR</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(dialog);
        
        document.getElementById('cancelQR').addEventListener('click', () => {
          document.body.removeChild(dialog);
        });
        
        document.getElementById('generateQR').addEventListener('click', () => {
          const selectedUrl = document.querySelector('input[name="qrUrl"]:checked')?.value;
          if (selectedUrl) {
            generateQRForUrl(selectedUrl);
            document.body.removeChild(dialog);
          }
        });
      }

      function showRecleanSelectionDialog() {
        const urls = Array.from(selectedUrls).map(item => item.url);
        const urlList = urls.map((url, index) => 
          `<div class="flex items-center gap-2 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">
            <input type="radio" name="recleanUrl" value="${url}" id="recleanUrl${index}" ${index === 0 ? 'checked' : ''}>
            <label for="recleanUrl${index}" class="text-sm text-slate-700 dark:text-slate-300 truncate">${url}</label>
          </div>`
        ).join('');
        
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Select URL to Re-clean</h3>
            <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
              ${urlList}
            </div>
            <div class="flex gap-2 justify-end">
              <button id="cancelReclean" class="px-4 py-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">Cancel</button>
              <button id="recleanUrl" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">Re-clean</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(dialog);
        
        document.getElementById('cancelReclean').addEventListener('click', () => {
          document.body.removeChild(dialog);
        });
        
        document.getElementById('recleanUrl').addEventListener('click', () => {
          const selectedUrl = document.querySelector('input[name="recleanUrl"]:checked')?.value;
          if (selectedUrl) {
            addUrlToInput(selectedUrl);
            document.body.removeChild(dialog);
          }
        });
      }

      // Statistics Dashboard
      const showStatsBtn = document.getElementById('showStatsBtn');
      const statsModal = document.getElementById('statsModal');
      const closeStatsBtn = document.getElementById('closeStatsBtn');
      const exportStatsBtn = document.getElementById('exportStatsBtn');
      const resetStatsBtn = document.getElementById('resetStatsBtn');

      if (showStatsBtn) {
        showStatsBtn.addEventListener('click', showStatisticsDashboard);
      }

      if (closeStatsBtn) {
        closeStatsBtn.addEventListener('click', hideStatisticsDashboard);
      }

      if (exportStatsBtn) {
        exportStatsBtn.addEventListener('click', exportStatistics);
      }

      if (resetStatsBtn) {
        resetStatsBtn.addEventListener('click', resetStatistics);
      }

      // Close modal when clicking outside
      if (statsModal) {
        statsModal.addEventListener('click', (e) => {
          if (e.target === statsModal) {
            hideStatisticsDashboard();
          }
        });
      }

      if(isDonor && donorBtn){
        const tierName = supporterStatus.tier === 'champion' ? 'Champion' : supporterStatus.tier === 'coffee' ? 'Coffee' : 'Supporter';
        const apiText = supporterStatus.apiCalls === 999 ? 'unlimited' : `${supporterStatus.apiCalls} cleans/day`;
        donorBtn.textContent=`ðŸŽ‰ ${tierName} mode active (${apiText})`;
        donorBtn.disabled=true;
        donorBtn.classList.add("opacity-70","cursor-default");
      }
      // Bulk URL cleaning functionality
      bulkCleanBtn.addEventListener("click", async () => {
        hideError();
        const rawUrls = bulkInput.value.split('\n').map(u => u.trim()).filter(u => u.length > 0);

        if (!rawUrls.length) {
          return showError("Please paste URLs to clean (one per line).");
        }

        // Check supporter status with token validation
        const supporterToken = localStorage.getItem("cleanlink_supporter_token");
        const supporterExpiry = localStorage.getItem("cleanlink_supporter_expiry");
        const currentSupporterStatus = await checkSupporterStatus(supporterToken, supporterExpiry);
        const currentIsDonor = currentSupporterStatus.isValid;
        const currentMaxCleans = currentSupporterStatus.apiCalls;

        // Check if we have enough cleans remaining
        const totalUsage = parseInt(localStorage.getItem(usageKey) || "0") + rawUrls.length;
        if (totalUsage > currentMaxCleans) {
          return showError(`This would exceed your daily limit (${currentMaxCleans}). You can process ${currentMaxCleans - parseInt(localStorage.getItem(usageKey) || "0")} more URLs.`);
        }

        const preserve = getSelectedParameters();

        const cleanedUrls = [];
        let successCount = 0;

        try {
          for (const rawUrl of rawUrls) {
            try {
              const cleaned = cleanURL(rawUrl, preserve);
              cleanedUrls.push(cleaned);
              successCount++;
            } catch {
              cleanedUrls.push(`âŒ Invalid URL: ${rawUrl}`);
            }
          }

          // Update usage counter for successful cleans
          const currentUsage = parseInt(localStorage.getItem(usageKey) || "0");
          localStorage.setItem(usageKey, (currentUsage + successCount).toString());
          if (usageCounter) usageCounter.textContent = `${currentUsage + successCount}/${currentMaxCleans} API calls today ${currentIsDonor ? "(Supporter)" : "(Free Plan)"}`;

          // Display results
          bulkResultList.innerHTML = cleanedUrls.map(url =>
            `<div class="p-2 bg-white dark:bg-slate-700 rounded break-all">${url}</div>`
          ).join("");
          bulkResultsCount.textContent = `(${successCount} processed)`;
          resultWrap.classList.remove("hidden");
          bulkResults.classList.remove("hidden");

          // Hide elements that don't apply to bulk mode
          document.getElementById("qrWrap").classList.add("hidden");
          document.getElementById("httpsStatus").classList.add("hidden");

          const isPrivacy = privacyToggle.checked;
          if (!isPrivacy && successCount > 0) {
            // Send analytics if ClickCounter endpoint is available
            updateGlobalCounter().catch(() => {
              // Silently handle failure - bulk processing still works
            });
          }

        } catch (error) {
          showError("Error processing URLs. Please try again.");
        }
      });

      // Bulk copy all functionality
      bulkCopyAllBtn.addEventListener("click", async () => {
        const urls = Array.from(bulkResultList.querySelectorAll("div")).map(div => div.textContent).join('\n');
        if (urls) {
          await navigator.clipboard.writeText(urls);
          bulkCopyAllBtn.textContent = "Copied!";
          setTimeout(() => bulkCopyAllBtn.textContent = "Copy All", 1000);
        }
      });

      if(donorBtn)donorBtn.addEventListener("click",()=>{
        showDonationActivationModal();
      });

      // Enhanced Donation Activation Modal with Buy Me a Coffee Integration
      function showDonationActivationModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-xl max-w-lg w-full p-6">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">ðŸµ Support LinkAura</h2>
            <p class="text-slate-600 dark:text-slate-400 text-sm mb-6">
              Support LinkAura on Buy Me a Coffee to unlock premium features! Choose your support level below.
            </p>
            
            <div class="space-y-4 mb-6">
              <div class="p-4 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-yellow-300 dark:hover:border-yellow-600 transition-colors">
                <h3 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                  <span class="text-2xl">â˜•</span>
                  Coffee Supporter
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                  <span class="font-medium text-green-600 dark:text-green-400">â‚¬3</span> â€¢ 10 API calls/day â€¢ 1 month
                </p>
                <a href="https://api.linkaura.blankburn.online/bmc-proxy/linkaura" target="_blank" 
                   class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition transform hover:scale-105">
                  Buy Coffee
                </a>
              </div>
              
              <div class="p-4 border border-amber-200 dark:border-amber-700 rounded-lg hover:border-amber-300 dark:hover:border-amber-600 transition-colors">
                <h3 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                  <span class="text-2xl">â­</span>
                  Supporter
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                  <span class="font-medium text-green-600 dark:text-green-400">â‚¬10</span> â€¢ 50 API calls/day â€¢ 3 months
                </p>
                <a href="https://api.linkaura.blankburn.online/bmc-proxy/linkaura" target="_blank" 
                   class="inline-block bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition transform hover:scale-105">
                  Become Supporter
                </a>
              </div>
              
              <div class="p-4 border border-purple-200 dark:border-purple-700 rounded-lg hover:border-purple-300 dark:hover:border-purple-600 transition-colors">
                <h3 class="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                  <span class="text-2xl">ðŸ†</span>
                  Champion
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                  <span class="font-medium text-green-600 dark:text-green-400">â‚¬25</span> â€¢ Unlimited API calls â€¢ 6 months
                </p>
                <a href="https://api.linkaura.blankburn.online/bmc-proxy/linkaura" target="_blank" 
                   class="inline-block bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition transform hover:scale-105">
                  Become Champion
                </a>
              </div>
            </div>
            
            <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                <span class="font-medium">Already supported?</span> Enter your supporter token below to activate benefits:
              </p>
              <input type="text" id="supporterToken" placeholder="Enter your supporter token" 
                     class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-900 dark:text-white bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-primary/30 focus:border-primary transition mb-3">
              <div class="flex gap-2">
                <button id="verifyTokenBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                  Verify Token
                </button>
                <button id="cancelBtn" class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                  Cancel
                </button>
              </div>
            </div>
            
            <!-- QR Code for Mobile Donations -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-4">
              <div class="text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                  <span class="font-medium">ðŸ“± Mobile Donation</span> Scan QR code to donate on mobile:
                </p>
                <div class="flex justify-center mb-3">
                  <img src="assets/images/bmc_qr.png" 
                       alt="Buy Me a Coffee QR Code" 
                       class="w-32 h-32 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md transition-shadow">
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Scan with your phone camera to open Buy Me a Coffee
                </p>
              </div>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <p class="text-xs text-blue-800 dark:text-blue-200">
                <span class="font-medium">ðŸ’¡ How it works:</span> After supporting on Buy Me a Coffee, you'll receive a supporter token via email. Enter that token above to activate your benefits instantly!
              </p>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Event listeners
        modal.querySelector('#verifyTokenBtn').addEventListener('click', async () => {
          const token = modal.querySelector('#supporterToken').value.trim();
          if (!token) {
            alert('Please enter your supporter token');
            return;
          }
          
          try {
            // Show loading state
            const verifyBtn = modal.querySelector('#verifyTokenBtn');
            const originalText = verifyBtn.textContent;
            verifyBtn.textContent = 'Verifying...';
            verifyBtn.disabled = true;
            
            // Get JWT token first, then verify supporter token
            const authResponse = await fetch('https://api.linkaura.blankburn.online/auth');
            const authData = await authResponse.json();
            
            if (!authData.token) {
              throw new Error('Failed to get JWT token');
            }
            
            // Verify supporter token with JWT authentication
            const response = await fetch('https://api.linkaura.blankburn.online/verify-supporter', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authData.token}`
              },
              body: JSON.stringify({ token: token })
            });
            
            const result = await response.json();
            
            if (result.valid) {
              // Store supporter data
              localStorage.setItem("cleanlink_supporter_token", token);
              localStorage.setItem("cleanlink_supporter_expiry", result.expiresAt.toString());
              localStorage.setItem("cleanlink_supporter_tier", result.tier);
              localStorage.setItem("cleanlink_supporter_api_calls", result.apiCalls.toString());
              localStorage.setItem("cleanlink_donor", "true");
              
              // Show success message
              alert(`ðŸŽ‰ Supporter benefits activated! You now have ${result.apiCalls} API calls per day.`);
              
              // Close modal and reload page
              document.body.removeChild(modal);
              location.reload();
            } else {
              alert(`âŒ Invalid token: ${result.reason || 'Token verification failed'}`);
              verifyBtn.textContent = originalText;
              verifyBtn.disabled = false;
            }
          } catch (error) {
            console.error('Token verification error:', error);
            alert('âŒ Failed to verify token. Please check your connection and try again.');
            const verifyBtn = modal.querySelector('#verifyTokenBtn');
            verifyBtn.textContent = 'Verify Token';
            verifyBtn.disabled = false;
          }
        });
        
        modal.querySelector('#cancelBtn').addEventListener('click', () => {
          document.body.removeChild(modal);
        });
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
      }

      function activateSupporterBenefits(tier, token = '') {
        const tierConfig = {
          coffee: { 
            apiCalls: 10, 
            months: 1, 
            name: 'Coffee Supporter',
            color: 'yellow'
          },
          supporter: { 
            apiCalls: 50, 
            months: 3, 
            name: 'Supporter',
            color: 'amber'
          },
          champion: { 
            apiCalls: 999, 
            months: 6, 
            name: 'Champion',
            color: 'purple'
          }
        };
        
        const config = tierConfig[tier];
        const expiryTime = Date.now() + (config.months * 30 * 24 * 60 * 60 * 1000);
        
        // Store supporter data
        localStorage.setItem("cleanlink_supporter_token", token || `manual_${tier}_${Date.now()}`);
        localStorage.setItem("cleanlink_supporter_expiry", expiryTime.toString());
        localStorage.setItem("cleanlink_donor", "true");
        localStorage.setItem("cleanlink_supporter_tier", tier);
        localStorage.setItem("cleanlink_supporter_api_calls", config.apiCalls.toString());
        
        // Show success message
        const message = config.apiCalls === 999 
          ? `ðŸŽ‰ Thank you! ${config.name} mode activated with unlimited API calls for ${config.months} months.`
          : `ðŸŽ‰ Thank you! ${config.name} mode activated with ${config.apiCalls} API calls/day for ${config.months} months.`;
        
        alert(message);
        location.reload();
      }
    }); // Close the main window.addEventListener("load" block
  </script>

  <script>
    // Temporarily disable service worker to fix cache issues
    if (false && 'serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(() => console.log('âœ… Service worker registered.'))
          .catch(err => console.log('âš ï¸ Service worker registration failed:', err.message));
      });
    }
    
    // Clear all caches (only if running on proper origin)
    if ('caches' in window && window.location.protocol !== 'null:') {
      caches.keys().then(cacheNames => {
        cacheNames.forEach(cacheName => {
          caches.delete(cacheName);
        });
        console.log('ðŸ—‘ï¸ All caches cleared');
      }).catch(error => {
        console.warn('âš ï¸ Could not clear caches:', error);
      });
    }
    
    // Unregister all service workers (only if running on proper origin)
    if ('serviceWorker' in navigator && window.location.protocol !== 'null:' && window.location.hostname !== '') {
      try {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister();
            console.log('ðŸ—‘ï¸ Service worker unregistered');
          });
        }).catch(error => {
          // Silently ignore service worker errors
          console.debug('Service worker unregistration skipped:', error.message);
        });
      } catch (error) {
        // Silently ignore service worker errors
        console.debug('Service worker access skipped:', error.message);
      }
    }
  </script>

  <!-- LinkAura API Integration -->
  <script>

    // LinkAura API Helper Function
    async function callLinkAuraAPI(endpoint, body = {}) {
      // Only make API calls if any API options are selected
      if (!isAnyApiOptionSelected()) {
        return { error: "No API options selected", offline: true };
      }

      try {
        // Get JWT token from Worker
        const tokenRes = await fetch("https://api.linkaura.blankburn.online/auth", {
          timeout: 3000 // 3 second timeout
        }).catch(() => null);

        if (!tokenRes || !tokenRes.ok) {
          console.warn("âš ï¸ Auth endpoint unavailable - running in offline mode");
          return { error: "Auth unavailable", offline: true };
        }

        const authData = await tokenRes.json().catch(() => ({ token: null }));
        if (!authData.token) {
          console.warn("âš ï¸ No auth token available - running in offline mode");
          return { error: "No auth token", offline: true };
        }

        // Send data to Worker route with proper error handling
        const res = await fetch(`https://api.linkaura.blankburn.online/${endpoint}`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${authData.token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body),
          timeout: 5000 // 5 second timeout
        });

        if (!res.ok) {
          console.warn(`âš ï¸ API endpoint ${endpoint} returned ${res.status} - running in offline mode`);
          return { error: `HTTP ${res.status}`, offline: true };
        }

        const result = await res.json().catch(() => ({}));
        return result;
      } catch (err) {
        console.warn("âš ï¸ LinkAura API unavailable - running in offline mode:", err.message);
        return { error: err.message, offline: true };
      }
    }

    // Global JWT token storage
    let jwtToken = sessionStorage.getItem('linkaura_jwt') || null;
    let apiConnectionStatus = 'disconnected';

    // Status indicator element
    const statusIndicator = document.createElement('div');
    statusIndicator.id = 'apiStatus';
    statusIndicator.className = 'fixed top-4 right-4 z-50 px-3 py-1 rounded-full text-xs font-medium transition-all duration-300';
    statusIndicator.style.cssText = 'background: #ef4444; color: white; opacity: 0.8; display: none;';
    statusIndicator.textContent = 'API: Disconnected âŒ';
    document.body.appendChild(statusIndicator);

    // Function to check if any API options are selected
    // Note: Language Detection and Accessibility Analysis require API for CORS bypass
    function isAnyApiOptionSelected() {
      const safetyApiCheck = document.getElementById("safetyApiCheck")?.checked || false;
      const sslApiCheck = document.getElementById("sslApiCheck")?.checked || false;
      const webSecScanCheck = document.getElementById("webSecScanCheck")?.checked || false;
      const languageDetectionCheck = document.getElementById("languageDetectionCheck")?.checked || false;
      const accessibilityAnalysisCheck = document.getElementById("accessibilityAnalysisCheck")?.checked || false;
      const cookieTrackingAnalysisCheck = document.getElementById("cookieTrackingAnalysisCheck")?.checked || false;
      const whoisCheckCheck = document.getElementById("whoisCheckCheck")?.checked || false;
      const shortenerDetectionCheck = document.getElementById("shortenerDetectionCheck")?.checked || false;
      const geographicAnalysisCheck = document.getElementById("geographicAnalysisCheck")?.checked || false;
      return safetyApiCheck || sslApiCheck || webSecScanCheck || languageDetectionCheck || accessibilityAnalysisCheck || cookieTrackingAnalysisCheck || whoisCheckCheck || shortenerDetectionCheck || geographicAnalysisCheck;
    }

    // Function to update API status visibility
    function updateApiStatusVisibility() {
      if (isAnyApiOptionSelected()) {
        statusIndicator.style.display = 'block';
      } else {
        statusIndicator.style.display = 'none';
      }
    }

    // JWT Authentication Functions
    async function getToken() {
      // Only attempt API connection if any API options are selected
      if (!isAnyApiOptionSelected()) {
        return null;
      }

      try {
        const response = await fetch('https://api.linkaura.blankburn.online/auth', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'LinkAura/1.0'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.token) {
            jwtToken = data.token;
            sessionStorage.setItem('linkaura_jwt', jwtToken);
            apiConnectionStatus = 'connected';
            updateStatusIndicator('Connected âœ…', '#10b981');
            return jwtToken;
          } else {
            throw new Error('No token in response');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Failed to get JWT token:', error);
        apiConnectionStatus = 'disconnected';
        updateStatusIndicator('Disconnected âŒ', '#ef4444');
        return null;
      }
    }

    function updateStatusIndicator(text, color) {
      statusIndicator.textContent = `API: ${text}`;
      statusIndicator.style.backgroundColor = color;
    }

    // Unified API Function
    async function callApi(endpoint, payload = {}) {
      // All endpoints go through LinkAura API (requires JWT auth)
      const baseUrl = 'https://api.linkaura.blankburn.online';

      // Ensure we have a valid token for LinkAura API
      if (!jwtToken) {
        await getToken();
      }

      if (!jwtToken) {
        throw new Error('Unable to authenticate with API');
      }

      try {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${jwtToken}`,
          'User-Agent': 'LinkAura/1.0'
        };

        const response = await fetch(`${baseUrl}/${endpoint}`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            ...payload,
            timestamp: new Date().toISOString(),
            client_version: '1.0'
          })
        });

        // Handle token expiration
        if (response.status === 401 || response.status === 403) {
          console.log('ðŸ”„ Token expired, refreshing...');
          jwtToken = null;
          sessionStorage.removeItem('linkaura_jwt');
          await getToken();
          // Retry the original request
          return callApi(endpoint, payload);
        }

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`âŒ API call failed for ${endpoint}:`, error);
        throw error;
      }
    }

    // Enhanced URL Safety Check
    async function checkUrlSafety(url) {
      const isPrivacy = document.getElementById('privacyMode')?.checked || false;

      if (isPrivacy) {
        return { verdict: 'privacy', message: 'Privacy mode active' };
      }

      try {
        showLoadingSpinner('Checking URL safety...');
        const result = await callLinkAuraAPI("url-safety", { url: url });
        hideLoadingSpinner();
        return result;
      } catch (error) {
        hideLoadingSpinner();
        console.error('âŒ URL safety check failed:', error);
        return { verdict: 'error', message: 'Unable to verify safety' };
      }
    }

    // Enhanced Web Security Scan
    async function checkWebSecurity(url) {
      const isPrivacy = document.getElementById('privacyMode')?.checked || false;

      if (isPrivacy) {
        return { verdict: 'privacy', message: 'Privacy mode active' };
      }

      try {
        showLoadingSpinner('Performing comprehensive security audit...');
        const result = await callLinkAuraAPI("websecscan", { url: url });
        hideLoadingSpinner();
        return result;
      } catch (error) {
        hideLoadingSpinner();
        console.error('âŒ Web security scan failed:', error);
        return { verdict: 'error', message: 'Unable to perform security scan' };
      }
    }

    // Analytics and Counter Functions
    async function sendAnalytics(data) {
      const isPrivacy = document.getElementById('privacyMode')?.checked || false;

      if (isPrivacy) {
        return;
      }

      try {
        await callLinkAuraAPI("analytics", data);
      } catch (error) {
        console.error('âŒ Analytics failed:', error);
      }
    }

    async function updateGlobalCounter() {
      const isPrivacy = document.getElementById('privacyMode')?.checked || false;

      if (isPrivacy) {
        return;
      }

      try {
        const result = await callLinkAuraAPI("GlobalCounter");
        if (result.count !== undefined) {
          const counterEl = document.getElementById('globalCounter');
          if (counterEl) {
            counterEl.textContent = `${result.count.toLocaleString()} URLs cleaned so far ðŸš€`;
            counterEl.style.transform = 'scale(1.15)';
            setTimeout(() => (counterEl.style.transform = 'scale(1)'), 300);
          }
        }
      } catch (error) {
        console.error('âŒ Counter update failed:', error);
      }
    }

    // UI Feedback Functions
    function showLoadingSpinner(message = 'Processing...') {
      let spinner = document.getElementById('linkauraSpinner');
      if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'linkauraSpinner';
        spinner.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        spinner.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-lg p-6 flex items-center gap-3 shadow-xl">
            <div class="animate-spin rounded-full h-6 w-6 border-2 border-primary border-t-transparent"></div>
            <span class="text-slate-900 dark:text-white font-medium">${message}</span>
          </div>
        `;
        document.body.appendChild(spinner);
      } else {
        spinner.querySelector('span').textContent = message;
        spinner.classList.remove('hidden');
      }
    }

    function hideLoadingSpinner() {
      const spinner = document.getElementById('linkauraSpinner');
      if (spinner) {
        spinner.classList.add('hidden');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 px-4 py-2 rounded-lg text-sm font-medium z-50 transition-all duration-300 ${
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'success' ? 'bg-green-500 text-white' :
        'bg-blue-500 text-white'
      }`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Enhanced Clean Button Functionality
    async function handleCleanClick() {
      // Note: Basic URL cleaning and security checks are unlimited
      // Premium features (Safety API, SSL Certificate API, WebSecScan) share the same usage counter
      // Usage: 5/day (free) â†’ 10/day (coffee) â†’ 50/day (supporter) â†’ Unlimited (champion)

      const urlInput = document.getElementById('urlInput');
      const rawUrl = urlInput?.value.trim();

      if (!rawUrl) {
        showNotification('Please paste a URL first', 'error');
        return;
      }

      hideError();
      const preserve = getSelectedParameters();

      try {
        // Clean the URL first (core functionality)
        const cleaned = cleanURL(rawUrl, preserve);
        if(resultUrl) resultUrl.textContent = cleaned;
        if(resultWrap) resultWrap.classList.remove("hidden");
        if(qrWrap) qrWrap.classList.remove("hidden");
        renderQR(cleaned);

        // Hide previous status elements
        const httpsStatusEl = document.getElementById("httpsStatus");
        if (httpsStatusEl) httpsStatusEl.classList.add("hidden");

        const domainAgeStatusEl = document.getElementById("domainAgeStatus");
        if (domainAgeStatusEl) domainAgeStatusEl.classList.add("hidden");

        const malwareStatusEl = document.getElementById("malwareStatus");
        if (malwareStatusEl) malwareStatusEl.classList.add("hidden");

        const safetyApiStatusEl = document.getElementById("safetyApiStatus");
        if (safetyApiStatusEl) safetyApiStatusEl.classList.add("hidden");

        const shortenerApiStatusEl = document.getElementById("shortenerApiStatus");
        if (shortenerApiStatusEl) shortenerApiStatusEl.classList.add("hidden");

        // Note: Geographic status elements are managed by checkGeographicAnalysis function

        // Check which options are enabled
        const isPrivacy = privacyToggle.checked;
        const shouldCheckHTTPS = document.getElementById("httpsCheck").checked;
        const shouldCheckSSL = document.getElementById("sslCheck").checked;
        const shouldCheckSafetyAPI = document.getElementById("safetyApiCheck").checked;
        const shouldCheckWebSecScan = document.getElementById("webSecScanCheck").checked;

        // Run all the security checks
        if (shouldCheckHTTPS && !isPrivacy) {
          checkHTTPS(cleaned);
        }

        if (shouldCheckSSL && !isPrivacy) {
          try {
            checkSslCertificate(cleaned);
          } catch {
            // Skip SSL check for invalid URLs
          }
        }


        // Check URL safety with new API first
        if (shouldCheckSafetyAPI && !isPrivacy) {
          const safetyResult = await checkUrlSafety(cleaned);
          updateSafetyStatus(safetyResult);

          // Send analytics via new API (if not in privacy mode)
          await sendAnalytics({
            action: 'url_clean',
            url: cleaned,
            safety_verdict: safetyResult.verdict,
            timestamp: new Date().toISOString()
          });
        } else if (!isPrivacy) {
          // Send analytics via old API if Safety API not enabled
          await sendAnalytics({
            action: 'url_clean',
            url: cleaned,
            safety_verdict: 'not_checked',
            timestamp: new Date().toISOString()
          });
        }

        // Handle WebSecScan option
        if (shouldCheckWebSecScan && !isPrivacy) {
          checkWebSecScan(cleaned);
        }

        // Handle Geographic Analysis option
        const shouldCheckGeographicAnalysis2 = document.getElementById("geographicAnalysisCheck").checked;
        if (shouldCheckGeographicAnalysis2 && !isPrivacy) {
          checkGeographicAnalysis(cleaned);
        }

        // Handle Cookie & Tracking Analysis
        const shouldCheckCookieTrackingAnalysis2 = document.getElementById("cookieTrackingAnalysisCheck")?.checked ?? false;
        if (shouldCheckCookieTrackingAnalysis2 && !isPrivacy) {
          checkCookieTrackingAnalysis(cleaned);
        }

        // Handle WHOIS Check
        const shouldCheckWhoisCheck2 = document.getElementById("whoisCheckCheck")?.checked ?? false;
        if (shouldCheckWhoisCheck2 && !isPrivacy) {
          checkWhoisCheck(cleaned);
        }

        // Check for shortened URLs if enabled
        const shouldCheckShortener = document.getElementById("shortenerDetectionCheck").checked;
        if (shouldCheckShortener) {
          checkShortenedUrl(cleaned);
        }

        // Update global counter via new API (if not in privacy mode)
        if (!isPrivacy) {
          await updateGlobalCounter();
        }

        showNotification('âœ… URL cleaned successfully!', 'success');

      } catch (error) {
        console.error('âŒ Clean operation failed:', error);
        showNotification('Connection issue â€” some features may not work', 'error');

        // Fallback: still clean the URL even if API fails
        try {
          const cleaned = cleanURL(rawUrl, preserve);
          if(resultUrl) resultUrl.textContent = cleaned;
          if(resultWrap) resultWrap.classList.remove("hidden");
          if(qrWrap) qrWrap.classList.remove("hidden");
          renderQR(cleaned);
          
          // Check for shortened URLs even in fallback mode if enabled
          const shouldCheckShortener = document.getElementById("shortenerDetectionCheck").checked;
          if (shouldCheckShortener) {
            checkShortenedUrl(cleaned);
          }
        } catch (fallbackError) {
          showError("Invalid URL.");
        }
      }
    }

    function updateSafetyStatus(result) {
      const safetyStatusEl = document.getElementById('safetyApiStatus');
      const safetyIconEl = document.getElementById('safetyApiIcon');
      const safetyTextEl = document.getElementById('safetyApiText');

      if (!safetyStatusEl) return;

      safetyStatusEl.classList.remove('hidden');

      switch (result.verdict?.toLowerCase()) {
        case 'safe':
        case 'clean':
        case 'verified':
          safetyIconEl.textContent = 'verified_user';
          safetyIconEl.className = 'material-symbols-outlined text-base text-green-500 dark:text-green-400';
          safetyTextEl.textContent = 'Verified safe by LinkAura API';
          break;

        case 'suspicious':
        case 'warning':
          safetyIconEl.textContent = 'warning';
          safetyIconEl.className = 'material-symbols-outlined text-base text-orange-500 dark:text-orange-400';
          safetyTextEl.textContent = 'Suspicious - exercise caution';
          break;

        case 'malicious':
        case 'dangerous':
        case 'reported':
          safetyIconEl.textContent = 'dangerous';
          safetyIconEl.className = 'material-symbols-outlined text-base text-red-500 dark:text-red-400';
          safetyTextEl.textContent = 'Malicious site detected';
          showNotification('âš ï¸ Warning: This URL may be unsafe!', 'error');
          break;

        case 'privacy':
          safetyIconEl.textContent = 'privacy_tip';
          safetyIconEl.className = 'material-symbols-outlined text-base text-blue-500 dark:text-blue-400';
          safetyTextEl.textContent = 'Privacy mode active';
          break;

        default:
          safetyIconEl.textContent = 'help';
          safetyIconEl.className = 'material-symbols-outlined text-base text-slate-500 dark:text-slate-400';
          safetyTextEl.textContent = 'Safety status unknown';
      }
    }

    // Initialize API connection on page load (only if API options are selected)
    document.addEventListener('DOMContentLoaded', async () => {
      if (isAnyApiOptionSelected()) {
      // Try to get initial token
      await getToken();
      } else {
      }

      // Note: Clean button handler is already set up earlier in the code
      // Do not override it here to avoid conflicts

      // Override bulk clean button if it exists
      const bulkCleanBtn = document.getElementById('bulkCleanBtn');
      if (bulkCleanBtn) {
        bulkCleanBtn.addEventListener('click', async () => {
          const bulkInput = document.getElementById('bulkInput');
          const rawUrls = bulkInput?.value.split('\n').map(u => u.trim()).filter(u => u.length > 0) || [];

          if (!rawUrls.length) {
            showNotification('Please paste URLs to clean (one per line)', 'error');
            return;
          }

          try {
            showLoadingSpinner('Processing URLs...');

            for (const url of rawUrls) {
              const safetyResult = await checkUrlSafety(url);
              updateSafetyStatus(safetyResult);

              await sendAnalytics({
                action: 'bulk_clean',
                url: url,
                safety_verdict: safetyResult.verdict,
                timestamp: new Date().toISOString()
              });
            }

            await updateGlobalCounter();
            hideLoadingSpinner();

            showNotification(`âœ… Processed ${rawUrls.length} URLs successfully`, 'success');
          } catch (error) {
            hideLoadingSpinner();
            console.error('âŒ Bulk clean failed:', error);
            showNotification('Connection issue â€” some URLs may not have been processed', 'error');
          }
        });
      }

      // Check connection status every 5 minutes (only if API options are selected)
      setInterval(async () => {
        if (isAnyApiOptionSelected() && !jwtToken) {
          await getToken();
        }
      }, 5 * 60 * 1000);

      if (isAnyApiOptionSelected()) {
      }

      // Initialize history display
      setTimeout(() => {
        if (typeof window.updateHistoryDisplay === 'function') {
          window.updateHistoryDisplay();
        }
        if (typeof populateDomainFilter === 'function') {
          populateDomainFilter();
        }
        if (typeof window.updateHistoryButtonVisibility === 'function') {
          window.updateHistoryButtonVisibility();
        }
      }, 100);

      // Also check immediately when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          if (typeof window.updateHistoryButtonVisibility === 'function') {
            window.updateHistoryButtonVisibility();
          }
          if (typeof setupHistoryToggle === 'function') {
            setupHistoryToggle();
          }
        });
      } else {
        // DOM is already ready
        if (typeof window.updateHistoryButtonVisibility === 'function') {
          window.updateHistoryButtonVisibility();
        }
      }
    });

    // Handle page visibility changes (refresh token when user returns)
    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden && isAnyApiOptionSelected() && (!jwtToken || apiConnectionStatus === 'disconnected')) {
        await getToken();
      }
    });

    // Also check history button visibility when window loads
    window.addEventListener('load', () => {
      if (typeof window.updateHistoryButtonVisibility === 'function') {
        window.updateHistoryButtonVisibility();
      }
      if (typeof setupHistoryToggle === 'function') {
        setupHistoryToggle();
      }
    });
  </script>

</body>
</html>
